<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>阅读控制器</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ease-out-quint: cubic-bezier(0.22, 1, 0.36, 1);
            --ease-in-out-cubic: cubic-bezier(0.65, 0, 0.35, 1);

            --bg-color: #121212;
            --card-color: #1e1e1e;
            --primary-text-color: #e1e1e1;
            --secondary-text-color: #8b8b8b;
            --accent-color: #00bcd4;
            --accent-glow: rgba(0, 188, 212, 0.3);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --success-color: #4CAF50;
            --error-color: #F44336;
            --warn-color: #e53935;
            --warn-confirm-color: #ff9800;
        }

        html[data-theme='light'] {
            --bg-color: #f0f2f5;
            --card-color: #ffffff;
            --primary-text-color: #1f2937;
            --secondary-text-color: #6b7280;
            --accent-color: #0097a7;
            --accent-glow: rgba(0, 151, 167, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-family: 'Noto Sans SC', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        body {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 100vh; background-color: var(--bg-color); color: var(--primary-text-color);
            transition: background-color 0.4s, color 0.4s; -webkit-tap-highlight-color: transparent;
            padding: 20px 0;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animated { animation: fadeInUp 0.8s var(--ease-out-quint) both; }

        .theme-toggle-container { position: fixed; top: 15px; right: 15px; z-index: 100; }
        .theme-toggle {
            cursor: pointer; width: 48px; height: 48px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; background-color: var(--card-color);
            box-shadow: 0 4px 12px var(--shadow-color); transition: all 0.3s ease;
        }
        .theme-toggle:active { transform: scale(0.9); }
        .theme-toggle input { display: none; }
        .theme-toggle .icon { color: var(--primary-text-color); transition: all 0.5s cubic-bezier(.18,.89,.32,1.28); }
        .theme-toggle .sun { transform: scale(1) rotate(0deg); }
        html[data-theme='dark'] .theme-toggle .sun { transform: scale(0) rotate(-90deg); }
        .theme-toggle .moon { position: absolute; transform: scale(0) rotate(90deg); }
        html[data-theme='dark'] .theme-toggle .moon { transform: scale(1) rotate(0deg); }

        main { width: 100%; max-width: 800px; padding: 20px; text-align: center; }
        main[data-mode="kobo"] .koreader-only { display: none !important; }
        main[data-mode="koreader"] .kobo-only { display: none !important; }
        
        h1 { font-weight: 700; font-size: 2.25rem; }
        
        .title-container {
            display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 8px;
        }
        .lock-theme-btn {
            background: none; border: none; cursor: pointer; color: var(--secondary-text-color);
            padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
        }
        .lock-theme-btn.locked, .lock-theme-btn:hover { color: var(--accent-color); }
        .lock-theme-btn .svg-icon { width: 24px; height: 24px; }
        
        #theme-info { margin-bottom: 20px; animation-delay: 0.15s; }
        #theme-info .name { font-size: 1.1rem; font-weight: 500; color: var(--primary-text-color); margin-bottom: 4px; }
        #theme-info .description { font-size: 0.8rem; color: var(--secondary-text-color); }
        
        .mode-switcher {
            display: inline-flex; position: relative; background-color: color-mix(in srgb, var(--card-color) 50%, var(--bg-color));
            border-radius: 12px; padding: 4px; margin-bottom: 24px; animation-delay: 0.2s;
        }
        .mode-switcher .glider {
            position: absolute; top: 4px; height: calc(100% - 8px); width: 100px;
            background-color: var(--card-color); border-radius: 9px;
            box-shadow: 0 2px 8px -2px var(--shadow-color);
            transition: transform 0.4s var(--ease-in-out-cubic);
        }
        .mode-switcher button {
            background: none; border: none; color: var(--secondary-text-color); font-size: 0.9rem; font-weight: 500;
            padding: 10px 20px; width: 100px; cursor: pointer; position: relative; z-index: 1;
            transition: color 0.4s var(--ease-in-out-cubic);
        }
        .mode-switcher button.active { color: var(--primary-text-color); }

        .ip-form { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 35px; animation-delay: 0.3s; }
        .ip-input {
            background-color: var(--card-color); border: 1px solid color-mix(in srgb, var(--secondary-text-color) 40%, transparent);
            border-radius: 12px; padding: 14px 18px; color: var(--primary-text-color); font-size: 1rem; width: 220px;
            transition: all 0.3s var(--ease-in-out-cubic);
        }
        .ip-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 4px var(--accent-glow); }
        .save-btn {
            background-image: linear-gradient(135deg, var(--accent-color) 0%, color-mix(in srgb, var(--accent-color) 80%, black) 100%);
            border: none; border-radius: 12px; padding: 14px 22px; color: #fff; font-size: 1rem; font-weight: 500; cursor: pointer;
            transition: all 0.3s var(--ease-in-out-cubic); box-shadow: 0 4px 15px -5px color-mix(in srgb, var(--accent-color) 60%, transparent);
        }
        .save-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px -5px var(--accent-color); }
        .save-btn:active { transform: translateY(0) scale(0.95); }

        .controls { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-bottom: 35px; animation-delay: 0.4s; }
        .control-card {
            width: 260px; height: 190px; background-color: var(--card-color); border-radius: 24px;
            display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; user-select: none;
            box-shadow: 0 10px 30px -10px var(--shadow-color); position: relative; overflow: hidden;
            transition: all 0.4s var(--ease-out-quint);
        }
        
        main:not([data-click-effect="ripple"]) .control-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(circle at 50% -20%, var(--accent-glow), transparent 70%);
            opacity: 0; transition: opacity 0.5s var(--ease-out-quint);
        }
        main:not([data-click-effect="ripple"]) .control-card:hover::before { opacity: 1; }
        
        .control-card .ripple {
            position: absolute; background: var(--accent-glow); border-radius: 50%;
            transform: scale(0); animation: ripple-effect 0.6s linear; pointer-events: none;
        }
        @keyframes ripple-effect { to { transform: scale(4); opacity: 0; } }

        .control-card:hover { transform: translateY(-12px); box-shadow: 0 20px 40px -15px var(--shadow-color); }
        .control-card:active { transform: translateY(-4px) scale(0.97); transition-duration: 0.1s; }
        .card-icon { color: var(--accent-color); z-index: 1;}
        .card-text { font-size: 1.5rem; font-weight: 400; margin-top: 15px; z-index: 1;}
        
        .divider { width: 80%; max-width: 400px; height: 1px; background-color: color-mix(in srgb, var(--secondary-text-color) 40%, transparent); margin: 0 auto 30px; animation-delay: 0.5s; }

        .function-area {
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 12px; animation-delay: 0.6s;
            transition: opacity 0.4s, transform 0.4s;
        }
        .function-btn, .function-toggle, .function-slider-container {
            display: flex; align-items: center; gap: 8px; background-color: transparent;
            border: 1px solid color-mix(in srgb, var(--secondary-text-color) 50%, transparent);
            color: var(--secondary-text-color); border-radius: 12px; padding: 10px 18px; font-size: 0.875rem;
            cursor: pointer; transition: all 0.3s var(--ease-in-out-cubic);
        }
        .function-btn:hover, .function-toggle:hover { color: var(--accent-color); border-color: var(--accent-color); background-color: var(--accent-glow); transform: translateY(-2px); }
        .function-btn:active, .function-toggle:active { transform: scale(0.95) translateY(0); }
        
        .function-toggle.active {
             color: var(--accent-color); border-color: var(--accent-color); background-color: var(--accent-glow);
        }

        .function-slider-container { cursor: default; }
        .function-slider-container input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100px; background: transparent; cursor: pointer;
        }
        .function-slider-container input[type="range"]::-webkit-slider-runnable-track {
            height: 4px; background: var(--secondary-text-color); border-radius: 2px;
        }
        .function-slider-container input[type="range"]::-moz-range-track {
            height: 4px; background: var(--secondary-text-color); border-radius: 2px;
        }
        .function-slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; margin-top: -6px;
            width: 16px; height: 16px; background: var(--accent-color); border-radius: 50%;
            border: 2px solid var(--card-color);
        }
         .function-slider-container input[type="range"]::-moz-range-thumb {
            width: 16px; height: 16px; background: var(--accent-color); border-radius: 50%;
            border: 2px solid var(--card-color);
        }

        .function-btn.warn-btn { border-color: color-mix(in srgb, var(--warn-color) 50%, transparent); color: var(--warn-color); }
        .function-btn.warn-btn:hover { border-color: var(--warn-color); background-color: color-mix(in srgb, var(--warn-color) 15%, transparent); }
        
        .function-btn.confirm-state {
            border-color: var(--warn-confirm-color) !important; color: var(--warn-confirm-color) !important;
            background-color: color-mix(in srgb, var(--warn-confirm-color) 15%, transparent) !important;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.03);} 100% {transform: scale(1);} }
        
        .svg-icon { width: 1.2em; height: 1.2em; vertical-align: middle; }

        .status-message {
            position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 150%); padding: 12px 25px;
            border-radius: 12px; font-size: 1rem; font-weight: 500; color: #fff; opacity: 0; visibility: hidden;
            transition: all 0.5s var(--ease-in-out-cubic); z-index: 2000;
        }
        .status-message.show { opacity: 1; visibility: visible; transform: translate(-50%, 0); }
        .status-message.success { background-color: var(--success-color); }
        .status-message.error { background-color: var(--error-color); }
        
        footer { margin-top: 20px; padding: 10px; font-size: 0.75rem; color: var(--secondary-text-color); text-align: center; animation-delay: 0.7s; }

        /* Settings Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 1500; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--card-color); margin: auto; padding: 25px;
            border: 1px solid color-mix(in srgb, var(--secondary-text-color) 40%, transparent);
            width: 90%; max-width: 600px; border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4); animation: fadeInUp 0.5s var(--ease-out-quint);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; }
        .modal-header h2 { color: var(--primary-text-color); }
        .modal-close {
            color: var(--secondary-text-color); float: right; font-size: 28px; font-weight: bold;
            cursor: pointer; transition: color 0.3s;
        }
        .modal-close:hover, .modal-close:focus { color: var(--accent-color); text-decoration: none; }
        
        .modal-body { padding: 15px 0; }
        .settings-section { margin-bottom: 25px; }
        .settings-section h3 {
            color: var(--primary-text-color); font-size: 1.1rem; border-bottom: 1px solid var(--secondary-text-color);
            padding-bottom: 8px; margin-bottom: 15px;
        }
        .settings-section label { display: block; color: var(--secondary-text-color); margin-bottom: 8px; font-size: 0.9rem;}
        .settings-section input[type="number"] {
            width: 120px; background-color: var(--bg-color); border: 1px solid var(--secondary-text-color);
            border-radius: 8px; padding: 8px 12px; color: var(--primary-text-color); font-size: 1rem;
        }

        .actions-container { display: flex; gap: 20px; }
        .actions-list {
            flex: 1; min-height: 200px; background-color: var(--bg-color);
            border-radius: 12px; padding: 10px; border: 1px dashed var(--secondary-text-color);
        }
        .actions-list h4 { color: var(--secondary-text-color); margin-bottom: 10px; font-weight: 500; }
        .action-item {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            background-color: var(--card-color); border-radius: 8px; margin-bottom: 8px;
            cursor: grab; transition: background-color 0.3s;
            user-select: none;
        }
        .action-item:active { cursor: grabbing; }
        .action-item .svg-icon { color: var(--accent-color); }
        .action-item.dragging { opacity: 0.5; background-color: var(--accent-glow); }

        .modal-footer { text-align: right; padding-top: 20px; }
        .modal-btn {
            border: none; border-radius: 10px; padding: 12px 25px; font-size: 0.9rem; font-weight: 500;
            cursor: pointer; transition: all 0.3s;
        }
        .save-modal-btn {
            background-color: var(--accent-color); color: white; margin-left: 10px;
        }
        .save-modal-btn:hover { filter: brightness(1.1); }
        .cancel-modal-btn { background-color: var(--secondary-text-color); color: white; }
        .cancel-modal-btn:hover { filter: brightness(1.1); }
    </style>
</head>
<body>
    <div class="theme-toggle-container">
        <label class="theme-toggle" for="themeToggleCheckbox" aria-label="切换主题">
            <input type="checkbox" id="themeToggleCheckbox">
            <svg class="svg-icon sun icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            <svg class="svg-icon moon icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </label>
    </div>

    <main id="mainContent" data-mode="koreader">
        <div class="title-container animated">
             <h1 class="animated">阅读控制器</h1>
             <button id="lockThemeBtn" class="lock-theme-btn animated" aria-label="锁定/解锁主题色">
                <svg id="lockIcon" class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                <svg id="unlockIcon" class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>
             </button>
        </div>
        
        <div id="theme-info" class="animated">
            <h3 class="name"></h3>
            <p class="description"></p>
        </div>
        
        <div class="mode-switcher animated">
            <div class="glider"></div>
            <button id="modeBtnKoreader" class="active">KOReader</button>
            <button id="modeBtnKobo">Kobo</button>
        </div>

        <form id="ipForm" class="ip-form animated" onsubmit="event.preventDefault();">
            <input type="text" id="ipInput" class="ip-input" placeholder="输入设备IP地址" autocomplete="off">
            <button type="submit" id="saveBtn" class="save-btn">保存</button>
        </form>

        <div class="controls animated">
            <div class="control-card" data-action="prev" data-success-msg="‹ 上一页">
                <div class="card-icon"><svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></div>
                <div class="card-text">上一页</div>
            </div>
            <div class="control-card" data-action="next" data-success-msg="下一页 ›">
                <div class="card-icon"><svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                <div class="card-text">下一页</div>
            </div>
        </div>
        
        <div class="divider animated"></div>

        <div id="functionArea" class="function-area animated koreader-only">
             <!-- Dynamically generated buttons will go here -->
        </div>

        <div class="function-area animated">
             <button id="effectToggleBtn" class="function-btn"><svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2z"></path><path d="M12 17a3 3 0 1 0-3-3"></path></svg><span class="btn-text">切换点击效果</span></button>
             <button id="koboExitBtn" class="function-btn kobo-only warn-btn" data-action="/exit" data-success-msg="已发送关闭服务器命令"><svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 3H6a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h4M16 17l5-5-5-5M19.8 12H9"></path></svg><span class="btn-text">关闭服务器</span></button>
        </div>
    </main>
    <footer id="footer" class="animated"></footer>
    <div id="statusMessage" class="status-message"></div>

    <!-- Settings Modal HTML -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>控制器设置</h2>
                <span id="modalCloseBtn" class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>KOReader 设置</h3>
                    <label for="koreaderPortInput">服务器端口 (默认: 8080)</label>
                    <input id="koreaderPortInput" type="number" min="1024" max="65535" placeholder="8080">
                </div>
                <div class="settings-section">
                    <h3>功能栏自定义 (最多6项, 可拖动排序)</h3>
                    <div class="actions-container">
                        <div id="visibleActionsList" class="actions-list">
                            <h4>已启用功能</h4>
                        </div>
                        <div id="availableActionsList" class="actions-list">
                            <h4>可用功能</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelModalBtn" class="modal-btn cancel-modal-btn">取消</button>
                <button id="saveModalBtn" class="modal-btn save-modal-btn">保存并应用</button>
            </div>
        </div>
    </div>


    <script>
       const traditionalColors = [{"name":"春日樱花","description":"灵感来自春天盛开的樱花，温柔而浪漫","colors":[{"name":"粉红","hex":"#FFB3B3"},{"name":"素白","hex":"#FFFFFF"},{"name":"青竹","hex":"#95B89C"},{"name":"浅紫","hex":"#E6D4E8"}],"category":"四季"},{"name":"江南水乡","description":"传统水墨画中的江南意境","colors":[{"name":"墨黑","hex":"#2C3135"},{"name":"青瓦","hex":"#5D7B8B"},{"name":"粉墙","hex":"#F5F0E6"},{"name":"苔绿","hex":"#8B9E77"}],"category":"山水"},{"name":"元宵佳节","description":"元宵节的喜庆与温馨","colors":[{"name":"灯笼红","hex":"#FF4D4D"},{"name":"金黄","hex":"#FFD700"},{"name":"紫色","hex":"#9B4F96"},{"name":"月白","hex":"#F2ECDE"}],"category":"节日"},{"name":"竹林清韵","description":"竹林深处的宁静与清雅","colors":[{"name":"竹青","hex":"#789262"},{"name":"竹白","hex":"#F0F5E5"},{"name":"墨绿","hex":"#2C4A3E"},{"name":"茶褐","hex":"#6B4423"}],"category":"山水"},{"name":"秋日金黄","description":"秋天的金黄与温暖","colors":[{"name":"秋叶金","hex":"#DAA520"},{"name":"枫红","hex":"#8B2323"},{"name":"橙褐","hex":"#CD853F"},{"name":"暖棕","hex":"#8B4513"}],"category":"四季"},{"name":"中秋月夜","description":"中秋佳节的皓月清辉","colors":[{"name":"月白","hex":"#E9E7EF"},{"name":"深蓝","hex":"#1C2841"},{"name":"桂花黄","hex":"#FFC773"},{"name":"青灰","hex":"#7D8B99"}],"category":"节日"},{"name":"碧海青天","description":"碧蓝的大海与晴朗的天空","colors":[{"name":"海蓝","hex":"#1E90FF"},{"name":"天青","hex":"#87CEFA"},{"name":"沙黄","hex":"#F4A460"},{"name":"白浪","hex":"#FFFFFF"}],"category":"山水"},{"name":"莲池清影","description":"莲花盛开的池塘，清新怡人","colors":[{"name":"莲红","hex":"#FF69B4"},{"name":"池蓝","hex":"#00BFFF"},{"name":"荷绿","hex":"#32CD32"},{"name":"泥褐","hex":"#8B4513"}],"category":"花卉"},{"name":"紫禁宫韵","description":"紫禁城的皇家色彩与庄严","colors":[{"name":"紫禁红","hex":"#8B0000"},{"name":"宫廷金","hex":"#FFD700"},{"name":"玉蓝","hex":"#4169E1"},{"name":"御灰","hex":"#696969"}],"category":"建筑"},{"name":"青花瓷韵","description":"青花瓷的经典蓝白配色","colors":[{"name":"青花蓝","hex":"#0000CD"},{"name":"瓷白","hex":"#F0F8FF"},{"name":"墨黑","hex":"#000000"},{"name":"釉灰","hex":"#708090"}],"category":"艺术"},{"name":"红楼梦境","description":"《红楼梦》中的古典色彩","colors":[{"name":"黛青","hex":"#5D8AA8"},{"name":"绛紫","hex":"#8B008B"},{"name":"烟白","hex":"#F5F5F5"},{"name":"琥珀黄","hex":"#FFBF00"}],"category":"文化"}, {"name": "水墨丹青", "description": "水墨画中的淡雅色彩", "colors": [{ "name": "墨黑", "hex": "#2F3542" }, { "name": "丹朱", "hex": "#FF4500" }, { "name": "云灰", "hex": "#B0C4DE" }, { "name": "雪白", "hex": "#FFFFFF" }], "category": "艺术" }];
        const KOREADER_ACTIONS = {
            'frontlight_intensity': { id: 'frontlight_intensity', name: '亮度', type: 'slider', event: '/koreader/event/SetFlIntensity/', msg: '亮度已调节', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>` },
            'frontlight_warmth': { id: 'frontlight_warmth', name: '色温', type: 'slider', event: '/koreader/event/SetFlWarmth/', msg: '色温已调节', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 16.5A4.5 4.5 0 1012 7.5a4.5 4.5 0 000 9z"/><path d="M12 3v2M21 12h-2M4 12H2M12 21v-2M19.07 4.93l-1.42 1.42M4.93 19.07l1.42-1.42M19.07 19.07l-1.42-1.42M4.93 4.93l1.42 1.42"/></svg>` },
            'night_mode': { id: 'night_mode', name: '夜间', type: 'toggle', event: '/koreader/event/ToggleNightMode', msg: '已切换夜间模式', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>` },
            'toc': { id: 'toc', name: '目录', type: 'button', event: '/koreader/event/ShowToc', msg: '已发送目录请求', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>` },
            'refresh': { id: 'refresh', name: '刷新', type: 'button', event: '/koreader/event/FullRefresh', msg: '已发送刷新命令', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>` },
            'file_manager': { id: 'file_manager', name: '文件', type: 'button', event: '/koreader/event/Home', msg: '已请求文件管理器', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>` },
            'open_last_doc': { id: 'open_last_doc', name: '最近', type: 'button', event: '/koreader/event/OpenLastDoc', msg: '已请求打开最近文档', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path><path d="M12 2v20"></path></svg>`},
            'close_doc': { id: 'close_doc', name: '关闭', type: 'button', event: '/koreader/event/Close', msg: '已发送关闭请求', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>` },
            'toggle_filebrowser': { id: 'toggle_filebrowser', name: '切换文件', type: 'button', event: '/koreader/event/ToggleFilebrowser', msg: '已切换文件浏览器', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>` },
            'usb_mode': { id: 'usb_mode', name: 'USB', type: 'button', event: '/koreader/event/RequestUSBMS', msg: '已请求USB模式', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M8 9l4-4 4 4"/><path d="M12 12v0a3 3 0 000 0v0a3 3 0 000 0v0a3 3 0 000 0v0a3 3 0 000 0V5h-1a2 2 0 00-2 2v2M12 5h1a2 2 0 012 2v2M12 19v-3M10 16h4M12 12h0"/></svg>` },
            'suspend': { id: 'suspend', name: '睡眠', type: 'button', event: '/koreader/event/RequestSuspend', msg: '已请求睡眠', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2.5a2.5 2.5 0 00-3 0V5h3V2.5z"/><path d="M6.1 7.2a2.5 2.5 0 00-1.2 4.4l3.5 2-3.5 2a2.5 2.5 0 102.3 4.1l3.5-2 3.5 2a2.5 2.5 0 002.3-4.1l-3.5-2 3.5-2a2.5 2.5 0 00-1.2-4.4L12 9.8 6.1 7.2z"/></svg>` },
            'page_browser': { id: 'page_browser', name: '速览', type: 'button', event: '/koreader/event/ShowPageBrowser', msg: '已请求书页速览', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>` },
            'bookmarks': { id: 'bookmarks', name: '书签', type: 'button', event: '/koreader/event/ShowBookmark', msg: '已请求书签列表', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>` },
            'toggle_bookmark': { id: 'toggle_bookmark', name: '加/取书签', type: 'button', event: '/koreader/event/ToggleBookmark', msg: '已切换书签', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="10" y1="11" x2="14" y2="11"></line></svg>` }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // === DOM Elements ===
            const mainContent = document.getElementById('mainContent');
            const ipInput = document.getElementById('ipInput');
            const statusMessage = document.getElementById('statusMessage');
            const themeToggleCheckbox = document.getElementById('themeToggleCheckbox');
            const modeBtnKoreader = document.getElementById('modeBtnKoreader');
            const modeBtnKobo = document.getElementById('modeBtnKobo');
            const glider = document.querySelector('.mode-switcher .glider');
            const footer = document.getElementById('footer');
            const koboExitBtn = document.getElementById('koboExitBtn');
            const lockThemeBtn = document.getElementById('lockThemeBtn');
            const lockIcon = document.getElementById('lockIcon');
            const unlockIcon = document.getElementById('unlockIcon');
            const themeInfoName = document.querySelector('#theme-info .name');
            const themeInfoDesc = document.querySelector('#theme-info .description');
            const effectToggleBtn = document.getElementById('effectToggleBtn');
            const functionArea = document.getElementById('functionArea');

            // Settings Modal Elements
            const settingsModal = document.getElementById('settingsModal');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            const cancelModalBtn = document.getElementById('cancelModalBtn');
            const saveModalBtn = document.getElementById('saveModalBtn');
            const koreaderPortInput = document.getElementById('koreaderPortInput');
            const visibleActionsList = document.getElementById('visibleActionsList');
            const availableActionsList = document.getElementById('availableActionsList');


            // === App State ===
            let currentIp = '';
            let currentMode = 'koreader';
            let koreaderPort = 8080;
            let statusTimeout;
            let koboExitConfirm = false;
            let koboExitTimeout;
            let themeColorLocked = false;
            let currentThemeIndex = 0;
            let currentClickEffect = 'glow';
            let userFunctionLayout = ['frontlight_intensity', 'frontlight_warmth', 'night_mode', 'toc', 'refresh'];
            let draggedItem = null;


            // === Functions ===

            const showStatus = (message, type, duration = 2500) => {
                clearTimeout(statusTimeout);
                statusMessage.textContent = message;
                statusMessage.className = `status-message ${type} show`;
                statusTimeout = setTimeout(() => { statusMessage.classList.remove('show'); }, duration);
            };
            
            const debounce = (func, delay) => {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            };

            const sendRequest = async (endpoint, successMsg, value) => {
                if (!currentIp) { showStatus('请先输入并保存IP地址！', 'error'); ipInput.focus(); return; }
                
                let fullEndpoint = endpoint;
                if(value !== undefined) fullEndpoint += value;
                
                let port = (currentMode === 'koreader') ? `:${koreaderPort}` : ':80';

                // Handle basic page turns
                if (endpoint === 'prev') {
                    fullEndpoint = currentMode === 'koreader' ? `/koreader/event/GotoViewRel/-1` : '/left';
                } else if (endpoint === 'next') {
                    fullEndpoint = currentMode === 'koreader' ? `/koreader/event/GotoViewRel/1` : '/right';
                }
                
                try {
                    await fetch(`http://${currentIp}${port}${fullEndpoint}`, { mode: 'no-cors' });
                    if (successMsg) showStatus(successMsg, 'success');
                } catch (error) {
                    console.error('Request failed:', error);
                    showStatus('请求失败！请检查IP、网络及设备服务。', 'error');
                }
            };
            
            const saveIp = () => {
                const ip = ipInput.value.trim();
                if (/^(\d{1,3}\.){3}\d{1,3}$/.test(ip)) {
                    currentIp = ip; localStorage.setItem('reader_controller_ip', ip);
                    showStatus(`IP地址已保存: ${currentIp}`, 'success');
                } else { showStatus('请输入有效的IP地址', 'error'); }
            };

            const hexToHsl = (hex) => {
                let r = 0, g = 0, b = 0;
                if (hex.length == 4) { r = "0x" + hex[1] + hex[1]; g = "0x" + hex[2] + hex[2]; b = "0x" + hex[3] + hex[3]; } 
                else if (hex.length == 7) { r = "0x" + hex[1] + hex[2]; g = "0x" + hex[3] + hex[4]; b = "0x" + hex[5] + hex[6]; }
                r /= 255; g /= 255; b /= 255;
                let cmin = Math.min(r,g,b), cmax = Math.max(r,g,b), delta = cmax - cmin, h = 0, s = 0, l = 0;
                if (delta == 0) h = 0;
                else if (cmax == r) h = ((g - b) / delta) % 6;
                else if (cmax == g) h = (b - r) / delta + 2;
                else h = (r - g) / delta + 4;
                h = Math.round(h * 60);
                if (h < 0) h += 360;
                l = (cmax + cmin) / 2;
                s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
                s = +(s * 100).toFixed(1); l = +(l * 100).toFixed(1);
                return "hsl(" + h + "," + s + "%," + l + "%)";
            }
            
            const applyTraditionalColor = (themeIndex) => {
                const theme = traditionalColors[themeIndex];
                if (!theme) return;
                const accentColor = theme.colors[0].hex;
                const accentHsl = hexToHsl(accentColor);
                const accentGlow = accentHsl.replace('hsl(', 'hsla(').replace(')', `, 0.3)`);
                document.documentElement.style.setProperty('--accent-color', accentColor);
                document.documentElement.style.setProperty('--accent-glow', accentGlow);
                themeInfoName.textContent = theme.name;
                themeInfoDesc.textContent = theme.description;
                currentThemeIndex = themeIndex;
                if(!themeColorLocked) localStorage.setItem('reader_controller_theme_index', themeIndex);
            };
            
            const setRandomTraditionalColor = () => {
                if (themeColorLocked) return;
                const randomIndex = Math.floor(Math.random() * traditionalColors.length);
                applyTraditionalColor(randomIndex);
            };
            
            const toggleThemeLock = () => {
                themeColorLocked = !themeColorLocked;
                localStorage.setItem('reader_controller_theme_locked', themeColorLocked);
                updateLockIcon();
                if (themeColorLocked) {
                    localStorage.setItem('reader_controller_locked_index', currentThemeIndex);
                    showStatus('主题色已锁定', 'success', 1500);
                } else {
                    localStorage.removeItem('reader_controller_locked_index');
                    showStatus('主题色已解锁', 'success', 1500);
                    setRandomTraditionalColor();
                }
            };

            const updateLockIcon = () => {
                lockThemeBtn.classList.toggle('locked', themeColorLocked);
                unlockIcon.style.display = themeColorLocked ? 'block' : 'none';
                lockIcon.style.display = themeColorLocked ? 'none' : 'block';
            };

            const applyTheme = (theme) => {
                document.documentElement.setAttribute('data-theme', theme);
                themeToggleCheckbox.checked = theme === 'dark';
                localStorage.setItem('reader_controller_theme_mode', theme);
            };

            const applyMode = (mode) => {
                currentMode = mode; mainContent.setAttribute('data-mode', mode);
                const isKoreader = mode === 'koreader';
                modeBtnKoreader.classList.toggle('active', isKoreader);
                modeBtnKobo.classList.toggle('active', !isKoreader);
                glider.style.transform = isKoreader ? 'translateX(0)' : 'translateX(100px)';
                footer.textContent = isKoreader 
                    ? '提示：请确保KOReader已开启“HTTP调试服务器”。'
                    : '提示：请确保Kobo已启动内置翻页HTTP服务器。';
                localStorage.setItem('reader_controller_device_mode', mode);
            };
            
            const applyClickEffect = (effect) => {
                currentClickEffect = effect;
                mainContent.setAttribute('data-click-effect', effect);
                effectToggleBtn.querySelector('.btn-text').textContent = `效果: ${effect === 'ripple' ? '涟漪' : '辉光'}`;
                localStorage.setItem('reader_controller_click_effect', effect);
            };

            const renderFunctionArea = () => {
                functionArea.innerHTML = '';
                
                // Add settings button first
                const settingsBtn = document.createElement('button');
                settingsBtn.id = 'settingsBtn';
                settingsBtn.className = 'function-btn';
                settingsBtn.innerHTML = `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> 设置`;
                settingsBtn.addEventListener('click', openSettingsModal);
                functionArea.appendChild(settingsBtn);

                userFunctionLayout.forEach(actionId => {
                    const action = KOREADER_ACTIONS[actionId];
                    if (!action) return;

                    let el;
                    switch(action.type) {
                        case 'slider':
                            el = document.createElement('div');
                            el.className = 'function-slider-container';
                            el.innerHTML = `${action.svg}<input type="range" min="0" max="100" value="50" id="${action.id}-slider">`;
                            const debouncedSend = debounce((val) => sendRequest(action.event, action.msg, val), 200);
                            el.querySelector('input').addEventListener('input', e => debouncedSend(e.target.value));
                            break;
                        case 'toggle':
                            el = document.createElement('button');
                            el.className = 'function-toggle';
                            el.innerHTML = `${action.svg}<span class="btn-text">${action.name}</span>`;
                            el.addEventListener('click', () => {
                                el.classList.toggle('active');
                                sendRequest(action.event, action.msg);
                            });
                            break;
                        default: // button
                            el = document.createElement('button');
                            el.className = 'function-btn';
                            el.innerHTML = `${action.svg}<span class="btn-text">${action.name}</span>`;
                            el.addEventListener('click', () => sendRequest(action.event, action.msg));
                            break;
                    }
                    functionArea.appendChild(el);
                });
            };
            
            // === Settings Modal Logic ===
            const openSettingsModal = () => {
                koreaderPortInput.value = koreaderPort;
                renderSettingsLists();
                settingsModal.style.display = 'flex';
            };
            
            const closeSettingsModal = () => {
                settingsModal.style.display = 'none';
            };
            
            const saveSettings = () => {
                const newPort = parseInt(koreaderPortInput.value);
                if(newPort >= 1024 && newPort <= 65535) {
                    koreaderPort = newPort;
                    localStorage.setItem('reader_controller_koreader_port', koreaderPort);
                } else {
                    showStatus('端口号无效 (必须在 1024-65535 之间)', 'error');
                    return;
                }

                const newLayout = Array.from(visibleActionsList.querySelectorAll('.action-item')).map(item => item.dataset.actionId);
                if (newLayout.length > 6) {
                    showStatus('最多只能启用6个功能', 'error');
                    return;
                }
                userFunctionLayout = newLayout;
                localStorage.setItem('reader_controller_function_layout', JSON.stringify(userFunctionLayout));
                
                renderFunctionArea();
                closeSettingsModal();
                showStatus('设置已保存', 'success');
            };

            const createActionItem = (action) => {
                const item = document.createElement('div');
                item.className = 'action-item';
                item.dataset.actionId = action.id;
                item.draggable = true;
                item.innerHTML = `${action.svg} <span>${action.name}</span>`;
                return item;
            };

            const renderSettingsLists = () => {
                visibleActionsList.innerHTML = '<h4>已启用功能</h4>';
                availableActionsList.innerHTML = '<h4>可用功能</h4>';

                const visibleIds = new Set(userFunctionLayout);
                
                userFunctionLayout.forEach(id => {
                    const action = KOREADER_ACTIONS[id];
                    if(action) visibleActionsList.appendChild(createActionItem(action));
                });
                
                Object.values(KOREADER_ACTIONS).forEach(action => {
                    if (!visibleIds.has(action.id)) {
                        availableActionsList.appendChild(createActionItem(action));
                    }
                });
            };

            const handleDragStart = (e) => {
                if(!e.target.classList.contains('action-item')) return;
                draggedItem = e.target;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            };

            const handleDragEnd = (e) => {
                if(!draggedItem) return;
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                const list = e.target.closest('.actions-list');
                if (!list) return;

                if (list.id === 'visibleActionsList' && list.querySelectorAll('.action-item').length >= 6 && !list.contains(draggedItem)) {
                    return;
                }

                const afterElement = getDragAfterElement(list, e.clientY);
                if (afterElement == null) {
                    list.appendChild(draggedItem);
                } else {
                    list.insertBefore(draggedItem, afterElement);
                }
            };
            
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.action-item:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            // === Initialization ===
            const initializeApp = () => {
                // Restore Light/Dark Theme
                const savedTheme = localStorage.getItem('reader_controller_theme_mode') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                applyTheme(savedTheme);

                // Restore IP
                const savedIp = localStorage.getItem('reader_controller_ip');
                if (savedIp) { ipInput.value = savedIp; currentIp = savedIp; setTimeout(() => showStatus(`已加载IP: ${savedIp}`, 'success', 2000), 800); }

                // Restore Kobo/KOReader Mode
                const savedMode = localStorage.getItem('reader_controller_device_mode') || 'koreader';
                applyMode(savedMode);

                // Restore Click Effect
                const savedEffect = localStorage.getItem('reader_controller_click_effect') || 'glow';
                applyClickEffect(savedEffect);
                
                // Restore Accent Color Theme
                themeColorLocked = localStorage.getItem('reader_controller_theme_locked') === 'true';
                updateLockIcon();
                const lockedIndex = localStorage.getItem('reader_controller_locked_index');
                if (themeColorLocked && lockedIndex) {
                    applyTraditionalColor(parseInt(lockedIndex));
                } else {
                    const savedIndex = localStorage.getItem('reader_controller_theme_index');
                    if (savedIndex) applyTraditionalColor(parseInt(savedIndex));
                    setRandomTraditionalColor();
                }
                
                // Restore KOReader Port & Function Layout
                koreaderPort = localStorage.getItem('reader_controller_koreader_port') || 8080;
                const savedLayout = localStorage.getItem('reader_controller_function_layout');
                if(savedLayout) {
                    userFunctionLayout = JSON.parse(savedLayout);
                }
                renderFunctionArea();

                // === BIND EVENT LISTENERS ===
                themeToggleCheckbox.addEventListener('change', () => applyTheme(themeToggleCheckbox.checked ? 'dark' : 'light'));
                lockThemeBtn.addEventListener('click', toggleThemeLock);
                document.getElementById('ipForm').addEventListener('submit', (e) => { e.preventDefault(); saveIp(); });
                modeBtnKoreader.addEventListener('click', () => applyMode('koreader'));
                modeBtnKobo.addEventListener('click', () => applyMode('kobo'));
                effectToggleBtn.addEventListener('click', () => applyClickEffect(currentClickEffect === 'glow' ? 'ripple' : 'glow'));

                document.querySelectorAll('.control-card').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        sendRequest(btn.dataset.action, btn.dataset.successMsg);
                        if (currentClickEffect === 'ripple') {
                             const ripple = document.createElement("span");
                             ripple.classList.add("ripple");
                             const rect = btn.getBoundingClientRect();
                             const size = Math.max(rect.width, rect.height);
                             ripple.style.width = ripple.style.height = size + "px";
                             ripple.style.left = (e.clientX - rect.left - size/2) + "px";
                             ripple.style.top = (e.clientY - rect.top - size/2) + "px";
                             btn.appendChild(ripple);
                             setTimeout(() => ripple.remove(), 600);
                        }
                    });
                });

                koboExitBtn.addEventListener('click', () => {
                    if (!koboExitConfirm) {
                        koboExitConfirm = true;
                        const originalText = koboExitBtn.querySelector('.btn-text').textContent;
                        koboExitBtn.querySelector('.btn-text').textContent = "再次点击确认";
                        koboExitBtn.classList.add('confirm-state');
                        clearTimeout(koboExitTimeout);
                        koboExitTimeout = setTimeout(() => {
                            koboExitBtn.querySelector('.btn-text').textContent = originalText;
                            koboExitBtn.classList.remove('confirm-state');
                            koboExitConfirm = false;
                        }, 4000);
                    } else {
                        clearTimeout(koboExitTimeout);
                        sendRequest(koboExitBtn.dataset.action, koboExitBtn.dataset.successMsg);
                        koboExitBtn.querySelector('.btn-text').textContent = "关闭服务器";
                        koboExitBtn.classList.remove('confirm-state');
                        koboExitConfirm = false;
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (document.activeElement === ipInput || document.activeElement === koreaderPortInput) return;
                    if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') document.querySelector('.control-card[data-action="prev"]').click();
                    if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') document.querySelector('.control-card[data-action="next"]').click();
                });
                
                // Settings Modal Listeners
                modalCloseBtn.addEventListener('click', closeSettingsModal);
                cancelModalBtn.addEventListener('click', closeSettingsModal);
                saveModalBtn.addEventListener('click', saveSettings);
                window.addEventListener('click', (e) => {
                    if (e.target == settingsModal) closeSettingsModal();
                });
                document.addEventListener('dragstart', handleDragStart);
                document.addEventListener('dragend', handleDragEnd);
                document.addEventListener('dragover', handleDragOver);
            };

            initializeApp();
        });
    </script>
</body>
</html>