<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zen Time</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400&display=swap" rel="stylesheet">

    <style>
        /* [所有样式代码与之前版本相同] */
        :root { --text-color: rgba(255, 255, 255, 0.9); --text-color-secondary: #aaa; --bg-color: #000; --btn-bg-color: rgba(255, 255, 255, 0.1); --btn-border-color: #fff; --transition-speed: 0.3s; --animation-speed: 0.5s; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Manrope', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; text-align: center; flex-direction: column; overflow: hidden; -webkit-user-select: none; user-select: none; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: var(--bg-color); z-index: 1000; transition: opacity var(--animation-speed) ease; }
        .spinner { width: 50px; height: 50px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: var(--btn-border-color); animation: spin 1s ease-in-out infinite; }
        #start-screen h1 { font-weight: 300; font-size: 2.5rem; margin-bottom: 2rem; }
        .start-btn { background: transparent; border: 1px solid var(--text-color-secondary); color: var(--text-color-secondary); padding: 1rem 2rem; border-radius: 50px; font-size: 1rem; cursor: pointer; transition: all var(--transition-speed) ease; }
        .start-btn:hover { background: var(--btn-border-color); color: var(--bg-color); border-color: var(--btn-border-color); }
        .container { display: none; width: 100%; height: 100%; flex-direction: column; animation: fadeIn var(--animation-speed) ease-in-out; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .timer { font-size: 8rem; font-weight: 300; letter-spacing: -2px; animation: pulse 8s ease-in-out infinite; }
        .tagline { font-size: 1.1rem; color: var(--text-color-secondary); margin-top: -10px; line-height: 1.6; min-height: 50px; padding: 0 20px; }
        .location { background-color: var(--btn-bg-color); padding: 10px 20px; border-radius: 20px; margin-top: 50px; backdrop-filter: blur(5px); }
        .location-date { font-size: 0.9rem; }
        .sound-selector { padding: 20px 0; flex-shrink: 0; }
        .sound-btn { background-color: var(--btn-bg-color); border: 2px solid transparent; border-radius: 50%; width: 60px; height: 60px; margin: 0 10px; cursor: pointer; color: white; font-size: 0.8rem; transition: transform var(--transition-speed) ease, border-color var(--transition-speed) ease; }
        .sound-btn:hover { transform: scale(1.1); }
        .sound-btn.active { border-color: var(--btn-border-color); transform: scale(1.1); }
        #player-container { position: absolute; top: -9999px; left: -9999px; width: 0; height: 0; opacity: 0; pointer-events: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .hidden { display: none; }
        .fade-out { opacity: 0; pointer-events: none; }
        #debug-log { position: fixed; top: 10px; left: 10px; background-color: rgba(0, 0, 0, 0.7); color: #0f0; font-family: monospace; font-size: 12px; padding: 10px; border-radius: 5px; z-index: 9999; text-align: left; max-height: 90vh; overflow-y: auto; display: none; /* 默认隐藏调试窗口 */ }
    </style>
</head>
<body>
    
    <div id="debug-log"></div>
    <div class="overlay" id="preloader"><div class="spinner"></div></div>
    <div class="overlay hidden" id="start-screen"><h1>Zen Time</h1><button class="start-btn" id="start-btn">Begin</button></div>
    <div class="container" id="container"><div class="main-content"><div class="timer" id="timer"></div><p class="tagline" id="tagline"></p><div class="location"><div class="location-date" id="location-date"></div></div></div><div class="sound-selector"></div></div>
    <div id="player-container"></div>

    <script>
        // ... [所有上层变量和函数定义与之前相同]
        const debugLog = document.getElementById('debug-log');
        function log(message) { console.log(message); debugLog.innerHTML += `> ${message}<br>`; }
        document.addEventListener('copy', (e) => { e.preventDefault(); alert('请闭眼'); });
        const themes = [ { name: "春涧", youtubeId: "eSKH2g2y_dY", bilibiliId: "BV18z4y1d7kS", time: 180, tagline: "溪流潺潺，万物复苏...<br>在自然的节奏中找到平静" }, { name: "极光", youtubeId: "n5n2bg5JqM8", bilibiliId: "BV15T4y1a7kM", time: 300, tagline: "仰望星空，光之舞动...<br>感受宇宙的浩瀚与神秘" }, { name: "雪舞", youtubeId: "vHDkfiPn_gE", bilibiliId: "BV1fy4y1a7oE", time: 120, tagline: "万籁俱寂，雪落无声...<br>世界在你我心中纯净如初" }, { name: "焰响", youtubeId: "KqJ_H_g_c4A", bilibiliId: "BV1jV411W7Ss", time: 90, tagline: "围炉夜话，温暖跳动...<br>让思绪在火光中得到沉淀" }, { name: "流云", youtubeId: "2O4_zLi3fNA", bilibiliId: "BV1gM4y1A7ML", time: 60, tagline: "云卷云舒，随风而动...<br>短暂的休憩是为了更好的出发" } ];
        const timerElement = document.getElementById('timer');
        const taglineElement = document.getElementById('tagline');
        const soundSelector = document.querySelector('.sound-selector');
        const playerContainer = document.getElementById('player-container');
        const locationDateElement = document.getElementById('location-date');
        let countdown, player, currentPlatform, isYouTubeApiReady = false, hasStarted = false;
        function startCountdown(duration) { clearInterval(countdown); let timeLeft = parseInt(duration); timerElement.textContent = timeLeft; timerElement.style.animation = 'pulse 8s ease-in-out infinite'; countdown = setInterval(() => { if (timeLeft <= 1) { clearInterval(countdown); timerElement.textContent = "Done"; timerElement.style.animation = 'none'; } else { timeLeft--; timerElement.textContent = timeLeft; } }, 1000); }
        function updateContent(button) { const theme = themes[button.dataset.index]; taglineElement.innerHTML = theme.tagline; startCountdown(theme.time); soundSelector.querySelectorAll('.sound-btn').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); }
        
        /**********************************************
         *  核心修复：playVideo 函数
         **********************************************/
        function playVideo(videoId) {
            log(`Attempting to play video ID: ${videoId}`);
            playerContainer.innerHTML = ''; // 清空旧的播放器实例

            if (currentPlatform === 'bilibili') {
                log('Platform is Bilibili. Creating iframe with "allow" attribute.');
                const iframe = document.createElement('iframe');
                iframe.src = `//player.bilibili.com/player.html?bvid=${videoId}&autoplay=true&high_quality=1&danmaku=0&loop=true`;
                iframe.scrolling = "no";
                iframe.style.border = "0";
                iframe.frameBorder = "no";
                iframe.framespacing = "0";
                // 关键修复：明确授予自动播放权限
                iframe.allow = "autoplay"; 
                iframe.allowFullscreen = true;
                
                playerContainer.appendChild(iframe);
            } else {
                log('Platform is YouTube.');
                if (!isYouTubeApiReady) {
                    log('ERROR: YouTube API is not ready yet!');
                    return;
                }
                if (player && typeof player.loadVideoById === 'function') {
                    log('Existing player found. Loading new video.');
                    player.loadVideoById(videoId);
                } else {
                    log('No player found. Creating new YT.Player instance.');
                    playerContainer.innerHTML = `<div id="yt-player"></div>`;
                    player = new YT.Player('yt-player', {
                        height: '190', width: '320', videoId: videoId,
                        playerVars: { 'autoplay': 1, 'loop': 1, 'playlist': videoId, 'controls': 0, 'fs': 0 },
                        events: { 
                            'onReady': (event) => { log('YouTube Player Ready. Muting and playing.'); event.target.mute(); event.target.playVideo(); },
                            'onError': (event) => { log(`YouTube Player Error: ${event.data}`); }
                        }
                    });
                }
            }
        }
        
        // ... [所有其他函数 createButtons, detectPlatform, startApp, setupApp 与之前相同]
        function createButtons() { themes.forEach((theme, index) => { const button = document.createElement('button'); button.className = 'sound-btn'; button.textContent = theme.name; button.dataset.index = index; if (index === 2) button.classList.add('active'); button.addEventListener('click', () => { updateContent(button); playVideo(currentPlatform === 'bilibili' ? theme.bilibiliId : theme.youtubeId); }); soundSelector.appendChild(button); }); }
        function detectPlatform() { try { const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone; if (timeZone.startsWith('Asia/Shanghai') || timeZone.startsWith('Asia/Chongqing') || timeZone.startsWith('Asia/Urumqi')) return 'bilibili'; } catch (e) { log("Could not determine timezone, defaulting to YouTube."); } return 'youtube'; }
        function startApp() { if (hasStarted) return; hasStarted = true; const startScreen = document.getElementById('start-screen'); startScreen.classList.add('fade-out'); setTimeout(() => { startScreen.classList.add('hidden'); document.getElementById('container').style.display = 'flex'; const activeButton = soundSelector.querySelector('.sound-btn.active'); updateContent(activeButton); const activeTheme = themes[activeButton.dataset.index]; playVideo(currentPlatform === 'bilibili' ? activeTheme.bilibiliId : activeTheme.youtubeId); }, 500); }
        function setupApp() { const preloader = document.getElementById('preloader'); preloader.classList.add('fade-out'); setTimeout(() => { preloader.classList.add('hidden'); document.getElementById('start-screen').classList.remove('hidden'); }, 500); currentPlatform = detectPlatform(); log(`Platform detected: ${currentPlatform}`); locationDateElement.textContent = new Date().toLocaleString('zh-CN', { dateStyle: 'long', timeStyle: 'short' }); createButtons(); document.getElementById('start-btn').addEventListener('click', startApp); if (currentPlatform === 'youtube') { log('Loading YouTube IFrame API...'); const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; document.head.appendChild(tag); } }
        window.onYouTubeIframeAPIReady = () => { log('SUCCESS: YouTube IFrame API is ready.'); isYouTubeApiReady = true; };
        document.addEventListener('DOMContentLoaded', () => { log('DOM content loaded.'); setupApp(); });
    </script>
</body>
</html>