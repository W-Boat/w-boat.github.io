<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docx Forge Pro - 专业级本地 DOCX 工具</title>
    
    <!-- 外部资源库 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        input[type="radio"]:checked + div { border-color: #4f46e5; background-color: #eef2ff; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        input[type="radio"]:checked + div h4 { color: #4338ca; }
        .file-list-ghost { opacity: 0.4; background: #c7d2fe; border-style: dashed; }
    </style>
</head>
<body class="antialiased text-slate-700">

    <div class="container mx-auto max-w-4xl p-4 md:p-8">
        
        <header class="text-center mb-10">
            <h1 class="text-5xl md:text-6xl font-extrabold text-slate-800 tracking-tight">Docx Forge <span class="text-indigo-600">Pro</span></h1>
            <p class="mt-4 text-lg text-slate-600 max-w-2xl mx-auto">一个在您浏览器中运行的私人、安全、强大的 DOCX 工作站，提供极致的文档处理体验。</p>
        </header>

        <div class="p-4 mb-8 bg-sky-100 border-l-4 border-sky-500 text-sky-800 rounded-r-lg shadow-sm">
            <div class="flex items-center">
                <i data-lucide="chrome" class="h-6 w-6 mr-3 flex-shrink-0"></i>
                <p class="font-semibold">为了获得最佳性能和兼容性，强烈建议使用最新版本的 Google Chrome 浏览器。</p>
            </div>
        </div>

        <div class="mb-8 border-b border-slate-200">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs"><button data-tab="merger" class="tab-button active shrink-0 border-b-2 border-indigo-500 px-1 pb-4 text-sm font-semibold text-indigo-600 transition-all">合并文档</button><button data-tab="splitter" class="tab-button shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-slate-500 hover:border-slate-300 hover:text-slate-700 transition-all">分割文档</button></nav>
        </div>

        <main id="tab-content-container" class="transition-opacity duration-300"></main>
        
        <footer class="mt-16 text-center text-slate-500 text-sm"><p>© 2025 Docx Forge Pro. 所有文件均在本地处理，隐私安全无忧。</p></footer>
    </div>
    
    <template id="merger-template"> <div class="space-y-8 bg-white p-6 md:p-8 rounded-2xl shadow-xl fade-in-up"> <div><h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><i data-lucide="upload-cloud" class="text-indigo-500"></i>第一步: 上传文件</h2><div id="merge-drop-zone" class="mt-4 border-3 border-dashed border-slate-300 rounded-lg p-8 text-center cursor-pointer transition-all duration-300 hover:border-indigo-500 hover:bg-indigo-50"><div class="pointer-events-none"><i data-lucide="file-up" class="mx-auto h-12 w-12 text-slate-400"></i><p class="mt-4 font-semibold text-slate-700">拖拽多个 DOCX 文件，或<span class="text-indigo-600">点击选择</span></p></div></div><input type="file" id="merge-file-input" class="hidden" multiple accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document"></div> <div id="merge-files-section" class="hidden"><div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><i data-lucide="files" class="text-indigo-500"></i>第二步: 排序与设置</h2><button id="clear-all-btn" class="text-sm font-medium text-slate-500 hover:text-red-600 transition-colors flex items-center gap-1"><i data-lucide="trash-2" class="h-4 w-4"></i>清空</button></div><div id="file-list" class="mt-4 max-h-80 overflow-y-auto pr-2 space-y-3"></div><div class="mt-6 border-t border-slate-200 pt-6"><h3 class="text-lg font-semibold text-slate-700">合并选项</h3><div class="mt-4 flex items-center"><input id="add-page-break" type="checkbox" checked class="h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500"><label for="add-page-break" class="ml-3 block text-sm font-medium text-slate-700">在每个文档间插入分页符</label></div></div></div> <div id="merge-action-section"><button id="merge-button" disabled class="w-full flex items-center justify-center gap-3 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 disabled:bg-slate-400 disabled:shadow-none disabled:cursor-not-allowed transition-all duration-300 active:scale-95"><i data-lucide="combine"></i><span id="merge-button-text">请先上传文件</span></button><p id="merge-error-message" class="text-red-500 text-sm mt-3 text-center h-4"></p></div> </div> </template>
    <template id="splitter-template"> <div class="space-y-8 bg-white p-6 md:p-8 rounded-2xl shadow-xl fade-in-up"> <div><h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><i data-lucide="file-up" class="text-indigo-500"></i>第一步: 上传单个文件</h2><div id="split-drop-zone" class="mt-4 border-3 border-dashed border-slate-300 rounded-lg p-8 text-center cursor-pointer transition-all duration-300 hover:border-indigo-500 hover:bg-indigo-50"><div class="pointer-events-none"><i data-lucide="file-scan" class="mx-auto h-12 w-12 text-slate-400"></i><p class="mt-4 font-semibold text-slate-700">拖拽一个 DOCX 文件，或<span class="text-indigo-600">点击选择</span></p></div></div><input type="file" id="split-file-input" class="hidden" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document"></div> <div id="split-analysis-section" class="hidden"><h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><i data-lucide="settings-2" class="text-indigo-500"></i>第二步: 选择分割模式</h2><div class="mt-4 bg-slate-50 rounded-lg p-4 flex justify-around text-center"><dl><dt class="text-sm text-slate-500">文件名</dt><dd id="split-file-name" class="font-semibold text-slate-800 truncate"></dd></dl><dl><dt class="text-sm text-slate-500">章节</dt><dd id="detected-sections" class="font-semibold text-slate-800"></dd></dl><dl><dt class="text-sm text-slate-500">分页符</dt><dd id="detected-page-breaks" class="font-semibold text-slate-800"></dd></dl></div><div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4"><label for="split-by-page"><input type="radio" name="split-mode" id="split-by-page" value="page" class="sr-only"><div class="p-4 rounded-lg border-2 border-slate-300 cursor-pointer h-full transition-all"><h4 class="font-semibold text-slate-800">按分页符范围</h4><p class="text-sm text-slate-600 mt-1">根据手动分页符分割。如 "1-3, 5"。</p><input type="text" id="page-range-input" placeholder="例如: 1-3, 5" class="mt-2 w-full text-sm p-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 transition"></div></label><label for="split-by-section"><input type="radio" name="split-mode" id="split-by-section" value="section" class="sr-only"><div class="p-4 rounded-lg border-2 border-slate-300 cursor-pointer h-full transition-all"><h4 class="font-semibold text-slate-800">按章节</h4><p class="text-sm text-slate-600 mt-1">每个章节分割成独立文件。</p></div></label><label for="split-single-pages"><input type="radio" name="split-mode" id="split-single-pages" value="single" class="sr-only"><div class="p-4 rounded-lg border-2 border-slate-300 cursor-pointer h-full transition-all"><h4 class="font-semibold text-slate-800">逐页分割</h4><p class="text-sm text-slate-600 mt-1">每个分页符分割成独立文件。</p></div></label></div><div class="mt-4 text-xs text-slate-500"><b>功能:</b> 分割时可保留图片、超链接、列表和大部分文本格式。<br><b>注意:</b> "页码"是基于手动插入的“分页符”计算的。</div></div> <div id="split-action-section"><button id="split-button" disabled class="w-full flex items-center justify-center gap-3 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 disabled:bg-slate-400 disabled:shadow-none disabled:cursor-not-allowed transition-all duration-300 active:scale-95"><i data-lucide="scissors"></i><span id="split-button-text">请先上传文件</span></button><p id="split-error-message" class="text-red-500 text-sm mt-3 text-center h-4"></p></div> </div> </template>
    
    <script>
    // ====================================================================================
    // 内嵌的 `docx-merger` 库 (已修复 PizZip 的同步API不兼容问题)
    // ====================================================================================
    (function(window){'use strict';const JSZip=window.PizZip,DOMParser=window.DOMParser,XMLSerializer=window.XMLSerializer,Style={};Style.prepareStyles=function(files){const serializer=new XMLSerializer;files.forEach(zip=>{let xmlString=zip.file("word/styles.xml").asText(),xml=new DOMParser().parseFromString(xmlString,'text/xml'),nodes=xml.getElementsByTagName('w:style');for(let i=0;i<nodes.length;i++){const node=nodes[i];if(node.getAttribute){const styleId=node.getAttribute('w:styleId');node.setAttribute('w:styleId',styleId+'_'+files.indexOf(zip));const basedonStyle=node.getElementsByTagName('w:basedOn')[0];basedonStyle&&basedonStyle.setAttribute('w:val',basedonStyle.getAttribute('w:val')+'_'+files.indexOf(zip));const w_next=node.getElementsByTagName('w:next')[0];w_next&&w_next.setAttribute('w:val',w_next.getAttribute('w:val')+'_'+files.indexOf(zip));const w_link=node.getElementsByTagName('w:link')[0];w_link&&w_link.setAttribute('w:val',w_link.getAttribute('w:val')+'_'+files.indexOf(zip));const numId=node.getElementsByTagName('w:numId')[0];numId&&numId.setAttribute('w:val',numId.getAttribute('w:val')+files.indexOf(zip)),Style.updateStyleRel_Content(zip,files.indexOf(zip),styleId)}}const startIndex=xmlString.indexOf("<w:styles ");xmlString=xmlString.replace(xmlString.slice(startIndex),serializer.serializeToString(xml.documentElement)),zip.file("word/styles.xml",xmlString)})},Style.mergeStyles=function(files,_styles){files.forEach(zip=>{let xmlString=zip.file("word/styles.xml").asText();xmlString=xmlString.substring(xmlString.indexOf("<w:style "),xmlString.indexOf("</w:styles")),_styles.push(xmlString)})},Style.updateStyleRel_Content=function(zip,fileIndex,styleId){let xmlString=zip.file("word/document.xml").asText();xmlString=xmlString.replace(new RegExp('w:val="'+styleId+'"','g'),'w:val="'+styleId+'_'+fileIndex+'"'),zip.file("word/document.xml",xmlString)},Style.generateStyles=function(zip,_style){let xmlString=zip.file("word/styles.xml").asText();const startIndex=xmlString.indexOf("<w:style "),endIndex=xmlString.indexOf("</w:styles>");xmlString=xmlString.replace(xmlString.slice(startIndex,endIndex),_style.join('')),zip.file("word/styles.xml",xmlString)};const RelContentType={};RelContentType.mergeContentTypes=function(files,_contentTypes){files.forEach(zip=>{const xmlString=zip.file("[Content_Types].xml").asText(),xml=new DOMParser().parseFromString(xmlString,'text/xml'),childNodes=xml.getElementsByTagName('Types')[0].childNodes;for(let i=0;i<childNodes.length;i++){const node=childNodes[i];if(node.getAttribute){const contentType=node.getAttribute('ContentType');_contentTypes[contentType]||(_contentTypes[contentType]=node.cloneNode())}}})},RelContentType.mergeRelations=function(files,_rel){files.forEach(zip=>{const relsFile=zip.file("word/_rels/document.xml.rels");if(!relsFile)return;const xmlString=relsFile.asText(),xml=new DOMParser().parseFromString(xmlString,'text/xml'),childNodes=xml.getElementsByTagName('Relationships')[0].childNodes;for(let i=0;i<childNodes.length;i++){const node=childNodes[i];if(node.getAttribute){const Id=node.getAttribute('Id');_rel[Id]||(_rel[Id]=node.cloneNode())}}})},RelContentType.generateContentTypes=function(zip,_contentTypes){let xmlString=zip.file("[Content_Types].xml").asText();const xml=new DOMParser().parseFromString(xmlString,'text/xml'),serializer=new XMLSerializer,types=xml.documentElement.cloneNode();for(const node in _contentTypes)types.appendChild(_contentTypes[node]);const startIndex=xmlString.indexOf("<Types");xmlString=xmlString.replace(xmlString.slice(startIndex),serializer.serializeToString(types)),zip.file("[Content_Types].xml",xmlString)},RelContentType.generateRelations=function(zip,_rel){const relsFile=zip.file("word/_rels/document.xml.rels");if(!relsFile)return;let xmlString=relsFile.asText();const xml=new DOMParser().parseFromString(xmlString,'text/xml'),serializer=new XMLSerializer,types=xml.documentElement.cloneNode();for(const node in _rel)types.appendChild(_rel[node]);const startIndex=xmlString.indexOf("<Relationships");xmlString=xmlString.replace(xmlString.slice(startIndex),serializer.serializeToString(types)),zip.file("word/_rels/document.xml.rels",xmlString)};const Media={};Media.prepareMediaFiles=function(files,media){let count=1;files.forEach((zip,index)=>{const medFiles=zip.folder("word/media").files;for(const mfile in medFiles)/^word\/media/.test(mfile)&&mfile.length>11&&(media[count]={oldTarget:mfile,newTarget:mfile.replace(/[0-9]/,'_'+count).replace('word/',""),fileIndex:index},Media.updateMediaRelations(zip,count,media),Media.updateMediaContent(zip,count,media),count++)})},Media.updateMediaRelations=function(zip,count,_media){const relsFile=zip.file("word/_rels/document.xml.rels");if(!relsFile)return;let xmlString=relsFile.asText(),xml=new DOMParser().parseFromString(xmlString,'text/xml');const childNodes=xml.getElementsByTagName('Relationships')[0].childNodes,serializer=new XMLSerializer;for(let i=0;i<childNodes.length;i++){const node=childNodes[i];if(node.getAttribute){const target=node.getAttribute('Target');'word/'+target===_media[count].oldTarget&&(_media[count].oldRelID=node.getAttribute('Id'),node.setAttribute('Target',_media[count].newTarget),node.setAttribute('Id',_media[count].oldRelID+'_'+count))}}const startIndex=xmlString.indexOf("<Relationships");xmlString=xmlString.replace(xmlString.slice(startIndex),serializer.serializeToString(xml.documentElement)),zip.file("word/_rels/document.xml.rels",xmlString)},Media.updateMediaContent=function(zip,count,_media){let xmlString=zip.file("word/document.xml").asText();xmlString=xmlString.replace(new RegExp(_media[count].oldRelID+'"','g'),_media[count].oldRelID+'_'+count+'"'),zip.file("word/document.xml",xmlString)},Media.copyMediaFiles=function(base,_media,_files){for(const media in _media){const content=_files[_media[media].fileIndex].file(_media[media].oldTarget).asUint8Array();base.file('word/'+_media[media].newTarget,content)}};const bulletsNumbering={};bulletsNumbering.prepareNumbering=function(files){const serializer=new XMLSerializer;files.forEach((zip,index)=>{const xmlBin=zip.file('word/numbering.xml');if(!xmlBin)return;let xmlString=xmlBin.asText();const xml=new DOMParser().parseFromString(xmlString,'text/xml'),nodes=xml.getElementsByTagName('w:abstractNum');for(let i=0;i<nodes.length;i++){const node=nodes[i];if(node.getAttribute){node.setAttribute('w:abstractNumId',node.getAttribute('w:abstractNumId')+index);const pStyles=node.getElementsByTagName('w:pStyle');for(let j=0;j<pStyles.length;j++)pStyles[j].getAttribute&&pStyles[j].setAttribute('w:val',pStyles[j].getAttribute('w:val')+'_'+index);const numStyleLinks=node.getElementsByTagName('w:numStyleLink');for(let j=0;j<numStyleLinks.length;j++)numStyleLinks[j].getAttribute&&numStyleLinks[j].setAttribute('w:val',numStyleLinks[j].getAttribute('w:val')+'_'+index);const styleLinks=node.getElementsByTagName('w:styleLink');for(let j=0;j<styleLinks.length;j++)styleLinks[j].getAttribute&&styleLinks[j].setAttribute('w:val',styleLinks[j].getAttribute('w:val')+'_'+index)}}const numNodes=xml.getElementsByTagName('w:num');for(let i=0;i<numNodes.length;i++){const node=numNodes[i];if(node.getAttribute){node.setAttribute('w:numId',node.getAttribute('w:numId')+index);const absrefID=node.getElementsByTagName('w:abstractNumId');for(let j=0;j<absrefID.length;j++)absrefID[j].getAttribute&&absrefID[j].setAttribute('w:val',absrefID[j].getAttribute('w:val')+index)}}const startIndex=xmlString.indexOf("<w:numbering ");xmlString=xmlString.replace(xmlString.slice(startIndex),serializer.serializeToString(xml.documentElement)),zip.file("word/numbering.xml",xmlString)})},bulletsNumbering.mergeNumbering=function(files,_numbering){files.forEach(zip=>{const xmlBin=zip.file('word/numbering.xml');if(!xmlBin)return;let xmlString=xmlBin.asText();xmlString=xmlString.substring(xmlString.indexOf("<w:abstractNum "),xmlString.indexOf("</w:numbering")),_numbering.push(xmlString)})},bulletsNumbering.generateNumbering=function(zip,_numbering){const xmlBin=zip.file('word/numbering.xml');if(!xmlBin)return;let xmlString=xmlBin.asText();const startIndex=xmlString.indexOf("<w:abstractNum "),endIndex=xmlString.indexOf("</w:numbering>");xmlString=xmlString.replace(xmlString.slice(startIndex,endIndex),_numbering.join('')),zip.file("word/numbering.xml",xmlString)};class DocxMerger{constructor(){this._body=[],this._files=[],this._contentTypes={},this._media={},this._rel={},this._style=[],this._numbering=[]}initialize(options,files){files=files||[],this._pageBreak=void 0!==options.pageBreak?!!options.pageBreak:!0;for(const file of files)this._files.push(new JSZip(file));this._files.length>0&&this.mergeBody(this._files)}insertPageBreak(){this._body.push('<w:p><w:r><w:br w:type="page"/></w:r></w:p>')}mergeBody(files){RelContentType.mergeContentTypes(files,this._contentTypes),Media.prepareMediaFiles(files,this._media),RelContentType.mergeRelations(files,this._rel),bulletsNumbering.prepareNumbering(files),bulletsNumbering.mergeNumbering(files,this._numbering),Style.prepareStyles(files),Style.mergeStyles(files,this._style),files.forEach((zip,index)=>{let xmlString=zip.file("word/document.xml").asText(),body=xmlString.substring(xmlString.indexOf("<w:body>")+8,xmlString.indexOf("</w:body>"));body.substring(body.lastIndexOf("<w:sectPr"));body=body.substring(0,body.lastIndexOf("<w:sectPr")),this._body.push(body),this._pageBreak&&index<files.length-1&&this.insertPageBreak()})}save(type){const zip=this._files[0];let xmlString=zip.file("word/document.xml").asText();const startIndex=xmlString.indexOf("<w:body>")+8,endIndex=xmlString.lastIndexOf("<w:sectPr");return xmlString=xmlString.replace(xmlString.slice(startIndex,endIndex),this._body.join('')),RelContentType.generateContentTypes(zip,this._contentTypes),Media.copyMediaFiles(zip,this._media,this._files),RelContentType.generateRelations(zip,this._rel),bulletsNumbering.generateNumbering(zip,this._numbering),Style.generateStyles(zip,this._style),zip.file("word/document.xml",xmlString),zip.generate({type:type,compression:"DEFLATE",compressionOptions:{level:4}})}}window.DocxMerger=DocxMerger})(window);

    // --- 主程序 (UI 交互逻辑) ---
    window.addEventListener('load',()=>{const tabContainer=document.getElementById('tab-content-container'),mergerTemplate=document.getElementById('merger-template'),splitterTemplate=document.getElementById('splitter-template'),tabs={merger:mergerTemplate.innerHTML,splitter:splitterTemplate.innerHTML};let currentTab='merger';function renderTab(tabName){tabContainer.style.opacity=0,setTimeout(()=>{tabContainer.innerHTML=tabs[tabName],'merger'===tabName?initMerger():'splitter'===tabName&&initSplitter(),lucide.createIcons(),tabContainer.style.opacity=1},200)}document.querySelectorAll('.tab-button').forEach(button=>{button.addEventListener('click',e=>{const tabName=e.currentTarget.dataset.tab;if(tabName===currentTab)return;document.querySelectorAll('.tab-button').forEach(btn=>{btn.classList.remove('border-indigo-500','text-indigo-600','font-semibold'),btn.classList.add('border-transparent','text-slate-500','hover:border-slate-300','hover:text-slate-700','font-medium')}),e.currentTarget.classList.add('border-indigo-500','text-indigo-600','font-semibold'),e.currentTarget.classList.remove('border-transparent','text-slate-500','hover:border-slate-300','hover:text-slate-700','font-medium'),currentTab=tabName,renderTab(tabName)})}),renderTab('merger')});function initMerger(){const dropZone=document.getElementById('merge-drop-zone'),fileInput=document.getElementById('merge-file-input'),fileListContainer=document.getElementById('file-list'),filesSection=document.getElementById('merge-files-section'),mergeButton=document.getElementById('merge-button'),buttonText=document.getElementById('merge-button-text'),errorMessage=document.getElementById('merge-error-message'),clearAllBtn=document.getElementById('clear-all-btn'),addPageBreakCheckbox=document.getElementById('add-page-break');let filesToMerge=[],sortableInstance=null;function handleFiles(files){errorMessage.textContent='';for(const file of files)file.name.endsWith('.docx')?function(file){const reader=new FileReader;reader.onload=e=>{filesToMerge.push({id:'file_'+Date.now()+Math.random(),name:file.name,data:e.target.result}),updateFileList()},reader.readAsArrayBuffer(file)}(file):showError(`文件 "${file.name}" 不是 .docx 格式。`)}function updateFileList(){fileListContainer.innerHTML='',filesToMerge.length>0?filesSection.classList.remove('hidden'):filesSection.classList.add('hidden'),mergeButton.disabled=filesToMerge.length<2,buttonText.textContent=filesToMerge.length<2?"请至少上传两个文件":`合并 ${filesToMerge.length} 个文件`,filesToMerge.forEach((file,index)=>{const item=document.createElement('div');item.className='flex items-center gap-4 bg-slate-50 p-3 rounded-lg border border-slate-200 cursor-grab active:cursor-grabbing hover:shadow-md hover:border-indigo-200 transition-all duration-200 fade-in-up',item.style.animationDelay=`${index*50}ms`,item.dataset.id=file.id,item.innerHTML=`<i data-lucide="grip-vertical" class="h-5 w-5 text-slate-400"></i><i data-lucide="file-text" class="h-6 w-6 text-indigo-500"></i><span class="flex-grow font-medium text-slate-800 truncate">${file.name}</span><button class="remove-btn text-slate-400 hover:text-red-500 transition-colors" data-id="${file.id}"><i data-lucide="x" class="h-5 w-5 pointer-events-none"></i></button>`,fileListContainer.appendChild(item)}),lucide.createIcons(),sortableInstance&&sortableInstance.destroy(),sortableInstance=new Sortable(fileListContainer,{animation:150,ghostClass:'file-list-ghost',onEnd:evt=>{const item=filesToMerge.splice(evt.oldIndex,1)[0];filesToMerge.splice(evt.newIndex,0,item)}}),document.querySelectorAll('.remove-btn').forEach(btn=>btn.addEventListener('click',e=>{filesToMerge=filesToMerge.filter(f=>f.id!==e.currentTarget.dataset.id),updateFileList()}))}function clearAll(){filesToMerge=[],fileInput.value='',updateFileList()}function showError(message){errorMessage.textContent=message}async function executeMerge(){if(filesToMerge.length<2)return void showError('请至少上传两个文件。');mergeButton.disabled=!0,buttonText.textContent='正在合并...',errorMessage.textContent='';try{const merger=new window.DocxMerger;merger.initialize({pageBreak:addPageBreakCheckbox.checked},filesToMerge.map(f=>f.data));const mergedData=merger.save('blob'),link=document.createElement('a');link.href=URL.createObjectURL(mergedData),link.download=`merged_document_${Date.now()}.docx`,link.click(),URL.revokeObjectURL(link.href),buttonText.textContent='合并成功！'}catch(error){console.error('合并失败:',error),showError('合并过程中发生错误: '+error.message),buttonText.textContent='合并失败'}finally{setTimeout(()=>{mergeButton.disabled=!1,updateFileList()},2e3)}}dropZone.addEventListener('click',()=>fileInput.click()),fileInput.addEventListener('change',e=>handleFiles(e.target.files)),clearAllBtn.addEventListener('click',clearAll),dropZone.addEventListener('dragover',e=>{e.preventDefault(),dropZone.classList.add('border-indigo-500','bg-indigo-50')}),dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('border-indigo-500','bg-indigo-50')),dropZone.addEventListener('drop',e=>{e.preventDefault(),dropZone.classList.remove('border-indigo-500','bg-indigo-50'),handleFiles(e.dataTransfer.files)}),mergeButton.addEventListener('click',executeMerge)}function initSplitter(){const dropZone=document.getElementById('split-drop-zone'),fileInput=document.getElementById('split-file-input'),analysisSection=document.getElementById('split-analysis-section'),splitButton=document.getElementById('split-button'),splitButtonText=document.getElementById('split-button-text'),errorMessage=document.getElementById('split-error-message');let docxFile=null,docInfo={};function setLoading(isLoading,text){splitButton.disabled=isLoading,splitButtonText.textContent=text;const icon=splitButton.querySelector('i');icon.setAttribute('data-lucide',isLoading?'loader-2':'scissors'),isLoading?icon.classList.add('animate-spin'):icon.classList.remove('animate-spin'),lucide.createIcons()}function resetSplitter(isError){analysisSection.classList.add('hidden'),setLoading(!1,'请先上传文件'),splitButton.disabled=!0,docxFile=null,isError&&showError("无法解析此文件，请尝试其他文档。")}function showError(message){errorMessage.textContent=message}async function handleFile(e){const file=e.target.files[0];if(!file||!file.name.endsWith('.docx'))return void showError('请选择一个有效的 .docx 文件');docxFile=file,setLoading(!0,'分析中...'),errorMessage.textContent='';try{const arrayBuffer=await file.arrayBuffer(),zip=new PizZip(arrayBuffer),xmlString=zip.file("word/document.xml").asText(),parser=new DOMParser,xmlDoc=parser.parseFromString(xmlString,"text/xml"),relsFile=zip.file("word/_rels/document.xml.rels");if(xmlDoc.getElementsByTagName("parsererror").length)throw new Error("XML parsing error");docInfo={originalZip:zip,originalRels:relsFile?parser.parseFromString(relsFile.asText(),"text/xml"):null,bodyChildren:Array.from(xmlDoc.getElementsByTagName("w:body")[0].children),sections:xmlDoc.getElementsByTagName("w:sectPr").length,pageBreaks:xmlDoc.querySelectorAll('br[w\\:type="page"]').length},document.getElementById('split-file-name').textContent=file.name,document.getElementById('detected-sections').textContent=docInfo.sections,document.getElementById('detected-page-breaks').textContent=docInfo.pageBreaks,analysisSection.classList.remove('hidden'),setLoading(!1,'执行分割')}catch(error){console.error("文件分析失败:",error),resetSplitter(!0)}}async function executeSplit(){const mode=document.querySelector('input[name="split-mode"]:checked')?.value;if(!mode)return void showError("请选择一种分割模式。");if(!docxFile||!docInfo.originalZip)return void showError("文件未加载成功，请重新上传。");setLoading(!0,'处理中...'),setTimeout(async()=>{try{'section'===mode?await function(){let currentSectionNodes=[],sectionIndex=1;docInfo.bodyChildren.forEach(child=>{currentSectionNodes.push(child),'w:sectPr'===child.tagName&&(createNewDocx(currentSectionNodes,`${docxFile.name.replace('.docx','')}_section_${sectionIndex++}.docx`),currentSectionNodes=[])}),currentSectionNodes.length>0&&createNewDocx(currentSectionNodes,`${docxFile.name.replace('.docx','')}_section_${sectionIndex++}.docx`)}():await function(rangeString,singleMode){let pageChunks=[],currentPageNodes=[];if(docInfo.bodyChildren.forEach(child=>{currentPageNodes.push(child),child.querySelector('br[w\\:type="page"]')&&(pageChunks.push(currentPageNodes),currentPageNodes=[])}),currentPageNodes.length>0&&pageChunks.push(currentPageNodes),singleMode){if(0===pageChunks.length)throw new Error("未检测到手动分页符，无法逐页分割。");pageChunks.forEach((chunk,i)=>{createNewDocx(chunk,`${docxFile.name.replace('.docx','')}_page_${i+1}.docx`)})}else{if(!rangeString)throw new Error("请输入分页符范围。");const ranges=rangeString.split(',').map(r=>r.trim().split('-').map(Number));let combinedNodes=[];ranges.forEach(([start,end])=>{end=end||start;for(let i=start-1;i<end&&i<pageChunks.length;i++)combinedNodes.push(...pageChunks[i])}),combinedNodes.length>0?createNewDocx(combinedNodes,`${docxFile.name.replace('.docx','')}_pages_${rangeString.replace(/,/g,'_')}.docx`):showError("指定的范围无效或未找到内容。")}}(('page'===mode?document.getElementById('page-range-input').value:null),'single'===mode)}catch(err){console.error("分割失败:",err),showError(err.message)}finally{setLoading(!1,'执行分割')}},50)}function createNewDocx(nodes,fileName){const bodyContent=nodes.map(node=>node.outerHTML).join(''),requiredRids=new Set,relRegex=/(?:r:embed|r:id|r:link)="([^"]+)"/g;let match;for(;"null"!==(match=relRegex.exec(bodyContent));)requiredRids.add(match[1]);const newZip=new PizZip;Object.keys(docInfo.originalZip.files).forEach(path=>{path.startsWith('word/media')||path.includes('document.xml')||newZip.file(path,docInfo.originalZip.files[path].asNodeBuffer())});let newRelsContent='';if(docInfo.originalRels){requiredRids.forEach(rId=>{const relNode=docInfo.originalRels.querySelector(`Relationship[Id="${rId}"]`);if(relNode){newRelsContent+=relNode.outerHTML;const target=relNode.getAttribute('Target');if(!target.startsWith('http')){const mediaPath='word/'+target;docInfo.originalZip.file(mediaPath)&&newZip.file(mediaPath,docInfo.originalZip.files[mediaPath].asNodeBuffer())}}})}newZip.file('word/_rels/document.xml.rels',`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">${newRelsContent}</Relationships>`);const sectPr=docInfo.bodyChildren.find(node=>'w:sectPr'===node.tagName)?.outerHTML||docInfo.bodyChildren[docInfo.bodyChildren.length-1].outerHTML;newZip.file("word/document.xml",`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:document xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:wp14="http://schemas.microsoft.com/office/word/2010/wordprocessingDrawing" xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing" xmlns:w10="urn:schemas-microsoft-com:office:word" xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml" xmlns:w16cid="http://schemas.microsoft.com/office/word/2016/wordml/cid" xmlns:w16se="http://schemas.microsoft.com/office/word/2015/wordml/symex" mc:Ignorable="w14 w15 w16se w16cid wp14"><w:body>${bodyContent}${sectPr}</w:body></w:document>`);const blob=newZip.generate({type:"blob",mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}),link=document.createElement('a');link.href=URL.createObjectURL(blob),link.download=fileName,link.click(),URL.revokeObjectURL(link.href)}dropZone.addEventListener('click',()=>fileInput.click()),fileInput.addEventListener('change',handleFile),dropZone.addEventListener('dragover',e=>{e.preventDefault(),dropZone.classList.add('border-indigo-500','bg-indigo-50')}),dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('border-indigo-500','bg-indigo-50')),dropZone.addEventListener('drop',e=>{e.preventDefault(),dropZone.classList.remove('border-indigo-500','bg-indigo-50'),e.dataTransfer.files.length&&handleFile({target:{files:e.dataTransfer.files}})}),splitButton.addEventListener('click',executeSplit)}
    </script>
</body>
</html>