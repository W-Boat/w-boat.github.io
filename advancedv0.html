<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>阅读控制器</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --ease-out-quint: cubic-bezier(0.22, 1, 0.36, 1);
            --ease-in-out-cubic: cubic-bezier(0.65, 0, 0.35, 1);

            --bg-color: #121212;
            --card-color: #1e1e1e;
            --primary-text-color: #e1e1e1;
            --secondary-text-color: #8b8b8b;
            --accent-color: #00bcd4;
            --accent-glow: rgba(0, 188, 212, 0.3);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --success-color: #4CAF50;
            --error-color: #F44336;
            --warn-color: #e53935;
            --warn-confirm-color: #ff9800;
        }

        html[data-theme='light'] {
            --bg-color: #f0f2f5;
            --card-color: #ffffff;
            --primary-text-color: #1f2937;
            --secondary-text-color: #6b7280;
            --accent-color: #0097a7;
            --accent-glow: rgba(0, 151, 167, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-family: 'Noto Sans SC', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        body {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 100vh; background-color: var(--bg-color); color: var(--primary-text-color);
            transition: background-color 0.4s, color 0.4s; -webkit-tap-highlight-color: transparent;
            padding: 20px 0;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animated { animation: fadeInUp 0.8s var(--ease-out-quint) both; }

        .theme-toggle-container { position: fixed; top: 15px; right: 15px; z-index: 101; }
        .theme-toggle {
            cursor: pointer; width: 48px; height: 48px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; background-color: var(--card-color);
            box-shadow: 0 4px 12px var(--shadow-color); transition: all 0.3s ease;
        }
        .theme-toggle:active { transform: scale(0.9); }
        .theme-toggle input { display: none; }
        .theme-toggle .icon { color: var(--primary-text-color); transition: all 0.5s cubic-bezier(.18,.89,.32,1.28); }
        .theme-toggle .sun { transform: scale(1) rotate(0deg); }
        html[data-theme='dark'] .theme-toggle .sun { transform: scale(0) rotate(-90deg); }
        .theme-toggle .moon { position: absolute; transform: scale(0) rotate(90deg); }
        html[data-theme='dark'] .theme-toggle .moon { transform: scale(1) rotate(0deg); }

        main { width: 100%; max-width: 800px; padding: 20px; text-align: center; }
        main[data-mode="kobo"] .koreader-only { display: none !important; }
        main[data-mode="koreader"] .kobo-only { display: none !important; }
        
        h1 { font-weight: 700; font-size: 2.25rem; }
        
        .title-container {
            display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 8px;
        }
        .lock-theme-btn {
            background: none; border: none; cursor: pointer; color: var(--secondary-text-color);
            padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
        }
        .lock-theme-btn.locked, .lock-theme-btn:hover { color: var(--accent-color); }
        .lock-theme-btn .svg-icon { width: 24px; height: 24px; }
        
        #theme-info { margin-bottom: 20px; animation-delay: 0.15s; }
        #theme-info .name { font-size: 1.1rem; font-weight: 500; color: var(--primary-text-color); margin-bottom: 4px; }
        #theme-info .description { font-size: 0.8rem; color: var(--secondary-text-color); }
        
        .mode-switcher {
            display: inline-flex; position: relative; background-color: color-mix(in srgb, var(--card-color) 50%, var(--bg-color));
            border-radius: 12px; padding: 4px; margin-bottom: 24px; animation-delay: 0.2s;
        }
        .mode-switcher .glider {
            position: absolute; top: 4px; height: calc(100% - 8px); width: 100px;
            background-color: var(--card-color); border-radius: 9px;
            box-shadow: 0 2px 8px -2px var(--shadow-color);
            transition: transform 0.4s var(--ease-in-out-cubic);
        }
        .mode-switcher button {
            background: none; border: none; color: var(--secondary-text-color); font-size: 0.9rem; font-weight: 500;
            padding: 10px 20px; width: 100px; cursor: pointer; position: relative; z-index: 1;
            transition: color 0.4s var(--ease-in-out-cubic);
        }
        .mode-switcher button.active { color: var(--primary-text-color); }

        .ip-form { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 35px; animation-delay: 0.3s; }
        .ip-input {
            background-color: var(--card-color); border: 1px solid color-mix(in srgb, var(--secondary-text-color) 40%, transparent);
            border-radius: 12px; padding: 14px 18px; color: var(--primary-text-color); font-size: 1rem; width: 220px;
            transition: all 0.3s var(--ease-in-out-cubic);
        }
        .ip-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 4px var(--accent-glow); }
        .save-btn {
            background-image: linear-gradient(135deg, var(--accent-color) 0%, color-mix(in srgb, var(--accent-color) 80%, black) 100%);
            border: none; border-radius: 12px; padding: 14px 22px; color: #fff; font-size: 1rem; font-weight: 500; cursor: pointer;
            transition: all 0.3s var(--ease-in-out-cubic); box-shadow: 0 4px 15px -5px color-mix(in srgb, var(--accent-color) 60%, transparent);
        }
        .save-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px -5px var(--accent-color); }
        .save-btn:active { transform: translateY(0) scale(0.95); }

        .controls { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-bottom: 35px; animation-delay: 0.4s; }
        .control-card {
            width: 260px; height: 190px; background-color: var(--card-color); border-radius: 24px;
            display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; user-select: none;
            box-shadow: 0 10px 30px -10px var(--shadow-color); position: relative; overflow: hidden;
            transition: all 0.4s var(--ease-out-quint);
        }
        
        main:not([data-click-effect="ripple"]) .control-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(circle at 50% -20%, var(--accent-glow), transparent 70%);
            opacity: 0; transition: opacity 0.5s var(--ease-out-quint);
        }
        main:not([data-click-effect="ripple"]) .control-card:hover::before { opacity: 1; }
        
        .control-card .ripple {
            position: absolute; background: var(--accent-glow); border-radius: 50%;
            transform: scale(0); animation: ripple-effect 0.6s linear; pointer-events: none;
        }
        @keyframes ripple-effect { to { transform: scale(4); opacity: 0; } }

        .control-card:hover { transform: translateY(-12px); box-shadow: 0 20px 40px -15px var(--shadow-color); }
        .control-card:active { transform: translateY(-4px) scale(0.97); transition-duration: 0.1s; }
        .card-icon { color: var(--accent-color); z-index: 1;}
        .card-text { font-size: 1.5rem; font-weight: 400; margin-top: 15px; z-index: 1;}
        
        .divider { width: 80%; max-width: 400px; height: 1px; background-color: color-mix(in srgb, var(--secondary-text-color) 40%, transparent); margin: 0 auto 30px; animation-delay: 0.5s; }

        .slider-controls { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; padding: 0 20px; animation-delay: 0.55s; }
        .slider-container { display: flex; align-items: center; gap: 15px; }
        .slider-container .svg-icon { color: var(--secondary-text-color); flex-shrink: 0; }
        .slider-container input[type="range"] {
            -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background-color: color-mix(in srgb, var(--secondary-text-color) 25%, transparent);
            border-radius: 4px; outline: none; transition: background-color 0.3s;
        }
        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background-color: var(--accent-color);
            border-radius: 50%; cursor: pointer; box-shadow: 0 0 8px var(--accent-glow);
        }
        .slider-container input[type="range"]::-moz-range-thumb {
            width: 20px; height: 20px; background-color: var(--accent-color); border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 8px var(--accent-glow); border: none;
        }

        .function-area {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; animation-delay: 0.6s;
            transition: opacity 0.4s, transform 0.4s;
        }
        .function-btn {
            display: flex; align-items: center; gap: 8px; background-color: transparent;
            border: 1px solid color-mix(in srgb, var(--secondary-text-color) 50%, transparent);
            color: var(--secondary-text-color); border-radius: 12px; padding: 10px 18px; font-size: 0.875rem;
            cursor: pointer; transition: all 0.3s var(--ease-in-out-cubic);
        }
        .function-btn:hover { color: var(--accent-color); border-color: var(--accent-color); background-color: var(--accent-glow); transform: translateY(-2px); }
        .function-btn:active { transform: scale(0.95) translateY(0); }
        .function-btn.toggled-on {
            color: var(--accent-color);
            border-color: var(--accent-color);
            background-color: var(--accent-glow);
        }

        .function-btn.warn-btn { border-color: color-mix(in srgb, var(--warn-color) 50%, transparent); color: var(--warn-color); }
        .function-btn.warn-btn:hover { border-color: var(--warn-color); background-color: color-mix(in srgb, var(--warn-color) 15%, transparent); }
        
        .function-btn.confirm-state {
            border-color: var(--warn-confirm-color) !important; color: var(--warn-confirm-color) !important;
            background-color: color-mix(in srgb, var(--warn-confirm-color) 15%, transparent) !important;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.03);} 100% {transform: scale(1);} }
        
        .svg-icon { width: 1.2em; height: 1.2em; vertical-align: middle; }

        .status-message {
            position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 150%); padding: 12px 25px;
            border-radius: 12px; font-size: 1rem; font-weight: 500; color: #fff; opacity: 0; visibility: hidden;
            transition: all 0.5s var(--ease-in-out-cubic); z-index: 1000;
        }
        .status-message.show { opacity: 1; visibility: visible; transform: translate(-50%, 0); }
        .status-message.success { background-color: var(--success-color); }
        .status-message.error { background-color: var(--error-color); }
        
        footer { margin-top: 20px; padding: 10px; font-size: 0.75rem; color: var(--secondary-text-color); text-align: center; animation-delay: 0.7s; }

        /* Settings Modal */
        #settingsModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        #settingsModal.show { opacity: 1; visibility: visible; }
        .settings-content {
            background-color: var(--card-color); color: var(--primary-text-color); width: 90%; max-width: 600px; max-height: 85vh;
            border-radius: 20px; box-shadow: 0 10px 40px var(--shadow-color); padding: 25px;
            transform: scale(0.95); transition: transform 0.3s var(--ease-out-quint); text-align: left;
            display: flex; flex-direction: column;
        }
        #settingsModal.show .settings-content { transform: scale(1); }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .settings-header h2 { font-size: 1.5rem; }
        .settings-close-btn { background: none; border: none; font-size: 2rem; color: var(--secondary-text-color); cursor: pointer; }
        .settings-body { overflow-y: auto; padding-right: 15px; }
        .settings-section { margin-bottom: 30px; }
        .settings-section h3 { font-size: 1.1rem; color: var(--accent-color); margin-bottom: 15px; border-bottom: 1px solid var(--accent-glow); padding-bottom: 8px;}
        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 8px; font-weight: 500; color: var(--secondary-text-color); }
        .settings-input {
            background-color: var(--bg-color); border: 1px solid color-mix(in srgb, var(--secondary-text-color) 40%, transparent);
            border-radius: 8px; padding: 10px 14px; color: var(--primary-text-color); font-size: 0.9rem;
            transition: all 0.3s var(--ease-in-out-cubic);
        }
        .settings-input:focus { outline: none; border-color: var(--accent-color); }
        .function-lists { display: flex; gap: 20px; }
        .function-list-container { flex: 1; }
        .function-list { min-height: 200px; background: var(--bg-color); border-radius: 8px; padding: 10px; list-style-type: none; }
        .function-list li {
            padding: 10px; background: var(--card-color); border-radius: 6px; margin-bottom: 8px; cursor: move;
            display: flex; align-items: center; gap: 8px;
            border: 1px solid transparent; transition: border-color 0.2s;
        }
        .function-list li.sortable-ghost { opacity: 0.4; background: var(--accent-glow); }
        .function-list .svg-icon { color: var(--secondary-text-color); }
    </style>
</head>
<body>
    <div class="theme-toggle-container">
        <label class="theme-toggle" for="themeToggleCheckbox" aria-label="切换主题">
            <input type="checkbox" id="themeToggleCheckbox">
            <svg class="svg-icon sun icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            <svg class="svg-icon moon icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </label>
    </div>

    <main id="mainContent" data-mode="koreader">
        <div class="title-container animated">
             <h1 class="animated">阅读控制器</h1>
             <button id="lockThemeBtn" class="lock-theme-btn animated" aria-label="锁定/解锁主题色">
                <svg id="lockIcon" class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                <svg id="unlockIcon" class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>
             </button>
        </div>
        
        <div id="theme-info" class="animated">
            <h3 class="name"></h3>
            <p class="description"></p>
        </div>
        
        <div class="mode-switcher animated">
            <div class="glider"></div>
            <button id="modeBtnKoreader" class="active">KOReader</button>
            <button id="modeBtnKobo">Kobo</button>
        </div>

        <form id="ipForm" class="ip-form animated" onsubmit="event.preventDefault();">
            <input type="text" id="ipInput" class="ip-input" placeholder="输入设备IP地址" autocomplete="off">
            <button type="submit" id="saveBtn" class="save-btn">保存</button>
        </form>

        <div class="controls animated">
            <div class="control-card" data-action="prev" data-success-msg="‹ 上一页">
                <div class="card-icon"><svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></div>
                <div class="card-text">上一页</div>
            </div>
            <div class="control-card" data-action="next" data-success-msg="下一页 ›">
                <div class="card-icon"><svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                <div class="card-text">下一页</div>
            </div>
        </div>
        
        <div class="divider animated"></div>
        
        <div id="sliderControls" class="slider-controls animated koreader-only"></div>

        <div id="functionArea" class="function-area animated">
            <!-- Dynamically generated buttons will go here -->
        </div>
    </main>

    <div id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <h2>控制器设置</h2>
                <button class="settings-close-btn">&times;</button>
            </div>
            <div class="settings-body">
                <div class="settings-section">
                    <h3>网络设置 (KOReader)</h3>
                    <div class="form-group">
                        <label for="koreaderPortInput">KOReader 端口</label>
                        <input type="number" id="koreaderPortInput" class="settings-input" placeholder="默认 8080">
                    </div>
                </div>
                <div class="settings-section">
                    <h3>功能按钮管理 (KOReader)</h3>
                    <p style="font-size: 0.8rem; color: var(--secondary-text-color); margin-bottom: 15px;">从左侧拖动到右侧以添加功能按钮，在右侧排序。最多添加6个。</p>
                    <div class="function-lists">
                        <div class="function-list-container">
                            <h4>可用功能</h4>
                            <ul id="available-functions" class="function-list"></ul>
                        </div>
                        <div class="function-list-container">
                            <h4>当前功能 (最多6个)</h4>
                            <ul id="active-functions" class="function-list"></ul>
                        </div>
                    </div>
                </div>
                <!-- Custom actions can be added here in the future -->
            </div>
             <div class="settings-footer" style="text-align: right; margin-top: 20px;">
                <button id="saveSettingsBtn" class="save-btn">保存并关闭</button>
            </div>
        </div>
    </div>

    <footer id="footer" class="animated"></footer>
    <div id="statusMessage" class="status-message"></div>

    <script>
       const traditionalColors = [{"name":"春日樱花","description":"灵感来自春天盛开的樱花，温柔而浪漫","colors":[{"name":"粉红","hex":"#FFB3B3"},{"name":"素白","hex":"#FFFFFF"},{"name":"青竹","hex":"#95B89C"},{"name":"浅紫","hex":"#E6D4E8"}],"category":"四季"},{"name":"江南水乡","description":"传统水墨画中的江南意境","colors":[{"name":"墨黑","hex":"#2C3135"},{"name":"青瓦","hex":"#5D7B8B"},{"name":"粉墙","hex":"#F5F0E6"},{"name":"苔绿","hex":"#8B9E77"}],"category":"山水"},{"name":"元宵佳节","description":"元宵节的喜庆与温馨","colors":[{"name":"灯笼红","hex":"#FF4D4D"},{"name":"金黄","hex":"#FFD700"},{"name":"紫色","hex":"#9B4F96"},{"name":"月白","hex":"#F2ECDE"}],"category":"节日"},{"name":"竹林清韵","description":"竹林深处的宁静与清雅","colors":[{"name":"竹青","hex":"#789262"},{"name":"竹白","hex":"#F0F5E5"},{"name":"墨绿","hex":"#2C4A3E"},{"name":"茶褐","hex":"#6B4423"}],"category":"山水"},{"name":"秋日金黄","description":"秋天的金黄与温暖","colors":[{"name":"秋叶金","hex":"#DAA520"},{"name":"枫红","hex":"#8B2323"},{"name":"橙褐","hex":"#CD853F"},{"name":"暖棕","hex":"#8B4513"}],"category":"四季"},{"name":"中秋月夜","description":"中秋佳节的皓月清辉","colors":[{"name":"月白","hex":"#E9E7EF"},{"name":"深蓝","hex":"#1C2841"},{"name":"桂花黄","hex":"#FFC773"},{"name":"青灰","hex":"#7D8B99"}],"category":"节日"},{"name":"碧海青天","description":"碧蓝的大海与晴朗的天空","colors":[{"name":"海蓝","hex":"#1E90FF"},{"name":"天青","hex":"#87CEFA"},{"name":"沙黄","hex":"#F4A460"},{"name":"白浪","hex":"#FFFFFF"}],"category":"山水"},{"name":"莲池清影","description":"莲花盛开的池塘，清新怡人","colors":[{"name":"莲红","hex":"#FF69B4"},{"name":"池蓝","hex":"#00BFFF"},{"name":"荷绿","hex":"#32CD32"},{"name":"泥褐","hex":"#8B4513"}],"category":"花卉"},{"name":"紫禁宫韵","description":"紫禁城的皇家色彩与庄严","colors":[{"name":"紫禁红","hex":"#8B0000"},{"name":"宫廷金","hex":"#FFD700"},{"name":"玉蓝","hex":"#4169E1"},{"name":"御灰","hex":"#696969"}],"category":"建筑"},{"name":"青花瓷韵","description":"青花瓷的经典蓝白配色","colors":[{"name":"青花蓝","hex":"#0000CD"},{"name":"瓷白","hex":"#F0F8FF"},{"name":"墨黑","hex":"#000000"},{"name":"釉灰","hex":"#708090"}],"category":"艺术"},{"name":"红楼梦境","description":"《红楼梦》中的古典色彩","colors":[{"name":"黛青","hex":"#5D8AA8"},{"name":"绛紫","hex":"#8B008B"},{"name":"烟白","hex":"#F5F5F5"},{"name":"琥珀黄","hex":"#FFBF00"}],"category":"文化"}, {"name": "水墨丹青", "description": "水墨画中的淡雅色彩", "colors": [{ "name": "墨黑", "hex": "#2F3542" }, { "name": "丹朱", "hex": "#FF4500" }, { "name": "云灰", "hex": "#B0C4DE" }, { "name": "雪白", "hex": "#FFFFFF" }], "category": "艺术" }];
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- App State & Constants ---
            let currentIp = '';
            let currentMode = 'koreader';
            let statusTimeout;
            let koboExitConfirm = false;
            let koboExitTimeout;
            let themeColorLocked = false;
            let currentThemeIndex = 0;
            let currentClickEffect = 'glow';
            let userSettings = {};

            const ALL_FUNCTIONS = {
                brightness: { id: 'brightness', name: '亮度', type: 'slider', event: '/koreader/event/SetFlIntensity/', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41m11.32-11.32l1.41-1.41"></path></svg>` },
                warmth: { id: 'warmth', name: '色温', type: 'slider', event: '/koreader/event/SetFlWarmth/', svg: `<svg class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 4.5V16a2 2 0 0 1-2 2h0a2 2 0 0 1-2-2V4.5a2.5 2.5 0 0 1 2-2.5h0a2.5 2.5 0 0 1 2 2.5z"></path><path d="M9 11h6"></path><path d="M9 14h6"></path></svg>` },
                toc: { id: 'toc', name: '目录', type: 'button', event: '/koreader/event/ShowToc', msg: '已发送目录请求', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>` },
                refresh: { id: 'refresh', name: '刷新', type: 'button', event: '/koreader/event/FullRefresh', msg: '已发送刷新命令', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>` },
                night_mode: { id: 'night_mode', name: '夜间模式', type: 'toggle', event: '/koreader/event/ToggleNightMode', msg: '已切换夜间模式', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>` },
                file_manager: { id: 'file_manager', name: '文件管理', type: 'button', event: '/koreader/event/Home', msg: '已打开文件管理器', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>` },
                last_doc: { id: 'last_doc', name: '最近阅读', type: 'button', event: '/koreader/event/OpenLastDoc', msg: '已打开最近文档', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h9.5Z"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M9.5 13.5a2.5 2.5 0 0 1-5 0 2.5 2.5 0 0 1 5 0Z"></path><path d="M17 13.5a2.5 2.5 0 0 1-5 0 2.5 2.5 0 0 1 5 0Z"></path></svg>` },
                suspend: { id: 'suspend', name: '睡眠', type: 'button', event: '/koreader/event/RequestSuspend', msg: '已发送睡眠请求', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="M9.71 16.29a1 1 0 0 0 1.41-1.41L9.41 13H16a1 1 0 0 0 0-2h-6.59l1.71-1.71a1 1 0 0 0-1.42-1.42l-3 3a1 1 0 0 0 0 1.42l3 3.01z"></path></svg>` },
                usb_mode: { id: 'usb_mode', name: 'USB模式', type: 'button', event: '/koreader/event/RequestUSBMS', msg: '已请求USB模式', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 12V3.5A2.5 2.5 0 0 1 14.5 1h0A2.5 2.5 0 0 1 17 3.5V12"></path><path d="M12 12V3.5A2.5 2.5 0 0 0 9.5 1h0A2.5 2.5 0 0 0 7 3.5V12"></path><path d="M12 12h5.5a2.5 2.5 0 0 1 0 5H12"></path><path d="M12 12h-5.5a2.5 2.5 0 0 0 0 5H12"></path><path d="M12 17v4"></path><path d="M10 21h4"></path></svg>` },
                toggle_bookmark: { id: 'toggle_bookmark', name: '添加书签', type: 'button', event: '/koreader/event/ToggleBookmark', msg: '已添加/取消书签', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path></svg>` },
                effect_toggle: { id: 'effect_toggle', name: '点击效果', type: 'button', event: 'local_toggle_effect', msg: '', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2z"></path><path d="M12 17a3 3 0 1 0-3-3"></path></svg>` },
                settings: { id: 'settings', name: '设置', type: 'button', event: 'local_open_settings', msg: '', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>` },
                kobo_exit: { id: 'kobo_exit', name: '关闭服务', type: 'button', warn: true, event: '/exit', msg: '已发送关闭服务器命令', svg: `<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 3H6a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h4M16 17l5-5-5-5M19.8 12H9"></path></svg>` }
            };

            // --- DOM Elements ---
            const getEl = (id) => document.getElementById(id);
            const mainContent = getEl('mainContent');
            const ipInput = getEl('ipInput');
            const statusMessage = getEl('statusMessage');
            const themeToggleCheckbox = getEl('themeToggleCheckbox');
            const modeBtnKoreader = getEl('modeBtnKoreader');
            const modeBtnKobo = getEl('modeBtnKobo');
            const glider = document.querySelector('.mode-switcher .glider');
            const footer = getEl('footer');
            const lockThemeBtn = getEl('lockThemeBtn');
            const lockIcon = getEl('lockIcon');
            const unlockIcon = getEl('unlockIcon');
            const themeInfoName = document.querySelector('#theme-info .name');
            const themeInfoDesc = document.querySelector('#theme-info .description');
            const functionArea = getEl('functionArea');
            const sliderControls = getEl('sliderControls');
            const settingsModal = getEl('settingsModal');
            const koreaderPortInput = getEl('koreaderPortInput');
            const availableFuncList = getEl('available-functions');
            const activeFuncList = getEl('active-functions');

            // --- Utility Functions ---
            const showStatus = (message, type, duration = 2500) => {
                clearTimeout(statusTimeout);
                statusMessage.textContent = message;
                statusMessage.className = `status-message ${type} show`;
                statusTimeout = setTimeout(() => statusMessage.classList.remove('show'), duration);
            };

            const debounce = (func, delay) => {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            };

            // --- Core Logic ---
            const sendRequest = async (endpoint, successMsg) => {
                if (!currentIp) { showStatus('请先输入并保存IP地址！', 'error'); ipInput.focus(); return; }
                
                let port = (currentMode === 'koreader') ? `:${userSettings.koreaderPort || 8080}` : ':80';
                
                try {
                    // Send a dummy event to prevent auto-suspend in KOReader
                    if (currentMode === 'koreader') {
                        fetch(`http://${currentIp}${port}/koreader/broadcast/InputEvent`, { mode: 'no-cors', cache: 'no-cache' });
                    }
                    await fetch(`http://${currentIp}${port}${endpoint}`, { mode: 'no-cors', cache: 'no-cache' });
                    if (successMsg) showStatus(successMsg, 'success');
                } catch (error) {
                    console.error('Request failed:', error);
                    showStatus('请求失败！请检查IP、网络及设备服务。', 'error');
                }
            };

            const debouncedSendRequest = debounce(sendRequest, 200);

            const saveIp = () => {
                const ip = ipInput.value.trim();
                if (/^(\d{1,3}\.){3}\d{1,3}$/.test(ip)) {
                    currentIp = ip; localStorage.setItem('reader_controller_ip', ip);
                    showStatus(`IP地址已保存: ${currentIp}`, 'success');
                } else { showStatus('请输入有效的IP地址', 'error'); }
            };

            const hexToHsl = (hex) => {
                let r = 0, g = 0, b = 0;
                if (hex.length == 4) { r = "0x" + hex[1] + hex[1]; g = "0x" + hex[2] + hex[2]; b = "0x" + hex[3] + hex[3]; } 
                else if (hex.length == 7) { r = "0x" + hex[1] + hex[2]; g = "0x" + hex[3] + hex[4]; b = "0x" + hex[5] + hex[6]; }
                r /= 255; g /= 255; b /= 255;
                let cmin = Math.min(r,g,b), cmax = Math.max(r,g,b), delta = cmax - cmin, h = 0, s = 0, l = 0;
                if (delta == 0) h = 0;
                else if (cmax == r) h = ((g - b) / delta) % 6;
                else if (cmax == g) h = (b - r) / delta + 2;
                else h = (r - g) / delta + 4;
                h = Math.round(h * 60);
                if (h < 0) h += 360;
                l = (cmax + cmin) / 2;
                s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
                s = +(s * 100).toFixed(1); l = +(l * 100).toFixed(1);
                return `hsl(${h},${s}%,${l}%)`;
            }
            
            const applyTraditionalColor = (themeIndex) => {
                const theme = traditionalColors[themeIndex];
                if (!theme) return;
                const accentColor = theme.colors[0].hex;
                const accentHsl = hexToHsl(accentColor);
                const accentGlow = accentHsl.replace('hsl(', 'hsla(').replace(')', `, 0.3)`);
                document.documentElement.style.setProperty('--accent-color', accentColor);
                document.documentElement.style.setProperty('--accent-glow', accentGlow);
                themeInfoName.textContent = theme.name;
                themeInfoDesc.textContent = theme.description;
                currentThemeIndex = themeIndex;
                if(!themeColorLocked) localStorage.setItem('reader_controller_theme_index', themeIndex);
            };
            
            const setRandomTraditionalColor = () => {
                if (themeColorLocked) return;
                const randomIndex = Math.floor(Math.random() * traditionalColors.length);
                applyTraditionalColor(randomIndex);
            };

            const toggleThemeLock = () => {
                themeColorLocked = !themeColorLocked;
                localStorage.setItem('reader_controller_theme_locked', themeColorLocked);
                updateLockIcon();
                if (themeColorLocked) {
                    localStorage.setItem('reader_controller_locked_index', currentThemeIndex);
                    showStatus('主题色已锁定', 'success', 1500);
                } else {
                    localStorage.removeItem('reader_controller_locked_index');
                    showStatus('主题色已解锁', 'success', 1500);
                    setRandomTraditionalColor();
                }
            };

            const updateLockIcon = () => {
                lockThemeBtn.classList.toggle('locked', themeColorLocked);
                unlockIcon.style.display = themeColorLocked ? 'block' : 'none';
                lockIcon.style.display = themeColorLocked ? 'none' : 'block';
            };

            const applyTheme = (theme) => {
                document.documentElement.setAttribute('data-theme', theme);
                themeToggleCheckbox.checked = theme === 'dark';
                localStorage.setItem('reader_controller_theme_mode', theme);
            };

            const applyMode = (mode) => {
                currentMode = mode; mainContent.setAttribute('data-mode', mode);
                const isKoreader = mode === 'koreader';
                modeBtnKoreader.classList.toggle('active', isKoreader);
                modeBtnKobo.classList.toggle('active', !isKoreader);
                glider.style.transform = isKoreader ? 'translateX(0)' : 'translateX(100px)';
                footer.textContent = isKoreader 
                    ? '提示：请确保KOReader已开启“HTTP调试服务器”。'
                    : '提示：请确保Kobo已启动内置翻页HTTP服务器。';
                localStorage.setItem('reader_controller_device_mode', mode);
            };
            
            const applyClickEffect = (effect) => {
                currentClickEffect = effect;
                mainContent.setAttribute('data-click-effect', effect);
                const btn = document.querySelector('[data-id="effect_toggle"] .btn-text');
                if (btn) btn.textContent = `效果: ${effect === 'ripple' ? '涟漪' : '辉光'}`;
                localStorage.setItem('reader_controller_click_effect', effect);
            };

            const handleSpecialAction = (actionId) => {
                 if (actionId === 'local_toggle_effect') {
                    applyClickEffect(currentClickEffect === 'glow' ? 'ripple' : 'glow');
                    showStatus(`点击效果已切换为: ${currentClickEffect === 'ripple' ? '涟漪' : '辉光'}`, 'success', 1500);
                } else if (actionId === 'local_open_settings') {
                    openSettingsModal();
                }
            };
            
            const handleKoboExit = (btn) => {
                 if (!koboExitConfirm) {
                    koboExitConfirm = true;
                    const originalText = btn.querySelector('.btn-text').textContent;
                    btn.querySelector('.btn-text').textContent = "再次点击确认";
                    btn.classList.add('confirm-state');
                    clearTimeout(koboExitTimeout);
                    koboExitTimeout = setTimeout(() => {
                        btn.querySelector('.btn-text').textContent = originalText;
                        btn.classList.remove('confirm-state');
                        koboExitConfirm = false;
                    }, 4000);
                } else {
                    clearTimeout(koboExitTimeout);
                    sendRequest(btn.dataset.action, btn.dataset.successMsg);
                    btn.querySelector('.btn-text').textContent = "关闭服务";
                    btn.classList.remove('confirm-state');
                    koboExitConfirm = false;
                }
            }
            
            const renderFunctionArea = () => {
                functionArea.innerHTML = '';
                sliderControls.innerHTML = '';

                let activeFunctions = userSettings.activeFunctions || [];
                
                // KOReader specific functions
                if(currentMode === 'koreader') {
                    activeFunctions.forEach(funcId => {
                        const func = ALL_FUNCTIONS[funcId];
                        if(!func) return;

                        if (func.type === 'slider') {
                            const sliderContainer = document.createElement('div');
                            sliderContainer.className = 'slider-container koreader-only';
                            sliderContainer.innerHTML = `
                                ${func.svg}
                                <input type="range" min="0" max="100" value="50" data-action="${func.event}" aria-label="${func.name}">
                            `;
                            sliderControls.appendChild(sliderContainer);
                            const sliderInput = sliderContainer.querySelector('input');
                            sliderInput.addEventListener('input', (e) => {
                                debouncedSendRequest(`${e.target.dataset.action}${e.target.value}`);
                            });
                        } else {
                             const btn = document.createElement('button');
                             btn.className = 'function-btn koreader-only';
                             btn.dataset.id = func.id;
                             btn.dataset.action = func.event;
                             btn.dataset.successMsg = func.msg || '';
                             btn.innerHTML = `${func.svg}<span class="btn-text">${func.name}</span>`;

                             if (func.type === 'toggle') {
                                btn.classList.toggle('toggled-on', userSettings.toggles[func.id]);
                                btn.addEventListener('click', () => {
                                    userSettings.toggles[func.id] = !userSettings.toggles[func.id];
                                    btn.classList.toggle('toggled-on', userSettings.toggles[func.id]);
                                    localStorage.setItem('reader_controller_settings', JSON.stringify(userSettings));
                                    sendRequest(func.event, func.msg);
                                });
                             } else {
                                btn.addEventListener('click', () => {
                                    if (func.event.startsWith('local_')) handleSpecialAction(func.event);
                                    else sendRequest(func.event, func.msg);
                                });
                             }
                             functionArea.appendChild(btn);
                        }
                    });
                }
                
                // Always add Settings button
                const settingsFunc = ALL_FUNCTIONS['settings'];
                const settingsBtn = document.createElement('button');
                settingsBtn.className = 'function-btn';
                settingsBtn.innerHTML = `${settingsFunc.svg}<span class="btn-text">${settingsFunc.name}</span>`;
                settingsBtn.addEventListener('click', openSettingsModal);
                functionArea.appendChild(settingsBtn);

                // Add Kobo exit button only in Kobo mode
                const koboExitFunc = ALL_FUNCTIONS['kobo_exit'];
                const koboExitBtn = document.createElement('button');
                koboExitBtn.className = 'function-btn kobo-only warn-btn';
                koboExitBtn.dataset.action = koboExitFunc.event;
                koboExitBtn.dataset.successMsg = koboExitFunc.msg;
                koboExitBtn.innerHTML = `${koboExitFunc.svg}<span class="btn-text">${koboExitFunc.name}</span>`;
                koboExitBtn.addEventListener('click', () => handleKoboExit(koboExitBtn));
                functionArea.appendChild(koboExitBtn);
            };

            // --- Settings Modal Logic ---
            const openSettingsModal = () => {
                koreaderPortInput.value = userSettings.koreaderPort || '8080';
                populateFunctionLists();
                settingsModal.classList.add('show');
            };

            const closeSettingsModal = () => {
                settingsModal.classList.remove('show');
            };
            
            const saveSettings = () => {
                userSettings.koreaderPort = koreaderPortInput.value || '8080';
                const activeIds = Array.from(activeFuncList.querySelectorAll('li')).map(li => li.dataset.id);
                userSettings.activeFunctions = activeIds;
                
                localStorage.setItem('reader_controller_settings', JSON.stringify(userSettings));
                renderFunctionArea();
                showStatus('设置已保存', 'success');
                closeSettingsModal();
            };
            
            const populateFunctionLists = () => {
                availableFuncList.innerHTML = '';
                activeFuncList.innerHTML = '';

                const activeIds = new Set(userSettings.activeFunctions || []);
                Object.values(ALL_FUNCTIONS).forEach(func => {
                    if (['kobo_exit', 'settings'].includes(func.id)) return; // Exclude these from customization
                    const li = document.createElement('li');
                    li.dataset.id = func.id;
                    li.innerHTML = `${func.svg} <span>${func.name}</span>`;
                    if (activeIds.has(func.id)) {
                        activeFuncList.appendChild(li);
                    } else {
                        availableFuncList.appendChild(li);
                    }
                });
            };

            // --- Initialization ---
            const initializeApp = () => {
                // Restore Light/Dark Theme
                const savedTheme = localStorage.getItem('reader_controller_theme_mode') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                applyTheme(savedTheme);

                // Restore IP
                const savedIp = localStorage.getItem('reader_controller_ip');
                if (savedIp) { ipInput.value = savedIp; currentIp = savedIp; setTimeout(() => showStatus(`已加载IP: ${savedIp}`, 'success', 2000), 800); }

                // Restore Kobo/KOReader Mode
                const savedMode = localStorage.getItem('reader_controller_device_mode') || 'koreader';
                applyMode(savedMode);

                // Restore Settings
                const savedSettings = JSON.parse(localStorage.getItem('reader_controller_settings') || '{}');
                userSettings = {
                    koreaderPort: '8080',
                    activeFunctions: ['brightness', 'warmth', 'toc', 'refresh', 'night_mode', 'effect_toggle'],
                    toggles: {},
                    ...savedSettings
                };

                // Restore Click Effect
                const savedEffect = localStorage.getItem('reader_controller_click_effect') || 'glow';
                applyClickEffect(savedEffect);
                
                // Restore Accent Color Theme
                themeColorLocked = localStorage.getItem('reader_controller_theme_locked') === 'true';
                updateLockIcon();
                const lockedIndex = localStorage.getItem('reader_controller_locked_index');
                if (themeColorLocked && lockedIndex) {
                    applyTraditionalColor(parseInt(lockedIndex));
                } else {
                    const savedIndex = localStorage.getItem('reader_controller_theme_index');
                    if (savedIndex) applyTraditionalColor(parseInt(savedIndex));
                    else setRandomTraditionalColor();
                }
                
                renderFunctionArea();

                // BIND EVENT LISTENERS
                themeToggleCheckbox.addEventListener('change', () => applyTheme(themeToggleCheckbox.checked ? 'dark' : 'light'));
                lockThemeBtn.addEventListener('click', toggleThemeLock);
                getEl('ipForm').addEventListener('submit', (e) => { e.preventDefault(); saveIp(); });
                modeBtnKoreader.addEventListener('click', () => { applyMode('koreader'); renderFunctionArea(); });
                modeBtnKobo.addEventListener('click', () => { applyMode('kobo'); renderFunctionArea(); });
                
                document.querySelectorAll('.control-card[data-action]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        let action = btn.dataset.action;
                        let endpoint = '';
                        if (currentMode === 'koreader') {
                            if (action === 'prev') endpoint = '/koreader/event/GotoViewRel/-1';
                            if (action === 'next') endpoint = '/koreader/event/GotoViewRel/1';
                        } else if (currentMode === 'kobo') {
                            if (action === 'prev') endpoint = '/left';
                            if (action === 'next') endpoint = '/right';
                        }
                        sendRequest(endpoint, btn.dataset.successMsg);

                        if (currentClickEffect === 'ripple') {
                             const ripple = document.createElement("span");
                             ripple.classList.add("ripple");
                             const rect = btn.getBoundingClientRect();
                             const size = Math.max(rect.width, rect.height);
                             ripple.style.width = ripple.style.height = size + "px";
                             ripple.style.left = (e.clientX - rect.left - size/2) + "px";
                             ripple.style.top = (e.clientY - rect.top - size/2) + "px";
                             btn.appendChild(ripple);
                             setTimeout(() => ripple.remove(), 600);
                        }
                    });
                });
                
                // Settings Modal Listeners
                document.querySelector('.settings-close-btn').addEventListener('click', closeSettingsModal);
                getEl('saveSettingsBtn').addEventListener('click', saveSettings);

                new Sortable(availableFuncList, {
                    group: 'shared-functions',
                    animation: 150,
                });
                new Sortable(activeFuncList, {
                    group: 'shared-functions',
                    animation: 150,
                    onAdd: function (evt) {
                        if (activeFuncList.children.length > 6) {
                            // Move the item back to the original list
                            availableFuncList.appendChild(evt.item);
                            showStatus('功能按钮最多只能添加6个', 'error');
                        }
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (document.activeElement === ipInput || document.activeElement === koreaderPortInput) return;
                    if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') document.querySelector('.control-card[data-action="prev"]').click();
                    if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') document.querySelector('.control-card[data-action="next"]').click();
                });
            };

            initializeApp();
        });
    </script>
</body>
</html>