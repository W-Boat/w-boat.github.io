<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Markdown Editor Pro</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link id="fontLinkSerif" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link id="fontLinkSans"
        href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">


    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/neo.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/dialog/dialog.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/matchesonscrollbar.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/scroll/simplescrollbars.min.css">

    <link id="hljs-light-theme" rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css">
    <link id="hljs-dark-theme" rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css" media="not all">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" crossorigin="anonymous">

    <style>
        :root {
            --font-family-base: 'Noto Serif SC', serif;
            --font-size-base: 16px;

            --font-serif: var(--font-family-base);
            --font-sans: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;

            --accent-color-custom-light: #d4a373;
            --accent-color-custom-dark: #a98d70;

            --bg-color-light: #fdfaf6;
            --text-color-light: #333;
            --title-color-light: #1a1a1a;
            --meta-color-light: #777;
            --border-color-light: #e0e0e0;
            --secondary-bg-light: #f7f1e9;
            --hover-bg-light: #ede4d9;
            --button-bg-light: #eaddcf;
            --button-text-light: #524030;
            --input-bg-light: #fff;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.07);
            --selection-bg-light-var: rgba(212, 163, 115, 0.4);

            --bg-color-dark: #2c2a2a;
            --text-color-dark: #e0e0e0;
            --title-color-dark: #f5f5f5;
            --meta-color-dark: #aaa;
            --border-color-dark: #444;
            --secondary-bg-dark: #3a3838;
            --hover-bg-dark: #4d4b4b;
            --button-bg-dark: #5c5a5a;
            --button-text-dark: #e0e0e0;
            --input-bg-dark: #333;
            --shadow-dark: 0 4px 15px rgba(0, 0, 0, 0.2);
            --selection-bg-dark-var: rgba(169, 141, 112, 0.4);

            --current-bg-color: var(--bg-color-light);
            --current-text-color: var(--text-color-light);
            --current-title-color: var(--title-color-light);
            --current-meta-color: var(--meta-color-light);
            --current-accent-color: var(--accent-color-custom-light);
            --current-border-color: var(--border-color-light);
            --current-secondary-bg: var(--secondary-bg-light);
            --current-hover-bg: var(--hover-bg-light);
            --current-button-bg: var(--button-bg-light);
            --current-button-text: var(--button-text-light);
            --current-input-bg: var(--input-bg-light);
            --current-shadow: var(--shadow-light);
            --current-selection-bg: var(--selection-bg-light-var);
        }

        body.dark-mode {
            --current-bg-color: var(--bg-color-dark);
            --current-text-color: var(--text-color-dark);
            --current-title-color: var(--title-color-dark);
            --current-meta-color: var(--meta-color-dark);
            --current-accent-color: var(--accent-color-custom-dark);
            --current-border-color: var(--border-color-dark);
            --current-secondary-bg: var(--secondary-bg-dark);
            --current-hover-bg: var(--hover-bg-dark);
            --current-button-bg: var(--button-bg-dark);
            --current-button-text: var(--button-text-dark);
            --current-input-bg: var(--input-bg-dark);
            --current-shadow: var(--shadow-dark);
            --current-selection-bg: var(--selection-bg-dark-var);
        }

        ::selection {
            background-color: var(--current-selection-bg);
            color: var(--current-text-color);
        }

        html {
            -webkit-tap-highlight-color: color-mix(in srgb, var(--current-accent-color) 30%, transparent);
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-family-base);
            font-size: var(--font-size-base);
            background-color: var(--current-bg-color);
            color: var(--current-text-color);
            line-height: 1.7;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: var(--font-serif);
            font-weight: 600;
            color: var(--current-title-color);
            margin-bottom: 0.8em;
            line-height: 1.3;
        }

        button {
            position: relative;
            top: 0;
            transition: all 0.2s ease;
        }

        button:hover {
            transform: translateY(-1px);
            filter: brightness(1.08);
        }

        button:active {
            transform: translateY(0px) scale(0.98);
            filter: brightness(0.95);
            transition-duration: 0.05s;
        }

        button:disabled,
        button:disabled:hover {
            cursor: not-allowed;
            background-color: var(--current-hover-bg);
            color: var(--current-meta-color);
            filter: grayscale(0.8);
            transform: none;
            box-shadow: none;
            top: 0;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background-color: var(--current-secondary-bg);
            border-bottom: 1px solid var(--current-border-color);
            box-shadow: var(--current-shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        .app-header.hidden-mobile {
            transform: translateY(-100%);
        }

        .app-header h1 {
            font-family: var(--font-serif);
            font-size: 1.4em;
            margin: 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: default;
        }

        @media (max-width: 768px) {
            .app-header h1 {
                cursor: pointer;
            }
        }

        .secondary-menu {
            position: relative;
        }

        .menu-toggle-button {
            background: none;
            border: none;
            color: var(--current-text-color);
            cursor: pointer;
            padding: 8px 12px;
            font-size: 1.5em;
            line-height: 1;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .menu-toggle-button:hover {
            background-color: var(--current-hover-bg);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background-color: var(--current-bg-color);
            border: 1px solid var(--current-border-color);
            border-radius: 8px;
            box-shadow: var(--current-shadow);
            padding: 8px 0;
            min-width: 220px;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px) scale(0.95);
            transform-origin: top right;
            transition: opacity 0.2s ease, visibility 0s 0.2s, transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 70vh;
            overflow-y: auto;
        }

        .dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
            transition-delay: 0s;
        }

        .dropdown-menu button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 8px 15px;
            background: none;
            border: none;
            color: var(--current-text-color);
            text-align: left;
            cursor: pointer;
            font-family: var(--font-serif);
            font-size: 0.9em;
            gap: 8px;
        }

        .dropdown-menu button:hover {
            background-color: var(--current-hover-bg);
            transform: none;
        }

        .dropdown-menu button.active-mode,
        .dropdown-menu button.active-toggle {
            background-color: var(--current-accent-color);
            color: var(--current-bg-color);
            font-weight: 600;
        }

        body.dark-mode .dropdown-menu button.active-mode,
        body.dark-mode .dropdown-menu button.active-toggle {
            color: var(--button-text-dark);
        }

        .dropdown-menu .menu-group-title {
            padding: 10px 15px 4px;
            font-size: 0.75em;
            color: var(--current-meta-color);
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .dropdown-menu hr.menu-separator {
            display: none;
            border: none;
            border-top: 1px solid var(--current-border-color);
            margin: 5px 0;
        }

        .dropdown-menu hr.menu-separator.visible {
            display: block;
        }

        .app-main {
            flex-grow: 1;
            display: flex;
            overflow: hidden;
            position: relative;
            transition: transform 0.4s ease-in-out;
        }

        #editor-wrapper,
        #preview-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
            transition: flex 0.3s ease, max-width 0.3s ease;
        }

        @media (min-width: 769px) {
            #editor-wrapper {
                flex: 2.5;
            }

            #preview-wrapper {
                flex: 1.5;
                max-width: 550px;
            }
        }

        #editor-wrapper {
            position: relative;
        }

        .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--current-secondary-bg);
            border: 1px solid var(--current-border-color);
            border-radius: 8px;
            box-shadow: var(--current-shadow);
            margin: 15px;
            overflow: hidden;
        }

        #editor-wrapper .panel-content {
            margin-right: 7.5px;
        }

        #preview-wrapper .panel-content {
            margin-left: 7.5px;
        }

        #blog-controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 1px solid var(--current-border-color);
            background-color: var(--current-bg-color);
            user-select: none;
        }

        #blog-controls-header.hidden,
        #blog-controls-section.hidden {
            display: none;
        }

        #blog-controls-header button {
            background: none;
            border: none;
            font-size: 0.9em;
            color: var(--current-meta-color);
            cursor: pointer;
            padding: 5px 8px;
        }

        #blog-controls-section {
            padding: 15px;
            border-bottom: 1px solid var(--current-border-color);
            background-color: var(--current-bg-color);
            overflow-y: auto;
            flex-shrink: 0;
            transition: height 0.3s ease, padding 0.3s ease, border-color 0.3s ease;
        }

        #blog-controls-section.collapsed {
            height: 0 !important;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
            border-bottom-color: transparent;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--current-meta-color);
        }

        .form-group label.checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--current-border-color);
            border-radius: 4px;
            background-color: var(--current-input-bg);
            color: var(--current-text-color);
            font-family: var(--font-sans);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            font-size: 0.95em;
        }

        .form-group input[type="color"] {
            padding: 2px;
            height: 40px;
        }

        .form-group input[type="number"] {
            padding: 9px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--current-accent-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--current-accent-color) 25%, transparent);
        }

        .blog-actions button {
            padding: 10px 15px;
            background-color: var(--current-button-bg);
            color: var(--current-button-text);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-serif);
            font-weight: 600;
            margin-right: 10px;
        }

        #toolbars-container {
            background-color: var(--current-bg-color);
            border-bottom: 1px solid var(--current-border-color);
            flex-shrink: 0;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out, border-bottom-width 0.1s linear, opacity 0.3s ease-out;
            max-height: 300px;
            overflow: hidden;
            opacity: 1;
        }

        #toolbars-container.hidden-on-scroll {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            border-bottom-width: 0;
            opacity: 0;
        }

        #editor-toolbar.hidden-toolbar,
        #editor-actions-toolbar.hidden-toolbar,
        #custom-symbols-toolbar.hidden-toolbar {
            display: none !important;
        }

        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            padding: 6px 8px;
            gap: 5px;
            overflow-y: hidden;
        }

        #editor-toolbar {
            border-bottom: 1px solid var(--current-border-color);
        }

        #custom-symbols-toolbar {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed var(--current-border-color);
        }

        #custom-symbols-toolbar:empty {
            display: none;
        }

        .editor-toolbar button {
            background-color: var(--current-button-bg);
            color: var(--current-button-text);
            border: 1px solid transparent;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 1.1em;
            min-width: 32px;
            text-align: center;
        }

        #editor-actions-toolbar button {
            background-color: transparent;
            color: var(--current-button-text);
            border: 1px solid var(--current-border-color);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: 0.85em;
        }

        #editor-toolbar button.active,
        #editor-actions-toolbar button.active {
            background-color: var(--current-accent-color);
            color: var(--current-bg-color);
        }

        body.dark-mode #editor-toolbar button.active,
        body.dark-mode #editor-actions-toolbar button.active {
            color: var(--button-text-dark);
        }

        #editor-content-cm-wrapper {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        #stats-bar {
            padding: 8px 15px;
            background-color: var(--current-bg-color);
            border-top: 1px solid var(--current-border-color);
            font-size: 0.85em;
            color: var(--current-meta-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-sans);
            flex-shrink: 0;
        }

        .preview-content {
            flex-grow: 1;
            padding: 30px 40px;
            overflow-y: auto;
            font-family: var(--font-family-base);
            font-size: inherit;
            line-height: 1.9;
            color: var(--current-text-color);
            word-wrap: break-word;
        }

        .preview-content h1,
        .preview-content h2,
        .preview-content h3,
        .preview-content h4,
        .preview-content h5,
        .preview-content h6 {
            font-family: var(--font-serif);
            color: var(--current-title-color);
            margin-top: 1.8em;
            margin-bottom: 0.8em;
            line-height: 1.4;
        }

        .preview-content h1 {
            font-size: 2.2em;
            border-bottom: 1px solid var(--current-border-color);
            padding-bottom: 0.3em;
        }

        .preview-content h2 {
            font-size: 1.8em;
            border-bottom: 1px dashed var(--current-border-color);
            padding-bottom: 0.2em;
        }

        .preview-content h3 {
            font-size: 1.5em;
        }

        .preview-content h4 {
            font-size: 1.25em;
        }

        .preview-content p {
            margin-bottom: 1.2em;
            text-align: justify;
        }

        .preview-content a {
            color: var(--current-accent-color);
            text-decoration: none;
        }

        .preview-content a:hover {
            text-decoration: underline;
        }

        .preview-content blockquote {
            border-left: 4px solid var(--current-accent-color);
            padding: 10px 20px;
            margin: 1.5em 0;
            background-color: var(--current-secondary-bg);
            color: color-mix(in srgb, var(--current-text-color) 80%, transparent);
            font-style: italic;
        }

        .preview-content ul,
        .preview-content ol {
            margin-bottom: 1.2em;
            padding-left: 2.5em;
        }

        .preview-content li {
            margin-bottom: 0.5em;
        }

        .preview-content code:not([class*="language-"]) {
            background-color: var(--current-hover-bg);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: var(--font-mono);
            font-size: 0.9em;
        }

        .preview-content pre {
            padding: 1em;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 1.5em;
            font-size: 0.95em;
        }

        .preview-content pre code {
            padding: 0;
            background-color: transparent;
            border-radius: 0;
            font-family: var(--font-mono);
        }

        .preview-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1.5em auto;
            border-radius: 4px;
            box-shadow: var(--current-shadow);
        }

        .preview-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5em;
            font-size: 0.95em;
            border: 1px solid var(--current-border-color);
        }

        .preview-content th,
        .preview-content td {
            border: 1px solid var(--current-border-color);
            padding: 10px 12px;
            text-align: left;
        }

        .preview-content th {
            background-color: var(--current-secondary-bg);
            font-weight: 700;
            font-family: var(--font-sans);
        }

        .preview-content hr {
            border: 0;
            border-top: 2px dashed var(--current-border-color);
            margin: 2em 0;
        }

        .preview-content .mermaid-container-rendered svg {
            max-width: 100%;
            height: auto;
        }

        .preview-content mark,
        .preview-content .highlight {
            background-color: color-mix(in srgb, var(--current-accent-color) 40%, transparent);
            padding: 0.1em 0.3em;
            border-radius: 3px;
        }

        /* Custom Checkbox styles */
        .checkbox-label {
            position: relative;
            padding-left: 30px;
            user-select: none;
            cursor: pointer;
            min-height: 22px;
            line-height: 1.5;
        }

        .checkbox-label input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkbox-label .custom-checkbox {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            height: 20px;
            width: 20px;
            background-color: var(--current-input-bg);
            border: 1px solid var(--current-border-color);
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .checkbox-label:hover input[type="checkbox"]~.custom-checkbox {
            border-color: var(--current-accent-color);
        }

        .checkbox-label input[type="checkbox"]:checked~.custom-checkbox {
            background-color: var(--current-accent-color);
            border-color: var(--current-accent-color);
        }

        .checkbox-label .custom-checkbox::after {
            content: "";
            position: absolute;
            display: none;
        }

        .checkbox-label input[type="checkbox"]:checked~.custom-checkbox::after {
            display: block;
        }

        .checkbox-label .custom-checkbox::after {
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid var(--current-bg-color);
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        body.dark-mode .checkbox-label .custom-checkbox::after {
            border-color: var(--button-text-dark);
        }

        .form-group input[type="checkbox"] {
            width: auto;
        }

        /* override generic input style */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--current-bg-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 500px;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            margin-top: 0;
            font-family: var(--font-serif);
        }

        .modal-content p {
            font-size: 0.95em;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-family: var(--font-serif);
            font-weight: 600;
        }

        .modal-buttons button.primary {
            background-color: var(--current-accent-color);
            color: var(--current-bg-color);
        }

        body.dark-mode .modal-buttons button.primary {
            color: var(--button-text-dark);
        }

        .modal-buttons button.secondary {
            background-color: var(--current-button-bg);
            color: var(--current-button-text);
        }

        #message-bar {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--current-title-color);
            color: var(--current-bg-color);
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-size: 0.9em;
            font-family: var(--font-sans);
            z-index: 3000;
            transition: bottom 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.5s ease;
            opacity: 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            #message-bar {
                font-size: clamp(12px, 3.5vw, 14px);
                padding: 8px 15px;
            }
        }

        #message-bar.show {
            bottom: 20px;
            opacity: 1;
        }

        #editor-drag-handle {
            position: absolute;
            right: 8px;
            top: 45%;
            width: 18px;
            height: 60px;
            background-color: color-mix(in srgb, var(--current-accent-color) 60%, transparent);
            border: 1px solid color-mix(in srgb, var(--current-accent-color) 80%, transparent);
            border-radius: 9px;
            cursor: ns-resize;
            z-index: 101;
            opacity: 0.4;
            transition: opacity 0.2s, background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #editor-drag-handle:hover,
        #editor-drag-handle.dragging {
            opacity: 1;
            background-color: var(--current-accent-color);
        }

        #editor-drag-handle svg {
            width: 14px;
            height: 14px;
            stroke: var(--current-bg-color);
            stroke-width: 2;
        }

        #symbolsModal .modal-content {
            max-width: 600px;
        }

        #currentSymbolsList {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--current-border-color);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 20px;
        }

        #currentSymbolsList li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-radius: 3px;
            font-family: var(--font-sans);
        }

        #currentSymbolsList li:nth-child(odd) {
            background-color: var(--current-hover-bg);
        }

        .delete-symbol-btn {
            background: #e57373;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8em;
        }

        body.dark-mode .delete-symbol-btn {
            background: #c62828;
        }

        #addSymbolForm {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 25px;
        }

        #addSymbolForm .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        #addSymbolForm button {
            padding: 10px 15px;
            height: 40px;
        }

        .symbol-io-actions {
            display: flex;
            gap: 10px;
            border-top: 1px solid var(--current-border-color);
            padding-top: 15px;
            margin-top: 15px;
        }

        .symbol-io-actions button,
        .symbol-io-actions label {
            padding: 8px 15px;
            background-color: var(--current-button-bg);
            color: var(--current-button-text);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-serif);
            font-weight: 600;
            text-align: center;
        }

        #importSymbolsInput {
            display: none;
        }

        #aboutModal .modal-content,
        #settingsModal .modal-content {
            max-width: 600px;
        }

        #aboutModal .app-version {
            font-size: 0.9em;
            color: var(--current-meta-color);
            margin-top: -10px;
            margin-bottom: 15px;
        }

        #aboutModal a {
            color: var(--current-accent-color);
        }

        #cardExportModal .modal-content {
            max-width: 90vw;
            width: 800px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        #cardExportSettings {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--current-border-color);
        }

        #cardExportSettings .form-group {
            flex: 1 1 200px;
        }

        #cardPreviewAreaContainer {
            flex-grow: 1;
            max-height: 40vh;
            overflow-y: auto;
            border: 1px solid var(--current-border-color);
            padding: 10px;
            background-color: var(--current-hover-bg);
            border-radius: 4px;
            margin-bottom: 15px;
        }

        #cardPreviewArea {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-content: flex-start;
        }

        .exported-card {
            border: 1px solid var(--current-border-color);
            background-color: var(--current-bg-color);
            box-shadow: var(--current-shadow);
            overflow: hidden;
            page-break-inside: avoid;
            position: relative;
            padding: 20px;
            box-sizing: border-box;
        }

        .exported-card .page-number {
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 0.8em;
            color: var(--current-meta-color);
        }


        @media (max-width: 768px) {
            .app-main {
                flex-direction: row;
                width: 200%;
            }

            #editor-wrapper,
            #preview-wrapper {
                width: 50%;
                flex-shrink: 0;
            }

            #editor-wrapper .panel-content,
            #preview-wrapper .panel-content {
                margin: 0;
                border-radius: 0;
                border: none;
                border-bottom: 1px solid var(--current-border-color);
            }

            .app-main.view-preview {
                transform: translateX(-50%);
            }

            #blog-controls-section {
                max-height: 25vh;
            }

            .editor-toolbar,
            #editor-actions-toolbar {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            .editor-toolbar::-webkit-scrollbar,
            #editor-actions-toolbar::-webkit-scrollbar {
                display: none;
            }

            .editor-toolbar button,
            #editor-actions-toolbar button {
                flex-shrink: 0;
            }

            .preview-content {
                padding: 20px;
                font-size: 1em;
            }

            #cardExportModal .modal-content {
                width: 95vw;
            }

            #cardExportSettings {
                flex-direction: column;
            }

            #cardPreviewAreaContainer {
                max-height: 30vh;
            }

            #editor-drag-handle {
                display: none;
            }
        }

        .cm-s-neo .CodeMirror-activeline-background {
            background-color: var(--cm-activeline-bg-light, rgba(0, 0, 0, 0.05));
        }

        .cm-s-material-darker .CodeMirror-activeline-background {
            background-color: var(--cm-activeline-bg-dark, rgba(255, 255, 255, 0.05));
        }

        body:not(.editor-highlight-disabled) .cm-s-neo.CodeMirror-focused .CodeMirror-activeline-background {
            background-color: color-mix(in srgb, var(--current-accent-color) 15%, transparent) !important;
        }

        body:not(.editor-highlight-disabled) .cm-s-material-darker.CodeMirror-focused .CodeMirror-activeline-background {
            background-color: color-mix(in srgb, var(--current-accent-color) 20%, transparent) !important;
        }

        .CodeMirror {
            font-family: var(--font-family-base) !important;
            font-size: var(--font-size-base) !important;
            line-height: 1.75 !important;
            height: 100% !important;
            background-color: var(--current-secondary-bg) !important;
            color: var(--current-text-color) !important;
            border: none;
            outline: none;
        }

        body.dark-mode .cm-s-material-darker,
        body.dark-mode .cm-s-material-darker .CodeMirror-line {
            color: var(--text-color-dark, #e0e0e0);
        }

        body.dark-mode .cm-s-material-darker .cm-comment {
            color: #999;
        }

        .cm-typewriter-dimmed .CodeMirror-line>span {
            opacity: 0.5 !important;
            transition: opacity 0.2s ease-in-out;
        }

        .cm-typewriter-active-line .CodeMirror-line>span {
            opacity: 1 !important;
        }

        input[type="text"],
        input[type="date"],
        textarea {
            font-size: 1em;
        }
    </style>
</head>

<body class="app-loading">
    <div class="app-container">
        <header class="app-header" id="appHeader">
            <h1 id="appTitle">Markdown Editor Pro</h1>
            <div class="secondary-menu">
                <button class="menu-toggle-button" id="menuToggleButton" aria-label="Open menu">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width:1.2em; height:1.2em; display:block;">
                        <path
                            d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 12c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
                    </svg>
                </button>
                <div class="dropdown-menu" id="appDropdownMenu">
                    <div class="menu-group-title">外观与模式</div>
                    <button id="toggleThemeButton"><span class="label">切换日夜模式</span></button>
                    <button id="toggleSyncScrollBtn" style="display: none;"><span class="label">同步滚动</span></button>
                    <button id="openSettingsModalBtn"><span class="label">个性化设置</span></button>

                    <hr class="menu-separator" id="sep1">
                    <div class="menu-group-title" id="titleMode">编辑模式</div>
                    <button id="switchToEditorMode" data-mode="editor"><span class="label">Editor 模式</span></button>
                    <button id="switchToBlogMode" data-mode="blog"><span class="label">Blog 模式</span></button>
                    <button id="setBlogUrlBtn"><span class="label">设定 Blog 网址</span></button>

                    <hr class="menu-separator" id="sep2">
                    <div class="menu-group-title" id="titleTools">编辑与工具</div>
                    <button id="manageSymbolsBtn"><span class="label">管理快捷符号</span></button>
                    <button id="toggleMainToolbarVisibilityBtn" data-toolbar-id="editor-toolbar"
                        data-menu-group="tools"><span class="label">主工具栏</span></button>
                    <button id="toggleActionsToolbarVisibilityBtn" data-toolbar-id="editor-actions-toolbar"
                        data-menu-group="tools"><span class="label">动作工具栏</span></button>
                    <button id="toggleCustomToolbarVisibilityBtn" data-toolbar-id="custom-symbols-toolbar"
                        data-menu-group="tools"><span class="label">自定义符号栏</span></button>

                    <hr class="menu-separator" id="sep3">
                    <div class="menu-group-title" id="titleExport">导出选项</div>
                    <button data-action="exportMD" id="exportMdBtnInMenu" data-menu-group="export"><span
                            class="label">导出 MarkDown (.md)</span></button>
                    <button data-action="generateImage" id="exportImgBtnInMenu" data-menu-group="export"><span
                            class="label">导出图片 (Alpha)</span></button>
                    <button data-action="generatePdf" id="exportPdfBtnInMenu" data-menu-group="export"><span
                            class="label">导出 PDF (Alpha)</span></button>
                    <button id="exportSvgBtn" data-menu-group="export"><span class="label">导出 SVG</span></button>
                    <button id="openCardExportModalBtn" data-menu-group="export"><span
                            class="label">导出为卡片（Beta）</span></button>

                    <hr class="menu-separator" id="sep4">
                    <button id="openAboutModalBtn"><span class="label">关于</span></button>
                </div>
            </div>
        </header>

        <main class="app-main" id="appMain">
            <div id="editor-wrapper">
                <div id="editor-drag-handle">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M7 15L12 20L17 15M7 9L12 4L17 9" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <div class="panel-content">
                    <div id="blog-controls-header" class="hidden">
                        <span>Blog Front Matter</span>
                        <button id="toggleBlogControlsBtn">折叠</button>
                    </div>
                    <div id="blog-controls-section" class="hidden">
                        <div class="form-group"><label for="blogTitle">标题 (Title)</label><input type="text"
                                id="blogTitle" name="blogTitle"></div>
                        <div class="form-group"><label for="blogPubDate">发布日期 (PubDate)</label><input type="date"
                                id="blogPubDate" name="blogPubDate"></div>
                        <div class="form-group"><label for="blogCategories">分类 (Categories, 逗号分隔)</label><input
                                type="text" id="blogCategories" name="blogCategories" placeholder="例如：日志，技术"></div>
                        <div class="form-group"><label for="blogDescription">描述 (Description)</label><input type="text"
                                id="blogDescription" name="blogDescription"></div>
                        <div class="blog-actions">
                            <button id="copyBlogMarkdown">复制全文</button>
                            <button id="openBlogUrl">打开设定网址</button>
                        </div>
                    </div>

                    <div id="toolbars-container">
                        <div id="editor-toolbar" class="editor-toolbar">
                            <!-- 
                            Toolbar Button Documentation

                            Each <button> element provides a Markdown formatting action for a text editor. The "data-action" attribute specifies the action type. Below are the documented actions, including additional Markdown symbols:

                            Headings:
                            - data-action="h1": Heading 1 (#)
                            - data-action="h2": Heading 2 (##)
                            - data-action="h3": Heading 3 (###)

                            Text Styles:
                            - data-action="bold": Bold (**)
                            - data-action="italic": Italic (*)
                            - data-action="strikethrough": Strikethrough (~~)
                            - data-action="underline": Underline (<u> or custom syntax, e.g., __text__)
                            - data-action="highlight": Highlight (==)
                            - data-action="inlineCode": Inline Code (`)

                            Block Elements:
                            - data-action="blockquote": Blockquote (>)
                            - data-action="ul": Unordered List (-)
                            - data-action="ol": Ordered List (1.)
                            - data-action="checkbox": Checkbox (- [ ])
                            - data-action="completedCheckbox": Completed Checkbox (- [x])
                            - data-action="hr": Horizontal Rule (---)
                            - data-action="forceBreak": Force Line Break (<br>)
                            - data-action="table": Table

                            Links & Media:
                            - data-action="link": Link ([text](url))
                            - data-action="image": Image (![alt](url))

                            Code:
                            - data-action="codeblock": Code Block (```)

                            Special Quotes & Brackets:
                            - data-action="jpQuotes": Japanese Quotes 「」
                            - data-action="jpSingleQuotes": Japanese Single Quotes 『』
                            - data-action="bookTitle": Book Title 《》
                            - data-action="parentheses": Parentheses （）

                            Additional Markdown Symbols:
                            - data-action="center": Centered Text (custom syntax, e.g., <center>text</center>)
                            - data-action="pinyin": Pinyin Annotation (custom syntax, e.g., [汉字](pinyin:han4zi4))
                            - data-action="largeFont": Large Font (custom syntax, e.g., <big>text</big>)
                            - data-action="smallFont": Small Font (custom syntax, e.g., <small>text</small>)
                            - data-action="superscript": Superscript (^text^ or <sup>text</sup>)
                            - data-action="subscript": Subscript (~text~ or <sub>text</sub>)

                            -->
                            <button data-action="h1" title="H1">#</button><button data-action="h2"
                                title="H2">##</button><button data-action="h3" title="H3">###</button><button
                                data-action="bold" title="Bold (Cmd+B)">**</button><button data-action="italic"
                                title="Italic (Cmd+I)">*</button><button data-action="strikethrough"
                                title="Strikethrough (Cmd+U)">~~</button>
                            <button data-action="highlight" title="Highlight (Cmd+Alt+U)">==</button>
                            <button data-action="inlineCode" title="Inline Code (Cmd+Alt+V)">`</button><button
                                data-action="blockquote" title="Blockquote (Ctrl+Q)">&gt;</button><button
                                data-action="ul" title="Unordered List">-</button><button data-action="ol"
                                title="Ordered List">1.</button><button data-action="checkbox"
                                title="Checkbox">-[]</button><button data-action="completedCheckbox"
                                title="Completed Checkbox">- [x]</button><button data-action="link"
                                title="Link (Cmd+K)">Link</button><button data-action="image"
                                title="Image (Ctrl+G)">Img</button><button data-action="table"
                                title="Table (Cmd+Alt+T)">Table</button><button data-action="codeblock"
                                title="Code Block (Cmd+Alt+C)">Code</button><button data-action="hr"
                                title="Horizontal Rule">---</button>
                            <button data-action="forceBreak" title="Force Line Break">&lt;br&gt;</button>
                            <button data-action="jpQuotes" title="Japanese Quotes 「」">「」</button><button
                                data-action="jpSingleQuotes" title="Japanese Single Quotes 『』">『』</button><button
                                data-action="bookTitle" title="Book Title 《》">《》</button><button
                                data-action="parentheses" title="Parentheses ()">（）</button>
                        </div>
                        <div id="editor-actions-toolbar" class="editor-toolbar">
                            <button data-action="undo" title="Undo (Ctrl+Z)">撤销</button><button data-action="redo"
                                title="Redo (Ctrl+Y)">重做</button><button data-action="copy"
                                title="Copy">复制</button><button data-action="paste" title="Paste">粘贴</button><button
                                id="toggleTypewriterMode" title="Typewriter Mode">打字机</button><button
                                data-action="goToLine" title="Go to Line">跳行</button><button
                                data-action="insertTimestamp" title="Insert Current Time">时间</button><button
                                data-action="insertStats" title="Insert Document Stats">统计</button><button
                                data-action="convertQuotes" title="Convert to Japanese Quotes">转日式引号</button><button
                                data-action="s2t" title="Simplified to Traditional">简转繁</button><button
                                data-action="t2s" title="Traditional to Simplified">繁转简</button>
                            <button data-action="deleteLine" title="Delete Line">删行</button>
                            <button data-action="removeMarkdown" title="Remove Markdown Markings">去标记</button>
                            <button data-action="addBlankLines" title="Add Blank Lines Between Paragraphs">添空行</button>
                            <button data-action="removeExcessBlankLines" title="Remove Excess Blank Lines">删空行</button>
                        </div>
                        <div id="custom-symbols-toolbar" class="editor-toolbar"></div>
                    </div>

                    <div id="editor-content-cm-wrapper"><textarea id="markdown-input-fallback"
                            style="display:none;"></textarea></div>
                    <div id="stats-bar"><span id="charCount">字符：0</span><span id="wordCount">词数：0</span><span
                            id="lineCount">行数：1</span><span id="currentTime"></span></div>
                </div>
            </div>

            <div id="preview-wrapper">
                <div class="panel-content">
                    <div class="preview-content" id="markdown-preview"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="blogUrlModal">
        <div class="modal-content">
            <h2>Blog 模式配置</h2>
            <p>请输入您博客（或其他目标网站）的新建文章页面的 URL。后续点击 “打开设定网址” 将跳转至此。</p>
            <div class="form-group"><label for="blogTargetUrlInput">目标 URL</label><input type="text"
                    id="blogTargetUrlInput" placeholder="https://example.com/admin/new-post"><small id="urlError"
                    style="color: red; display: none; margin-top: 5px;">请输入有效的 URL</small></div>
            <div class="modal-buttons"><button id="cancelBlogUrlBtn" class="secondary">取消</button><button
                    id="saveBlogUrlButton" class="primary">保存并继续</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="linkModal">
        <div class="modal-content">
            <h2>插入链接</h2>
            <div class="form-group"><label for="linkUrlInput">链接 URL</label><input type="text" id="linkUrlInput"
                    placeholder="https://example.com"></div>
            <div class="form-group"><label for="linkTextInput">链接文本 (可选)</label><input type="text" id="linkTextInput"
                    placeholder="显示的文字"></div>
            <div class="modal-buttons"><button id="cancelLinkButton" class="secondary">取消</button><button
                    id="insertLinkButton" class="primary">插入</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="imageModal">
        <div class="modal-content">
            <h2>插入图片</h2>
            <div class="form-group"><label for="imageUrlInput">图片 URL</label><input type="text" id="imageUrlInput"
                    placeholder="https://example.com/image.png"></div>
            <div class="form-group"><label for="imageAltInput">替换文本 (Alt Text)</label><input type="text"
                    id="imageAltInput" placeholder="图片描述"></div>
            <div class="modal-buttons"><button id="cancelImageButton" class="secondary">取消</button><button
                    id="insertImageButton" class="primary">插入</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="symbolsModal">
        <div class="modal-content">
            <h2>管理快捷符号</h2>
            <p>当前符号列表：</p>
            <ul id="currentSymbolsList"></ul>
            <p>添加新符号：</p>
            <div id="addSymbolForm">
                <div class="form-group"><label for="symbolLabelInput">按钮文字</label><input type="text"
                        id="symbolLabelInput" placeholder="→"></div>
                <div class="form-group"><label for="symbolPrefixInput">前缀</label><input type="text"
                        id="symbolPrefixInput" placeholder="<!-- "></div>
                <div class="form-group"><label for="symbolSuffixInput">后缀</label><input type="text"
                        id="symbolSuffixInput" placeholder=" -->"></div><button id="addSymbolBtn"
                    class="primary">添加</button>
            </div>
            <div class="symbol-io-actions"><button id="exportSymbolsBtn">导出配置</button><label
                    for="importSymbolsInput">导入配置</label><input type="file" id="importSymbolsInput" accept=".json">
            </div>
            <div class="modal-buttons"><button id="cancelSymbolsBtn" class="secondary">取消</button><button
                    id="saveSymbolsBtn" class="primary">保存并关闭</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="aboutModal">
        <div class="modal-content">
            <h2>关于 Markdown Editor Pro</h2>
            <p class="app-version">版本 1.6.0 (Beta)</p>
            <p>功能一般的 Markdown 编辑器，旨在提供流畅的书写和预览体验。</p>
            <p>感谢使用！</p>
            <div class="modal-buttons">
                <button id="closeAboutModalBtn" class="primary">关闭</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <h2>个性化设置</h2>
            <div class="form-group">
                <label for="accentColorLightInput">亮色模式强调色：</label>
                <input type="color" id="accentColorLightInput">
            </div>
            <div class="form-group">
                <label for="accentColorDarkInput">暗色模式强调色：</label>
                <input type="color" id="accentColorDarkInput">
            </div>
            <div class="form-group">
                <label for="fontFamilySelect">编辑器字体：</label>
                <select id="fontFamilySelect">
                    <option value="'Noto Serif SC', serif">思源宋体 (默认)</option>
                    <option value="'Source Sans Pro', sans-serif">思源黑体</option>
                    <option value="'KaiTi', '楷体', serif">楷体</option>
                    <option value="'FangSong', '仿宋', serif">仿宋</option>
                    <option value="Arial, sans-serif">Arial</option>
                    <option value="Verdana, sans-serif">Verdana</option>
                    <option value="'Courier New', monospace">Courier New (等宽)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="fontSizeInput">基础字号 (px)：</label>
                <input type="number" id="fontSizeInput" min="12" max="24" step="1">
            </div>
            <div class="form-group">
                <label class="checkbox-label" for="enableEditorHighlightInput">
                    <input type="checkbox" id="enableEditorHighlightInput"><span
                        class="custom-checkbox"></span>启用编辑器当前行高亮
                </label>
            </div>
            <div class="form-group">
                <label class="checkbox-label" for="autoHideMobileToolbarInput">
                    <input type="checkbox" id="autoHideMobileToolbarInput"><span class="custom-checkbox"></span>(移动端)
                    向下滚动时自动隐藏工具栏
                </label>
            </div>
            <div class="modal-buttons">
                <button id="cancelSettingsBtn" class="secondary">取消</button>
                <button id="saveSettingsBtn" class="primary">保存并应用</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cardExportModal">
        <div class="modal-content">
            <h2>导出为卡片</h2>
            <div id="cardExportSettings">
                <div class="form-group">
                    <label for="cardWidthInput">卡片宽度 (px)：</label>
                    <input type="number" id="cardWidthInput" value="440" min="200">
                </div>
                <div class="form-group">
                    <label for="cardHeightInput">卡片高度 (px)：</label>
                    <input type="number" id="cardHeightInput" value="586" min="200">
                </div>
                <div class="form-group">
                    <label for="cardFontFamilySelect">卡片字体：</label>
                    <select id="cardFontFamilySelect">
                        <option value="'Noto Serif SC', serif">思源宋体 (默认)</option>
                        <option value="'Source Sans Pro', sans-serif">思源黑体</option>
                        <option value="'KaiTi', '楷体', serif">楷体</option>
                        <option value="'FangSong', '仿宋', serif">仿宋</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                        <option value="'Courier New', monospace">Courier New</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cardFontSizeInput">卡片字号 (px)：</label>
                    <input type="number" id="cardFontSizeInput" value="16" min="10" max="30">
                </div>
                <div class="form-group">
                    <label class="checkbox-label" for="cardShowPageNumbers">
                        <input type="checkbox" id="cardShowPageNumbers" checked><span
                            class="custom-checkbox"></span>显示页码
                    </label>
                </div>
                <div class="form-group">
                    <label for="cardPreviewZoom">预览缩放：</label>
                    <select id="cardPreviewZoom">
                        <option value="1">100%</option>
                        <option value="0.75">75%</option>
                        <option value="0.5">50%</option>
                        <option value="0.25">25%</option>
                    </select>
                </div>
            </div>
            <div id="cardPreviewAreaContainer">
                <strong>预览 (滚动查看所有卡片)：</strong>
                <div id="cardPreviewArea"></div>
            </div>
            <div class="modal-buttons">
                <button id="regenerateCardsBtn" class="secondary">重新生成预览</button>
                <button id="exportCardsAsPngBtn" class="primary">导出所有卡片 (PNG)</button>
                <button id="exportCardsAsSvgBtn" class="primary">导出所有卡片 (SVG)</button>
                <button id="cancelCardExportBtn" class="secondary">关闭</button>
            </div>
        </div>
    </div>


    <div id="message-bar"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/continuelist.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/dialog/dialog.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/search.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/matchesonscrollbar.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/selection/active-line.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/scroll/simplescrollbars.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.3/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        'use strict';
        document.addEventListener('DOMContentLoaded', () => {

            const dom = {
                appHeader: document.getElementById('appHeader'),
                appTitle: document.getElementById('appTitle'),
                appMain: document.getElementById('appMain'), markdownPreview: document.getElementById('markdown-preview'),
                editorWrapper: document.getElementById('editor-wrapper'),
                charCountEl: document.getElementById('charCount'), wordCountEl: document.getElementById('wordCount'), lineCountEl: document.getElementById('lineCount'), currentTimeEl: document.getElementById('currentTime'),
                toggleThemeButton: document.getElementById('toggleThemeButton'), menuToggleButton: document.getElementById('menuToggleButton'), appDropdownMenu: document.getElementById('appDropdownMenu'),
                toggleSyncScrollBtn: document.getElementById('toggleSyncScrollBtn'),
                switchToEditorModeBtn: document.getElementById('switchToEditorMode'),
                switchToBlogModeBtn: document.getElementById('switchToBlogMode'),
                setBlogUrlBtn: document.getElementById('setBlogUrlBtn'),
                blogControlsHeader: document.getElementById('blog-controls-header'),
                toggleBlogControlsBtn: document.getElementById('toggleBlogControlsBtn'),
                blogControlsSection: document.getElementById('blog-controls-section'),
                blogTitleInput: document.getElementById('blogTitle'),
                blogPubDateInput: document.getElementById('blogPubDate'),
                blogCategoriesInput: document.getElementById('blogCategories'),
                blogDescriptionInput: document.getElementById('blogDescription'),
                copyBlogMarkdownBtn: document.getElementById('copyBlogMarkdown'),
                openBlogUrlBtn: document.getElementById('openBlogUrl'),
                blogUrlModal: document.getElementById('blogUrlModal'),
                blogTargetUrlInput: document.getElementById('blogTargetUrlInput'),
                saveBlogUrlButton: document.getElementById('saveBlogUrlButton'),
                cancelBlogUrlBtn: document.getElementById('cancelBlogUrlBtn'),
                urlError: document.getElementById('urlError'),
                messageBar: document.getElementById('message-bar'), toggleTypewriterModeBtn: document.getElementById('toggleTypewriterMode'),
                linkModal: document.getElementById('linkModal'), linkUrlInput: document.getElementById('linkUrlInput'), linkTextInput: document.getElementById('linkTextInput'), insertLinkButton: document.getElementById('insertLinkButton'), cancelLinkButton: document.getElementById('cancelLinkButton'),
                imageModal: document.getElementById('imageModal'), imageUrlInput: document.getElementById('imageUrlInput'), imageAltInput: document.getElementById('imageAltInput'), insertImageButton: document.getElementById('insertImageButton'), cancelImageButton: document.getElementById('cancelImageButton'),
                customSymbolsToolbar: document.getElementById('custom-symbols-toolbar'), manageSymbolsBtn: document.getElementById('manageSymbolsBtn'), symbolsModal: document.getElementById('symbolsModal'),
                currentSymbolsList: document.getElementById('currentSymbolsList'), symbolLabelInput: document.getElementById('symbolLabelInput'), symbolPrefixInput: document.getElementById('symbolPrefixInput'), symbolSuffixInput: document.getElementById('symbolSuffixInput'),
                addSymbolBtn: document.getElementById('addSymbolBtn'), exportSymbolsBtn: document.getElementById('exportSymbolsBtn'), importSymbolsInput: document.getElementById('importSymbolsInput'), saveSymbolsBtn: document.getElementById('saveSymbolsBtn'), cancelSymbolsBtn: document.getElementById('cancelSymbolsBtn'),
                editorDragHandle: document.getElementById('editor-drag-handle'),
                toolbarsContainer: document.getElementById('toolbars-container'),
                toggleMainToolbarVisibilityBtn: document.getElementById('toggleMainToolbarVisibilityBtn'),
                toggleActionsToolbarVisibilityBtn: document.getElementById('toggleActionsToolbarVisibilityBtn'),
                toggleCustomToolbarVisibilityBtn: document.getElementById('toggleCustomToolbarVisibilityBtn'),
                mainToolbar: document.getElementById('editor-toolbar'),
                actionsToolbar: document.getElementById('editor-actions-toolbar'),
                openAboutModalBtn: document.getElementById('openAboutModalBtn'),
                aboutModal: document.getElementById('aboutModal'),
                closeAboutModalBtn: document.getElementById('closeAboutModalBtn'),
                openSettingsModalBtn: document.getElementById('openSettingsModalBtn'),
                settingsModal: document.getElementById('settingsModal'),
                accentColorLightInput: document.getElementById('accentColorLightInput'),
                accentColorDarkInput: document.getElementById('accentColorDarkInput'),
                fontFamilySelect: document.getElementById('fontFamilySelect'),
                fontSizeInput: document.getElementById('fontSizeInput'),
                enableEditorHighlightInput: document.getElementById('enableEditorHighlightInput'),
                autoHideMobileToolbarInput: document.getElementById('autoHideMobileToolbarInput'),
                saveSettingsBtn: document.getElementById('saveSettingsBtn'),
                cancelSettingsBtn: document.getElementById('cancelSettingsBtn'),
                exportSvgBtn: document.getElementById('exportSvgBtn'),
                openCardExportModalBtn: document.getElementById('openCardExportModalBtn'),
                cardExportModal: document.getElementById('cardExportModal'),
                cardWidthInput: document.getElementById('cardWidthInput'),
                cardHeightInput: document.getElementById('cardHeightInput'),
                cardFontFamilySelect: document.getElementById('cardFontFamilySelect'),
                cardFontSizeInput: document.getElementById('cardFontSizeInput'),
                cardShowPageNumbers: document.getElementById('cardShowPageNumbers'),
                cardPreviewZoom: document.getElementById('cardPreviewZoom'),
                cardPreviewArea: document.getElementById('cardPreviewArea'),
                regenerateCardsBtn: document.getElementById('regenerateCardsBtn'),
                exportCardsAsPngBtn: document.getElementById('exportCardsAsPngBtn'),
                exportCardsAsSvgBtn: document.getElementById('exportCardsAsSvgBtn'),
                cancelCardExportBtn: document.getElementById('cancelCardExportBtn'),
                exportMdBtnInMenu: document.getElementById('exportMdBtnInMenu'),
                exportImgBtnInMenu: document.getElementById('exportImgBtnInMenu'),
                exportPdfBtnInMenu: document.getElementById('exportPdfBtnInMenu'),
                sep1: document.getElementById('sep1'),
                sep2: document.getElementById('sep2'),
                sep3: document.getElementById('sep3'),
                sep4: document.getElementById('sep4'),
                titleMode: document.getElementById('titleMode'),
                titleTools: document.getElementById('titleTools'),
                titleExport: document.getElementById('titleExport'),
            };

            let cmEditor, renderTimeout;
            let openccS2TConverter, openccT2SConverter;
            let generatedCards = [];

            let state = {
                currentMode: localStorage.getItem('editorMode') || 'editor',
                currentTheme: localStorage.getItem('theme') || 'light',
                blogTargetUrl: localStorage.getItem('blogTargetUrl') || '',
                isTypewriterMode: false,
                isBlogControlsCollapsed: false,
                currentMobileView: 'editor',
                lastActiveLineCM: -1,
                isSyncingScroll: localStorage.getItem('syncScroll') === 'true',
                openCCLoaded: false,
                customSymbols: [],
                isHandleDragging: false,
                dragStartY: 0,
                lastScrollY: 0,
                toolbarVisibility: {
                    'editor-toolbar': localStorage.getItem('toolbarVisibility-editor-toolbar') === 'false' ? false : true,
                    'editor-actions-toolbar': localStorage.getItem('toolbarVisibility-editor-actions-toolbar') === 'false' ? false : true,
                    'custom-symbols-toolbar': localStorage.getItem('toolbarVisibility-custom-symbols-toolbar') === 'false' ? false : true,
                },
                appearance: {
                    accentColorLight: localStorage.getItem('accentColorLight') || '#d4a373',
                    accentColorDark: localStorage.getItem('accentColorDark') || '#a98d70',
                    fontFamily: localStorage.getItem('fontFamily') || "'Noto Serif SC', serif",
                    fontSize: localStorage.getItem('fontSize') || '16px',
                    enableEditorHighlight: localStorage.getItem('enableEditorHighlight') === 'false' ? false : true,
                    autoHideMobileToolbar: localStorage.getItem('autoHideMobileToolbar') === 'false' ? false : true,
                }
            };
            const defaultMarkdown = '# 欢迎使用 Markdown Editor Pro！\n\n**这是一个功能丰富的 Markdown 编辑器。**\n\n## 主要功能\n\n- 实时预览\n- 多种编辑模式（Editor/Blog）\n- ==高亮文本== 与 ~~删除线~~\n- 快捷符号输入与管理\n- 主题切换 (日间/夜间模式)\n- 自定义强调色、字体与字号\n- 编辑器高亮、快捷滚动条开关\n- 同步滚动\n- Blog 模式支持 Front Matter\n- 打字机模式\n- 简繁转换\n- 导出为 MD，图片，PDF，SVG 及卡片\n\n## 快捷键示例\n\n- `Cmd/Ctrl+B`: **粗体**\n- `Cmd/Ctrl+I`: *斜体*\n- `Cmd/Ctrl+U`: ~~删除线~~\n- `Cmd/Ctrl+Alt+U`: ==高亮文本==\n- `Cmd/Ctrl+K` 或 `Ctrl+L`: 插入链接\n- `Ctrl+G`: 插入图片\n- `Cmd/Ctrl+Alt+C`: 插入代码块\n- `Cmd/Ctrl+Alt+V`: 插入行内代码\n- `Cmd/Ctrl+Alt+T`: 插入表格\n\n> 引用文本示例。\n\n向左滑动 (移动端) 或调整窗口大小查看预览效果。\n\n---\n第一行  \n第二行（行末双空格换行）\n\n第一段落。\n\n第二段落。\n\n强制换行：\n第一行<br/>第二行（使用了br标签）<br/><br/>第四行';

            const util = {
                showMessage: (message, duration = 3000) => { dom.messageBar.textContent = message; dom.messageBar.classList.add('show'); setTimeout(() => dom.messageBar.classList.remove('show'), duration); },
                reportError: (message, userFacing = true) => { console.error(message); if (userFacing) util.showMessage(`错误：${message}`, 5000); },
                validateUrl: (url) => { try { return (new URL(url).protocol === "http:" || new URL(url).protocol === "https:"); } catch (_) { return false; } },
                isMobile: () => window.innerWidth <= 768,
                downloadFile: (filename, text, mimeType) => {
                    const element = document.createElement('a');
                    element.setAttribute('href', `data:${mimeType};charset=utf-8,` + encodeURIComponent(text));
                    element.setAttribute('download', filename);
                    element.style.display = 'none';
                    document.body.appendChild(element);
                    element.click();
                    document.body.removeChild(element);
                }
            };

            const applyAppearanceSettings = () => {
                const root = document.documentElement;
                root.style.setProperty('--accent-color-custom-light', state.appearance.accentColorLight);
                root.style.setProperty('--accent-color-custom-dark', state.appearance.accentColorDark);

                const currentAccent = state.currentTheme === 'light' ? state.appearance.accentColorLight : state.appearance.accentColorDark;
                root.style.setProperty('--current-accent-color', currentAccent);

                const hexToRgba = (hex, alpha = 0.4) => {
                    try {
                        const bigint = parseInt(hex.slice(1), 16);
                        const r = (bigint >> 16) & 255;
                        const g = (bigint >> 8) & 255;
                        const b = bigint & 255;
                        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                    } catch (e) { // Fallback if hex is invalid
                        console.warn("Invalid hex for accent color:", hex);
                        return state.currentTheme === 'light' ? 'rgba(212, 163, 115, 0.3)' : 'rgba(169, 141, 112, 0.4)';
                    }
                };

                if (state.currentTheme === 'light') {
                    root.style.setProperty('--current-selection-bg', hexToRgba(currentAccent, 0.3));
                } else {
                    root.style.setProperty('--current-selection-bg', hexToRgba(currentAccent, 0.4));
                }

                root.style.setProperty('--font-family-base', state.appearance.fontFamily);
                root.style.setProperty('--font-size-base', state.appearance.fontSize);
                document.body.style.fontFamily = state.appearance.fontFamily;
                document.body.style.fontSize = state.appearance.fontSize;

                if (cmEditor) {
                    cmEditor.getWrapperElement().style.fontFamily = state.appearance.fontFamily;
                    cmEditor.getWrapperElement().style.fontSize = state.appearance.fontSize;
                    cmEditor.setOption('styleActiveLine', state.appearance.enableEditorHighlight ? { nonEmpty: true } : false);
                    document.body.classList.toggle('editor-highlight-disabled', !state.appearance.enableEditorHighlight);
                    cmEditor.refresh();
                }

                actions.updatePreview();
            };

            const loadAppearanceSettings = () => {
                dom.accentColorLightInput.value = state.appearance.accentColorLight;
                dom.accentColorDarkInput.value = state.appearance.accentColorDark;
                dom.fontFamilySelect.value = state.appearance.fontFamily;
                dom.fontSizeInput.value = parseInt(state.appearance.fontSize, 10);
                dom.enableEditorHighlightInput.checked = state.appearance.enableEditorHighlight;
                dom.autoHideMobileToolbarInput.checked = state.appearance.autoHideMobileToolbar;
                applyAppearanceSettings();
            };

            const saveAppearanceSettings = () => {
                state.appearance.accentColorLight = dom.accentColorLightInput.value;
                state.appearance.accentColorDark = dom.accentColorDarkInput.value;
                state.appearance.fontFamily = dom.fontFamilySelect.value;
                state.appearance.fontSize = dom.fontSizeInput.value + 'px';
                state.appearance.enableEditorHighlight = dom.enableEditorHighlightInput.checked;
                state.appearance.autoHideMobileToolbar = dom.autoHideMobileToolbarInput.checked;

                localStorage.setItem('accentColorLight', state.appearance.accentColorLight);
                localStorage.setItem('accentColorDark', state.appearance.accentColorDark);
                localStorage.setItem('fontFamily', state.appearance.fontFamily);
                localStorage.setItem('fontSize', state.appearance.fontSize);
                localStorage.setItem('enableEditorHighlight', state.appearance.enableEditorHighlight);
                localStorage.setItem('autoHideMobileToolbar', state.appearance.autoHideMobileToolbar);

                applyAppearanceSettings();
                util.showMessage("外观设置已保存并应用！");
                dom.settingsModal.classList.remove('active');
            };

            const updateMenuSeparators = () => {
                const isGroupVisible = (buttons) => buttons.some(btn => btn && getComputedStyle(btn).display !== 'none');

                const topButtonsVisible = isGroupVisible([dom.toggleThemeButton, dom.toggleSyncScrollBtn, dom.openSettingsModalBtn]);
                const modeButtonsVisible = isGroupVisible([dom.switchToEditorModeBtn, dom.switchToBlogModeBtn, dom.setBlogUrlBtn]);
                const toolsButtonsVisible = isGroupVisible([dom.manageSymbolsBtn, dom.toggleMainToolbarVisibilityBtn, dom.toggleActionsToolbarVisibilityBtn, dom.toggleCustomToolbarVisibilityBtn]);
                const exportButtonsVisible = isGroupVisible([dom.exportMdBtnInMenu, dom.exportImgBtnInMenu, dom.exportPdfBtnInMenu, dom.exportSvgBtn, dom.openCardExportModalBtn]);
                const aboutButtonVisible = dom.openAboutModalBtn && getComputedStyle(dom.openAboutModalBtn).display !== 'none';

                if (dom.titleMode) dom.titleMode.style.display = modeButtonsVisible ? 'block' : 'none';
                if (dom.titleTools) dom.titleTools.style.display = toolsButtonsVisible ? 'block' : 'none';
                if (dom.titleExport) dom.titleExport.style.display = exportButtonsVisible ? 'block' : 'none';

                if (dom.sep1) dom.sep1.classList.toggle('visible', topButtonsVisible && modeButtonsVisible);
                if (dom.sep2) dom.sep2.classList.toggle('visible', modeButtonsVisible && toolsButtonsVisible);
                if (dom.sep3) dom.sep3.classList.toggle('visible', toolsButtonsVisible && exportButtonsVisible);
                if (dom.sep4) dom.sep4.classList.toggle('visible', exportButtonsVisible && aboutButtonVisible);
            };


            const applyToolbarVisibility = () => {
                for (const toolbarId in state.toolbarVisibility) {
                    const toolbarElement = document.getElementById(toolbarId);
                    const buttonElement = document.querySelector(`.dropdown-menu button[data-toolbar-id="${toolbarId}"]`);
                    if (toolbarElement) {
                        toolbarElement.classList.toggle('hidden-toolbar', !state.toolbarVisibility[toolbarId]);
                    }
                    if (buttonElement) {
                        buttonElement.classList.toggle('active-toggle', state.toolbarVisibility[toolbarId]);
                    }
                }
                if (cmEditor) cmEditor.refresh();
                updateMenuSeparators();
            };

            const actions = {
                applyTheme: (theme) => {
                    document.body.classList.toggle('dark-mode', theme === 'dark');
                    state.currentTheme = theme;
                    localStorage.setItem('theme', theme);

                    const label = dom.toggleThemeButton.querySelector('.label');
                    if (theme === 'dark') {
                        label.textContent = "切换日间模式";
                    } else {
                        label.textContent = "切换夜间模式";
                    }

                    if (cmEditor) cmEditor.setOption("theme", theme === 'dark' ? "material-darker" : "neo");

                    const imgBtnToolbar = document.querySelector('#editor-actions-toolbar button[data-action="generateImage"]');
                    const pdfBtnToolbar = document.querySelector('#editor-actions-toolbar button[data-action="generatePdf"]');

                    const displayStyle = (theme === 'dark') ? 'none' : '';
                    if (imgBtnToolbar) imgBtnToolbar.style.display = displayStyle;
                    if (pdfBtnToolbar) pdfBtnToolbar.style.display = displayStyle;
                    if (dom.exportImgBtnInMenu) dom.exportImgBtnInMenu.style.display = displayStyle;
                    if (dom.exportPdfBtnInMenu) dom.exportPdfBtnInMenu.style.display = displayStyle;


                    document.getElementById('hljs-light-theme').media = (theme === 'light') ? 'all' : 'not all';
                    document.getElementById('hljs-dark-theme').media = (theme === 'dark') ? 'all' : 'not all';

                    applyAppearanceSettings();
                    actions.updatePreview();
                    util.showMessage(`已切换到${theme === 'dark' ? '夜间' : '日间'}模式`);
                    updateMenuSeparators();
                },
                applyAppMode: (mode) => {
                    state.currentMode = mode; localStorage.setItem('editorMode', mode);
                    dom.blogControlsHeader.classList.toggle('hidden', mode !== 'blog'); dom.blogControlsSection.classList.toggle('hidden', mode !== 'blog');
                    document.querySelectorAll('.dropdown-menu button[data-mode]').forEach(btn => btn.classList.remove('active-mode'));
                    if (mode === 'blog') { dom.switchToBlogModeBtn.classList.add('active-mode'); if (!state.blogTargetUrl) dom.blogUrlModal.classList.add('active'); }
                    else { dom.switchToEditorModeBtn.classList.add('active-mode'); }
                    setTimeout(() => { if (cmEditor) cmEditor.refresh(); }, 50);
                    util.showMessage(`已切换到 ${mode === 'blog' ? 'Blog' : 'Editor'} 模式`);
                },
                applyMobileView: (view) => {
                    if (!util.isMobile()) return; state.currentMobileView = view;
                    if (view === 'editor') { dom.appMain.classList.remove('view-preview'); if (cmEditor) cmEditor.focus(); }
                    else { dom.appMain.classList.add('view-preview'); actions.updatePreview(); }
                },
                updatePreview: () => { if (!cmEditor) return; clearTimeout(renderTimeout); renderTimeout = setTimeout(() => actions.renderMarkdown(cmEditor.getValue()), 150); },
                renderMarkdown: (mdText) => {
                    try {
                        if (typeof mdText !== 'string') {
                            util.reportError("输入到 Markdown 解析器的内容不是字符串。", true);
                            mdText = "";
                        }

                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = marked.parse(mdText);

                        renderMathInElement(tempDiv, { delimiters: [{ left: "$$", right: "$$", display: true }, { left: "$", right: "$", display: false }, { left: "\\[", right: "\\]", display: true }, { left: "\\(", right: "\\)", display: false }], throwOnError: false });

                        tempDiv.querySelectorAll('code.language-mermaid, div.mermaid').forEach((el, i) => {
                            const id = `mermaid-${Date.now()}-${i}`;
                            const mermaidContent = el.textContent || "";
                            el.id = id;
                            el.innerHTML = '';
                            try {
                                mermaid.render(id, mermaidContent, svg => {
                                    const container = document.createElement('div');
                                    container.className = 'mermaid-container-rendered';
                                    container.innerHTML = svg;
                                    if (el.parentNode) {
                                        el.parentNode.replaceChild(container, el);
                                    }
                                });
                            } catch (e) {
                                if (el.parentNode) el.outerHTML = `<pre style="color:red">Mermaid 错误：${e.message}</pre>`;
                            }
                        });
                        dom.markdownPreview.innerHTML = tempDiv.innerHTML;
                    } catch (e) {
                        dom.markdownPreview.innerHTML = `<p style="color:red;">渲染错误：${e.message}</p>`;
                        util.reportError(`Markdown 渲染失败：${e.message}。内容：${String(mdText).substring(0, 100)}`, false);
                        console.error(e);
                    }
                },
                updateStats: () => { if (!cmEditor) return; const text = cmEditor.getValue(); const cursor = cmEditor.getCursor(); dom.charCountEl.textContent = `字符：${text.length}`; dom.wordCountEl.textContent = `词数：${text.trim().split(/\s+/).filter(Boolean).length}`; dom.lineCountEl.textContent = `行：${cursor.line + 1}/${cmEditor.lineCount()}`; },
                updateTime: () => dom.currentTimeEl.textContent = new Date().toLocaleTimeString('zh-CN', { hour12: false }),
                removeMarkdownMarkup: () => {
                    if (!cmEditor) return;
                    let text = cmEditor.getValue();
                    text = text.replace(/^#{1,6}\s+(.*)/gm, '$1');
                    text = text.replace(/(\*\*|__)(.*?)\1/g, '$2');
                    text = text.replace(/(\*|_)(.*?)\1/g, '$2');
                    text = text.replace(/~~(.*?)~~/g, '$1');
                    text = text.replace(/==(.*?)==/g, '$1');
                    text = text.replace(/\^(.*?)\^/g, '$1');
                    text = text.replace(/!\[(.*?)\]\((.*?)\)/g, '$1 ($2)');
                    text = text.replace(/\[(.*?)\]\((.*?)\)/g, '$1 ($2)');
                    text = text.replace(/`([^`]+)`/g, '$1');
                    text = text.replace(/^>\s?(.*)/gm, '$1');
                    text = text.replace(/^(\s*[\-\*\+]\s+|\s*\d+\.\s+)(.*)/gm, '$2');
                    text = text.replace(/^\s*([-*_]){3,}\s*$/gm, '');
                    text = text.replace(/^```[a-zA-Z]*\n([\s\S]*?)\n```$/gm, '$1');
                    cmEditor.setValue(text);
                    util.showMessage("Markdown 标记已尝试移除");
                },
                addBlankLines: () => {
                    if (!cmEditor) return;
                    let text = cmEditor.getValue();
                    text = text.replace(/([^\n])\n([^\n])/g, '$1\n\n$2');
                    cmEditor.setValue(text);
                    util.showMessage("尝试在段落间添加空行");
                },
                removeExcessBlankLines: () => {
                    if (!cmEditor) return;
                    let text = cmEditor.getValue();
                    text = text.replace(/\n{3,}/g, '\n\n');
                    text = text.trim();
                    cmEditor.setValue(text);
                    util.showMessage("多余空行已移除");
                },

            };
            const cmUtil = {
                insert: (prefix, suffix = '', placeholder = 'text', select = true) => {
                    if (!cmEditor) return;
                    const doc = cmEditor.getDoc();
                    const selection = doc.getSelection();
                    if (selection) {
                        doc.replaceSelection(prefix + selection + suffix);
                    } else {
                        doc.replaceSelection(prefix + placeholder + suffix);
                        if (select && placeholder) {
                            const cur = doc.getCursor();
                            doc.setSelection({ line: cur.line, ch: cur.ch - suffix.length - placeholder.length }, { line: cur.line, ch: cur.ch - suffix.length });
                        }
                    }
                    cmEditor.focus();
                },
                togglePrefix: (prefix) => { if (!cmEditor) return; cmEditor.operation(() => { const doc = cmEditor.getDoc(); const { from, to } = { from: doc.getCursor("start"), to: doc.getCursor("end") }; for (let i = from.line; i <= to.line; i++) { if (doc.getLine(i).startsWith(prefix)) { doc.replaceRange("", { line: i, ch: 0 }, { line: i, ch: prefix.length }); } else { doc.replaceRange(prefix, { line: i, ch: 0 }); } } }); cmEditor.focus(); },
            };
            const symbolManager = {
                renderToolbar: () => {
                    dom.customSymbolsToolbar.innerHTML = '';
                    state.customSymbols.forEach(s => {
                        const btn = document.createElement('button');
                        btn.textContent = s.label;
                        btn.title = `插入：${s.prefix}...${s.suffix}`;
                        btn.dataset.action = 'insertCustom';
                        btn.dataset.prefix = s.prefix;
                        btn.dataset.suffix = s.suffix;
                        dom.customSymbolsToolbar.appendChild(btn);
                    });
                    if (state.customSymbols.length === 0) {
                        dom.customSymbolsToolbar.style.display = 'none';
                    } else {
                        dom.customSymbolsToolbar.style.display = state.toolbarVisibility['custom-symbols-toolbar'] ? 'flex' : 'none';
                    }
                },
                renderModal: () => { dom.currentSymbolsList.innerHTML = ''; if (state.customSymbols.length === 0) { dom.currentSymbolsList.innerHTML = '<li>无自定义符号。</li>'; return; } state.customSymbols.forEach((s, i) => { const li = document.createElement('li'); li.innerHTML = `<span><b style="min-width:40px;display:inline-block;padding:2px 8px;background:var(--current-button-bg);border-radius:3px;text-align:center;margin-right:10px;">${s.label}</b><i style="color:var(--current-meta-color)">：“${s.prefix}” + “${s.suffix}”</i></span><button class="delete-symbol-btn" data-index="${i}">删除</button>`; dom.currentSymbolsList.appendChild(li); }); },
                save: () => { try { localStorage.setItem('customSymbols', JSON.stringify(state.customSymbols)); return true; } catch (e) { util.reportError('无法保存符号'); return false; } },
                load: () => { const saved = localStorage.getItem('customSymbols'); if (saved) { try { state.customSymbols = JSON.parse(saved); if (!Array.isArray(state.customSymbols)) throw new Error("Data is not array"); } catch (e) { console.error("解析符号失败", e); state.customSymbols = []; } } else { state.customSymbols = [{ label: '<!--', prefix: '<!-- ', suffix: ' -->' }]; } symbolManager.renderToolbar(); },
            };

            const handleTypewriterFocus = () => {
                if (!cmEditor || !state.isTypewriterMode) return;
                const currentLine = cmEditor.getCursor().line;
                if (currentLine === state.lastActiveLineCM) return;
                cmEditor.operation(() => {
                    if (state.lastActiveLineCM !== -1 && state.lastActiveLineCM < cmEditor.lineCount()) { cmEditor.removeLineClass(state.lastActiveLineCM, "wrap", "cm-typewriter-active-line"); }
                    for (let i = 0; i < cmEditor.lineCount(); i++) { cmEditor.removeLineClass(i, "wrap", "cm-typewriter-dimmed"); if (i !== currentLine) { cmEditor.addLineClass(i, "wrap", "cm-typewriter-dimmed"); } }
                    cmEditor.addLineClass(currentLine, "wrap", "cm-typewriter-active-line");
                });
                state.lastActiveLineCM = currentLine;
                const editorHeight = cmEditor.getWrapperElement().clientHeight;
                const top = cmEditor.charCoords({ line: currentLine, ch: 0 }, "local").top;
                cmEditor.scrollTo(null, top - editorHeight / 2 + cmEditor.defaultTextHeight() / 2);
            };

            const generateAndPreviewCards = async () => {
                util.showMessage("生成卡片预览中…");
                dom.cardPreviewArea.innerHTML = '';
                generatedCards = [];

                const cardWidth = parseInt(dom.cardWidthInput.value, 10);
                const cardHeight = parseInt(dom.cardHeightInput.value, 10);
                const cardFontFamily = dom.cardFontFamilySelect.value;
                const cardFontSize = dom.cardFontSizeInput.value + 'px';
                const showPageNumbers = dom.cardShowPageNumbers.checked;
                const previewZoom = parseFloat(dom.cardPreviewZoom.value);

                // Prepare source nodes
                const sourceContentNode = dom.markdownPreview.cloneNode(true);
                sourceContentNode.style.fontFamily = cardFontFamily;
                sourceContentNode.style.fontSize = cardFontSize;
                sourceContentNode.style.lineHeight = getComputedStyle(dom.markdownPreview).lineHeight;
                sourceContentNode.style.color = getComputedStyle(dom.markdownPreview).color;
                // Add padding for card content (increase for better margin)
                sourceContentNode.style.padding = '32px 32px 32px 32px';
                sourceContentNode.style.width = (cardWidth - 64) + 'px';
                sourceContentNode.style.boxSizing = 'border-box';

                // Fix images: max-width 100%, auto height, object-fit contain, and prevent overflow
                sourceContentNode.querySelectorAll('img').forEach(img => {
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                    img.style.display = 'block';
                    img.style.objectFit = 'contain';
                    img.style.margin = '1em auto';
                    img.style.boxSizing = 'border-box';
                    img.style.maxHeight = (cardHeight - 64 - 40) + 'px'; // leave space for padding and page number
                });

                // Create a hidden container for measuring
                const offscreenContainer = document.createElement('div');
                offscreenContainer.style.position = 'absolute';
                offscreenContainer.style.left = '-9999px';
                offscreenContainer.style.top = '0';
                offscreenContainer.style.width = cardWidth + 'px';
                offscreenContainer.style.visibility = 'hidden';
                offscreenContainer.style.pointerEvents = 'none';
                offscreenContainer.style.zIndex = '-1';
                document.body.appendChild(offscreenContainer);

                let currentPageNum = 1;
                let nodes = Array.from(sourceContentNode.childNodes);
                let idx = 0;

                while (idx < nodes.length) {
                    // Create a new card content container
                    let cardContent = document.createElement('div');
                    cardContent.style.fontFamily = cardFontFamily;
                    cardContent.style.fontSize = cardFontSize;
                    cardContent.style.lineHeight = getComputedStyle(dom.markdownPreview).lineHeight;
                    cardContent.style.color = getComputedStyle(dom.markdownPreview).color;
                    cardContent.style.padding = '32px';
                    cardContent.style.width = (cardWidth - 0) + 'px';
                    cardContent.style.boxSizing = 'border-box';
                    cardContent.style.overflow = 'hidden';

                    offscreenContainer.appendChild(cardContent);

                    // Fill the card with as many nodes as fit
                    while (idx < nodes.length) {
                        let node = nodes[idx].cloneNode(true);

                        // For images, ensure they don't overflow
                        if (node.nodeType === 1 && node.tagName === 'IMG') {
                            node.style.maxWidth = '100%';
                            node.style.height = 'auto';
                            node.style.display = 'block';
                            node.style.objectFit = 'contain';
                            node.style.margin = '1em auto';
                            node.style.boxSizing = 'border-box';
                            node.style.maxHeight = (cardHeight - 64 - 40) + 'px';
                        }
                        cardContent.appendChild(node);

                        // If overflows, remove last node and break
                        if (cardContent.scrollHeight > cardHeight) {
                            cardContent.removeChild(node);
                            break;
                        }
                        idx++;
                    }

                    // If nothing fits (single node too big), force at least one node per card
                    if (!cardContent.hasChildNodes() && idx < nodes.length) {
                        let node = nodes[idx].cloneNode(true);
                        if (node.nodeType === 1 && node.tagName === 'IMG') {
                            node.style.maxWidth = '100%';
                            node.style.height = 'auto';
                            node.style.display = 'block';
                            node.style.objectFit = 'contain';
                            node.style.margin = '1em auto';
                            node.style.boxSizing = 'border-box';
                            node.style.maxHeight = (cardHeight - 64 - 40) + 'px';
                        }
                        cardContent.appendChild(node);
                        idx++;
                    }

                    finalizeCardDOM(cardContent, currentPageNum++, showPageNumbers, previewZoom, cardWidth, cardHeight, cardFontFamily, cardFontSize);

                    offscreenContainer.removeChild(cardContent);
                }

                document.body.removeChild(offscreenContainer);
                util.showMessage("卡片预览已生成！");
            };

            const finalizeCardDOM = (contentDiv, pageNum, showPageNumbers, zoom, cardWidth, cardHeight, fontFamily, fontSize) => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('exported-card');
                cardElement.style.width = cardWidth + 'px';
                cardElement.style.height = cardHeight + 'px';
                cardElement.style.fontFamily = fontFamily;
                cardElement.style.fontSize = fontSize;
                cardElement.style.transform = `scale(${zoom})`;
                cardElement.style.transformOrigin = 'top left';
                cardElement.style.marginRight = `${cardWidth * (1 - zoom) * 0.5}px`;
                cardElement.style.marginBottom = `${cardHeight * (1 - zoom) * 0.5}px`;
                cardElement.style.overflow = 'hidden';
                cardElement.style.boxSizing = 'border-box';
                cardElement.style.background = getComputedStyle(document.body).getPropertyValue('--current-bg-color');

                // Ensure images in card do not overflow
                contentDiv.querySelectorAll('img').forEach(img => {
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                    img.style.display = 'block';
                    img.style.objectFit = 'contain';
                    img.style.margin = '1em auto';
                    img.style.boxSizing = 'border-box';
                    img.style.maxHeight = (cardHeight - 64 - 40) + 'px';
                });

                while (contentDiv.firstChild) {
                    cardElement.appendChild(contentDiv.firstChild);
                }

                if (showPageNumbers) {
                    const pageNumDiv = document.createElement('div');
                    pageNumDiv.classList.add('page-number');
                    pageNumDiv.textContent = pageNum;
                    cardElement.appendChild(pageNumDiv);
                }
                dom.cardPreviewArea.appendChild(cardElement);
                generatedCards.push(cardElement);
            };


            const setupListeners = () => {
                dom.toggleThemeButton.addEventListener('click', () => actions.applyTheme(state.currentTheme === 'light' ? 'dark' : 'light'));
                dom.menuToggleButton.addEventListener('click', () => {
                    dom.appDropdownMenu.classList.toggle('active');
                    if (dom.appDropdownMenu.classList.contains('active')) {
                        updateMenuSeparators();
                    }
                });
                document.addEventListener('click', (e) => { if (dom.appDropdownMenu.classList.contains('active') && !dom.menuToggleButton.contains(e.target) && !dom.appDropdownMenu.contains(e.target)) dom.appDropdownMenu.classList.remove('active'); });

                dom.switchToEditorModeBtn.addEventListener('click', () => actions.applyAppMode('editor'));
                dom.switchToBlogModeBtn.addEventListener('click', () => actions.applyAppMode('blog'));
                dom.setBlogUrlBtn.addEventListener('click', () => dom.blogUrlModal.classList.add('active'));

                dom.toggleBlogControlsBtn.addEventListener('click', () => {
                    state.isBlogControlsCollapsed = !state.isBlogControlsCollapsed;
                    dom.blogControlsSection.classList.toggle('collapsed', state.isBlogControlsCollapsed);
                    dom.toggleBlogControlsBtn.textContent = state.isBlogControlsCollapsed ? '展开' : '折叠';
                    setTimeout(() => cmEditor.refresh(), 350);
                });
                dom.openBlogUrlBtn.addEventListener('click', () => {
                    if (state.blogTargetUrl && util.validateUrl(state.blogTargetUrl)) { window.open(state.blogTargetUrl, '_blank'); }
                    else { util.showMessage("请先设置有效的 Blog 网址"); dom.blogUrlModal.classList.add('active'); }
                });
                dom.saveBlogUrlButton.addEventListener('click', () => {
                    const url = dom.blogTargetUrlInput.value.trim();
                    if (util.validateUrl(url)) {
                        state.blogTargetUrl = url; localStorage.setItem('blogTargetUrl', url);
                        dom.blogUrlModal.classList.remove('active'); util.showMessage("Blog 网址已保存！");
                    } else { dom.urlError.style.display = 'block'; }
                });
                dom.cancelBlogUrlBtn.addEventListener('click', () => dom.blogUrlModal.classList.remove('active'));

                dom.copyBlogMarkdownBtn.addEventListener('click', () => {
                    if (state.currentMode !== 'blog' || !cmEditor) return;
                    const fm = {
                        title: dom.blogTitleInput.value.trim(),
                        date: dom.blogPubDateInput.value,
                        categories: dom.blogCategoriesInput.value.trim().split(/[,，]/).map(c => c.trim()).filter(Boolean),
                        description: dom.blogDescriptionInput.value.trim()
                    };
                    let fmStr = `---\ntitle: ${fm.title}\ndate: ${fm.date} ${new Date().toLocaleTimeString('zh-CN', { hour12: false })}\n`;
                    if (fm.categories.length > 0) {
                        fmStr += `categories:\n${fm.categories.map(c => `  - ${c}`).join('\n')}\n`;
                    }
                    if (fm.description) {
                        fmStr += `description: '${fm.description.replace(/'/g, "''")}'\n`;
                    }
                    fmStr += `---\n\n`;
                    navigator.clipboard.writeText(fmStr + cmEditor.getValue()).then(() => util.showMessage("已复制全文！")).catch(err => util.reportError(err.message));
                });

                dom.toggleTypewriterModeBtn.addEventListener('click', () => {
                    state.isTypewriterMode = !state.isTypewriterMode;
                    dom.toggleTypewriterModeBtn.classList.toggle('active', state.isTypewriterMode);
                    if (state.isTypewriterMode) { cmEditor.on('cursorActivity', handleTypewriterFocus); handleTypewriterFocus(); util.showMessage("打字机模式已开启"); }
                    else { cmEditor.off('cursorActivity', handleTypewriterFocus); for (let i = 0; i < cmEditor.lineCount(); i++) { cmEditor.removeLineClass(i, "wrap", "cm-typewriter-dimmed"); cmEditor.removeLineClass(i, "wrap", "cm-typewriter-active-line"); } util.showMessage("打字机模式已关闭"); }
                });
                const toolActions = {
                    h1: () => cmUtil.togglePrefix('# '), h2: () => cmUtil.togglePrefix('## '), h3: () => cmUtil.togglePrefix('### '),
                    bold: () => cmUtil.insert('**', '**', '粗体'), italic: () => cmUtil.insert('*', '*', '斜体'), strikethrough: () => cmUtil.insert('~~', '~~', '删除线'),
                    highlight: () => cmUtil.insert('==', '==', '高亮文本'),
                    inlineCode: () => cmUtil.insert('`', '`', 'code'), blockquote: () => cmUtil.togglePrefix('> '), ul: () => cmUtil.togglePrefix('- '), ol: () => cmUtil.togglePrefix('1. '), checkbox: () => cmUtil.togglePrefix('- [ ] '), completedCheckbox: () => cmUtil.togglePrefix('- [x] '), link: () => dom.linkModal.classList.add('active'), image: () => dom.imageModal.classList.add('active'),
                    table: () => cmUtil.insert('\n| 左对齐 | 居中对齐 | 右对齐 |\n|:---|:---:|---:|\n| 内容1 | 内容2 | 内容3 |\n', '', '', false),
                    codeblock: () => cmUtil.insert('```\n', '\n```', '在此输入代码'), hr: () => { const cur = cmEditor.getCursor(); cmEditor.replaceSelection((cmEditor.getLine(cur.line).trim() !== "" ? "\n\n---\n\n" : "---\n")); },
                    forceBreak: () => cmUtil.insert('', '<br/>\n', '', false),
                    jpQuotes: () => cmUtil.insert('「', '」', '引文'), jpSingleQuotes: () => cmUtil.insert('『', '』', '引文'), bookTitle: () => cmUtil.insert('《', '》', '书名'), parentheses: () => cmUtil.insert('（', '）', '内容'),
                    undo: () => cmEditor.undo(), redo: () => cmEditor.redo(), deleteLine: () => cmEditor.execCommand('deleteLine'),
                    copy: () => document.execCommand('copy'), paste: () => navigator.clipboard.readText().then(text => cmEditor.replaceSelection(text)),
                    goToLine: () => {
                        if (!cmEditor) return;
                        const maxLines = cmEditor.lineCount();
                        const lineNumStr = prompt(`请输入要跳转的行号 (1-${maxLines}):`);
                        if (lineNumStr) {
                            const lineNum = parseInt(lineNumStr, 10);
                            if (!isNaN(lineNum) && lineNum >= 1 && lineNum <= maxLines) {
                                cmEditor.setCursor(lineNum - 1, 0);
                                cmEditor.focus();
                                const t = cmEditor.charCoords({ line: lineNum - 1, ch: 0 }, "local").top;
                                const middleHeight = cmEditor.getScrollerElement().clientHeight / 2;
                                cmEditor.scrollTo(null, t - middleHeight);

                            } else {
                                util.showMessage("无效的行号");
                            }
                        }
                    },
                    insertTimestamp: () => {
                        if (!cmEditor) return;
                        const timestamp = new Date().toLocaleString('sv'); // YYYY-MM-DD HH:MM:SS format
                        cmEditor.replaceRange(`${timestamp}\n\n`, { line: 0, ch: 0 });
                        cmEditor.focus();
                    },
                    insertStats: () => {
                        if (!cmEditor) return;
                        const text = cmEditor.getValue();
                        const words = text.trim() ? text.trim().split(/\s+/).length : 0;
                        const readingTime = Math.ceil(words / 200); // Assume 200 WPM

                        const statsMarkdown = `> ---\n> **文档统计信息**\n> - **字数:** ${words}\n> - **字符数:** ${text.length}\n> - **预计阅读时间:** ${readingTime} 分钟\n> ---\n\n`;

                        cmEditor.replaceRange(statsMarkdown, { line: 0, ch: 0 });
                        cmEditor.focus();
                    },
                    convertQuotes: () => { let text = cmEditor.getValue(); let doubleQuoteCount = 0, singleQuoteCount = 0; text = text.replace(/[“”"‘’']/g, m => { if ('"' === m || '“' === m || '”' === m) return doubleQuoteCount++ % 2 == 0 ? '「' : '」'; if ("'" === m || "‘" === m || "’" === m) return singleQuoteCount++ % 2 == 0 ? '『' : '』'; return m }); cmEditor.setValue(text); util.showMessage('引号已转换'); },
                    s2t: async () => { if (!await loadOpenCC()) return; cmEditor.setValue(openccS2TConverter(cmEditor.getValue())); util.showMessage("简繁转换完成"); },
                    t2s: async () => { if (!await loadOpenCC()) return; cmEditor.setValue(openccT2SConverter(cmEditor.getValue())); util.showMessage("繁简转换完成"); },
                    exportMD: () => { const defaultName = `markdown-${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.md`; const fileName = prompt("请输入要导出的文件名：", defaultName); if (fileName) { const blob = new Blob([cmEditor.getValue()], { type: "text/markdown;charset=utf-8" }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = fileName; link.click(); URL.revokeObjectURL(link.href); util.showMessage("Markdown 文件已导出！"); } },

                    generateImage: async () => {
                        if (util.isMobile() && state.currentMobileView !== 'preview') actions.applyMobileView('preview');
                        await new Promise(r => setTimeout(r, 300));
                        util.showMessage("生成图片中……");
                    
                        // 外包一层带边距的容器
                        const margin = 40; // px
                        const previewWidth = dom.markdownPreview.scrollWidth;
                        const previewHeight = dom.markdownPreview.scrollHeight;
                    
                        const wrapper = document.createElement('div');
                        wrapper.style.position = 'fixed';
                        wrapper.style.left = '-9999px';
                        wrapper.style.top = '0';
                        wrapper.style.background = getComputedStyle(document.documentElement).getPropertyValue('--current-secondary-bg');
                        wrapper.style.padding = margin + 'px';
                        wrapper.style.boxSizing = 'content-box';
                        wrapper.style.width = previewWidth + 'px';
                        wrapper.style.height = previewHeight + 'px';
                    
                        const offscreen = document.createElement('div');
                        offscreen.style.width = '100%';
                        offscreen.style.height = '100%';
                        offscreen.style.background = getComputedStyle(document.documentElement).getPropertyValue('--current-secondary-bg');
                        offscreen.style.color = getComputedStyle(document.documentElement).getPropertyValue('--current-text-color');
                        offscreen.style.fontFamily = getComputedStyle(dom.markdownPreview).fontFamily;
                        offscreen.style.fontSize = getComputedStyle(dom.markdownPreview).fontSize;
                        offscreen.innerHTML = dom.markdownPreview.innerHTML;
                    
                        wrapper.appendChild(offscreen);
                        document.body.appendChild(wrapper);
                    
                        if (document.fonts && document.fonts.ready) await document.fonts.ready;
                    
                        try {
                            const canvas = await html2canvas(wrapper, {
                                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--current-secondary-bg'),
                                scale: window.devicePixelRatio || 2,
                                useCORS: true,
                                removeContainer: true
                            });
                            const link = document.createElement("a");
                            link.href = canvas.toDataURL("image/png");
                            link.download = `md-export-${Date.now()}.png`;
                            link.click();
                            util.showMessage("图片已生成！");
                        } catch (e) {
                            util.reportError(`图片生成失败：${e.message}`);
                        } finally {
                            document.body.removeChild(wrapper);
                        }
                    },
                    generatePdf: async () => {
                        if (util.isMobile() && state.currentMobileView !== 'preview') actions.applyMobileView('preview');
                        await new Promise(r => setTimeout(r, 300));
                        util.showMessage("生成PDF中……");
                    
                        const margin = 40; // px
                        const previewWidth = dom.markdownPreview.scrollWidth;
                        const previewHeight = dom.markdownPreview.scrollHeight;
                    
                        const wrapper = document.createElement('div');
                        wrapper.style.position = 'fixed';
                        wrapper.style.left = '-9999px';
                        wrapper.style.top = '0';
                        wrapper.style.background = getComputedStyle(document.documentElement).getPropertyValue('--current-secondary-bg');
                        wrapper.style.padding = margin + 'px';
                        wrapper.style.boxSizing = 'content-box';
                        wrapper.style.width = previewWidth + 'px';
                        wrapper.style.height = previewHeight + 'px';
                    
                        const offscreen = document.createElement('div');
                        offscreen.style.width = '100%';
                        offscreen.style.height = '100%';
                        offscreen.style.background = getComputedStyle(document.documentElement).getPropertyValue('--current-secondary-bg');
                        offscreen.style.color = getComputedStyle(document.documentElement).getPropertyValue('--current-text-color');
                        offscreen.style.fontFamily = getComputedStyle(dom.markdownPreview).fontFamily;
                        offscreen.style.fontSize = getComputedStyle(dom.markdownPreview).fontSize;
                        offscreen.innerHTML = dom.markdownPreview.innerHTML;
                    
                        wrapper.appendChild(offscreen);
                        document.body.appendChild(wrapper);
                    
                        if (document.fonts && document.fonts.ready) await document.fonts.ready;
                    
                        try {
                            const { jsPDF } = window.jspdf;
                            const pdf = new jsPDF('p', 'pt', 'a4');
                            const canvas = await html2canvas(wrapper, {
                                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--current-secondary-bg'),
                                scale: 2,
                                useCORS: true,
                                removeContainer: true
                            });
                            const imgData = canvas.toDataURL('image/png');
                            const imgProps = pdf.getImageProperties(imgData);
                            const pdfWidth = pdf.internal.pageSize.getWidth();
                            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                            let heightLeft = pdfHeight;
                            let position = 0;
                    
                            pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                            heightLeft -= pdf.internal.pageSize.getHeight();
                    
                            while (heightLeft > 0) {
                                position = heightLeft - pdfHeight;
                                pdf.addPage();
                                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                                heightLeft -= pdf.internal.pageSize.getHeight();
                            }
                            pdf.save(`md-export-${Date.now()}.pdf`);
                            util.showMessage("PDF已生成！");
                        } catch (e) {
                            util.reportError(`PDF生成失败：${e.message}`);
                        } finally {
                            document.body.removeChild(wrapper);
                        }
                    },
                    // ...existing code...
                    removeMarkdown: () => actions.removeMarkdownMarkup(),
                    addBlankLines: () => actions.addBlankLines(),
                    removeExcessBlankLines: () => actions.removeExcessBlankLines(),
                                     // ...existing code...
                    exportToSvg: () => {
                        const previewNode = dom.markdownPreview;
                        // 1. 复制内容到临时容器
                        const previewCloneContainer = document.createElement('div');
                        previewCloneContainer.className = 'preview-content';
                        previewCloneContainer.style.fontFamily = state.appearance.fontFamily;
                        previewCloneContainer.style.fontSize = state.appearance.fontSize;
                        previewCloneContainer.style.color = getComputedStyle(document.body).getPropertyValue('--current-text-color');
                        previewCloneContainer.style.backgroundColor = getComputedStyle(document.body).getPropertyValue('--current-bg-color');
                        previewCloneContainer.style.padding = '30px 40px';
                        previewCloneContainer.style.width = previewNode.scrollWidth + 'px';
                        previewCloneContainer.style.boxSizing = 'border-box';

                        // 复制内容
                        previewCloneContainer.innerHTML = previewNode.innerHTML;

                        // 2. 收集本地 CSS（不包含远程）
                        let cssText = "";
                        let rootVarsCss = ":root {\n";
                        const rootStyles = getComputedStyle(document.documentElement);
                        const relevantVars = [
                            '--font-family-base', '--font-size-base', '--font-serif', '--font-sans', '--font-mono',
                            '--current-bg-color', '--current-text-color', '--current-title-color', '--current-meta-color',
                            '--current-accent-color', '--current-border-color', '--current-secondary-bg', '--current-hover-bg',
                            '--current-button-bg', '--current-button-text', '--current-input-bg', '--current-shadow',
                            '--current-selection-bg'
                        ];
                        relevantVars.forEach(varName => {
                            rootVarsCss += `  ${varName}: ${rootStyles.getPropertyValue(varName)};\n`;
                        });
                        rootVarsCss += "}\n";
                        cssText += rootVarsCss;

                        // 只收集本地 <style> 标签的 CSS
                        for (const styleSheet of document.styleSheets) {
                            if (!styleSheet.href) {
                                try {
                                    for (const rule of styleSheet.cssRules) {
                                        cssText += rule.cssText + "\n";
                                    }
                                } catch (e) { /* ignore */ }
                            }
                        }

                        // 3. 计算 SVG 尺寸（加上边距）
                        const paddingX = 40, paddingY = 30;
                        const svgWidth = previewNode.scrollWidth + paddingX * 2;
                        const svgHeight = previewNode.scrollHeight + paddingY * 2;

                        // 4. 生成 SVG foreignObject 内容
                        // 由于字体可能为本地字体，SVG 预览时需用户本地有该字体，无法100%保证跨平台一致
                        // 但已不依赖远程字体和远程CSS
                        const serializer = new XMLSerializer();
                        // 需要包裹一层div，设置padding模拟边距
                        const outerDiv = document.createElement('div');
                        outerDiv.style.width = '100%';
                        outerDiv.style.height = '100%';
                        outerDiv.style.boxSizing = 'border-box';
                        outerDiv.style.background = getComputedStyle(document.body).getPropertyValue('--current-bg-color');
                        outerDiv.style.padding = `${paddingY}px ${paddingX}px`;
                        outerDiv.appendChild(previewCloneContainer);

                        const foreignObjectContentHTML = serializer.serializeToString(outerDiv);

                        const svgContent = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="${svgWidth}" height="${svgHeight}">
                        <foreignObject width="100%" height="100%">
                            <div xmlns="http://www.w3.org/1999/xhtml" style="width:100%;height:100%;box-sizing:border-box;">
                                <style type="text/css">
                                    ${cssText}
                                    html, body { margin: 0; padding: 0; }
                                    .preview-content { width: 100% !important; height: 100% !important; box-sizing: border-box; }
                                </style>
                                ${foreignObjectContentHTML}
                            </div>
                        </foreignObject>
                    </svg>`;

                        util.downloadFile(`markdown-export-${Date.now()}.svg`, svgContent, 'image/svg+xml');
                        util.showMessage("SVG 已导出！");
                    }

                };

                document.body.addEventListener('click', (e) => {
                    const btn = e.target.closest('button[data-action]');
                    if (e.target.closest('#exportSvgBtn') === dom.exportSvgBtn) {
                        toolActions.exportToSvg();
                        if (dom.appDropdownMenu.classList.contains('active')) {
                            dom.appDropdownMenu.classList.remove('active');
                        }
                        return;
                    }

                    if (!btn || !cmEditor) return;
                    if (btn.disabled) return;

                    const action = btn.dataset.action;

                    if (action === 'insertCustom') {
                        cmUtil.insert(btn.dataset.prefix || '', btn.dataset.suffix || '', '在此输入', true);
                        return;
                    }
                    if (toolActions[action]) {
                        toolActions[action]();
                        if (dom.appDropdownMenu.classList.contains('active') && btn.closest('.dropdown-menu')) {
                            dom.appDropdownMenu.classList.remove('active');
                        }
                    }
                });


                dom.insertLinkButton.addEventListener('click', () => { const u = dom.linkUrlInput.value.trim(), t = dom.linkTextInput.value.trim() || u; if (u && util.validateUrl(u)) { cmUtil.insert(`[${t}](${u})`, '', '', false); dom.linkModal.classList.remove('active'); dom.linkUrlInput.value = ''; dom.linkTextInput.value = ''; } else { util.showMessage("URL无效！"); } });
                dom.insertImageButton.addEventListener('click', () => { const u = dom.imageUrlInput.value.trim(), a = dom.imageAltInput.value.trim() || 'image'; if (u) { cmUtil.insert(`![${a}](${u})`, '', '', false); dom.imageModal.classList.remove('active'); dom.imageUrlInput.value = ''; dom.imageAltInput.value = ''; } else { util.showMessage("URL无效！"); } });
                dom.cancelLinkButton.addEventListener('click', () => dom.linkModal.classList.remove('active'));
                dom.linkModal.addEventListener('click', e => { if (e.target === dom.linkModal) dom.linkModal.classList.remove('active') });
                dom.cancelImageButton.addEventListener('click', () => dom.imageModal.classList.remove('active'));
                dom.imageModal.addEventListener('click', e => { if (e.target === dom.imageModal) dom.imageModal.classList.remove('active') });

                let touchStartX = 0, touchStartY = 0;
                const touchArea = util.isMobile() ? dom.appMain : null;

                if (touchArea) {
                    touchArea.addEventListener('touchstart', e => {
                        let target = e.target;
                        let canSwipe = false;
                        while (target && target !== document.body) {
                            if (target === dom.editorWrapper || target === dom.markdownPreview) {
                                canSwipe = true;
                                break;
                            }
                            if (target === dom.toolbarsContainer || target.closest('#blog-controls-section') || target.closest('.app-header')) {
                                canSwipe = false;
                                break;
                            }
                            target = target.parentElement;
                        }
                        if (!canSwipe) {
                            touchStartX = -1;
                            return;
                        }

                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                    }, { passive: true });

                    touchArea.addEventListener('touchend', e => {
                        if (!util.isMobile() || touchStartX === -1) return;
                        const dX = e.changedTouches[0].clientX - touchStartX;
                        if (Math.abs(dX) > 50 && Math.abs(dX) > Math.abs(e.changedTouches[0].clientY - touchStartY)) {
                            if (dX < 0 && state.currentMobileView === 'editor') actions.applyMobileView('preview');
                            else if (dX > 0 && state.currentMobileView === 'preview') actions.applyMobileView('editor');
                        }
                        touchStartX = 0;
                    });
                }

                window.addEventListener('resize', () => {
                    if (!util.isMobile()) {
                        dom.appMain.classList.remove('view-preview');
                        dom.appHeader.classList.remove('hidden-mobile');
                    }
                    if (cmEditor) cmEditor.refresh();
                    setupSyncScroll();
                    initDragHandle();
                    updateMenuSeparators();
                });
                window.addEventListener('beforeunload', (e) => {
                    if (cmEditor && cmEditor.getValue() !== (localStorage.getItem('markdownContent') || defaultMarkdown)) {
                        e.preventDefault(); e.returnValue = '您有未保存的更改，确定要离开吗？';
                    }
                });

                let lastScrollTop = 0;
                dom.appMain.addEventListener('scroll', () => {
                    if (!util.isMobile()) return;
                    let st = dom.appMain.scrollTop;
                    if (st > lastScrollTop && st > 50) {
                        dom.appHeader.classList.add('hidden-mobile');
                    } else {
                        dom.appHeader.classList.remove('hidden-mobile');
                    }
                    lastScrollTop = st <= 0 ? 0 : st;
                }, false);
                dom.appTitle.addEventListener('click', () => {
                    if (util.isMobile()) {
                        if (state.currentMobileView === 'editor') actions.applyMobileView('preview');
                        else actions.applyMobileView('editor');
                    }
                });
                [dom.toggleMainToolbarVisibilityBtn, dom.toggleActionsToolbarVisibilityBtn, dom.toggleCustomToolbarVisibilityBtn].forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const toolbarId = e.currentTarget.dataset.toolbarId;
                        state.toolbarVisibility[toolbarId] = !state.toolbarVisibility[toolbarId];
                        localStorage.setItem(`toolbarVisibility-${toolbarId}`, state.toolbarVisibility[toolbarId]);
                        applyToolbarVisibility();
                        if (toolbarId === 'custom-symbols-toolbar') symbolManager.renderToolbar();
                    });
                });

                dom.openAboutModalBtn.addEventListener('click', () => dom.aboutModal.classList.add('active'));
                dom.closeAboutModalBtn.addEventListener('click', () => dom.aboutModal.classList.remove('active'));
                dom.aboutModal.addEventListener('click', e => { if (e.target === dom.aboutModal) dom.aboutModal.classList.remove('active'); });

                dom.openSettingsModalBtn.addEventListener('click', () => {
                    loadAppearanceSettings();
                    dom.settingsModal.classList.add('active');
                });
                dom.saveSettingsBtn.addEventListener('click', saveAppearanceSettings);
                dom.cancelSettingsBtn.addEventListener('click', () => dom.settingsModal.classList.remove('active'));
                dom.settingsModal.addEventListener('click', e => { if (e.target === dom.settingsModal) dom.settingsModal.classList.remove('active'); });

                dom.openCardExportModalBtn.addEventListener('click', () => {
                    dom.cardFontFamilySelect.value = state.appearance.fontFamily;
                    dom.cardFontSizeInput.value = parseInt(state.appearance.fontSize);
                    dom.cardExportModal.classList.add('active');
                    generateAndPreviewCards();
                });
                dom.cancelCardExportBtn.addEventListener('click', () => dom.cardExportModal.classList.remove('active'));
                dom.cardExportModal.addEventListener('click', e => { if (e.target === dom.cardExportModal) dom.cardExportModal.classList.remove('active'); });
                dom.regenerateCardsBtn.addEventListener('click', generateAndPreviewCards);
                dom.cardPreviewZoom.addEventListener('change', () => {
                    const zoom = parseFloat(dom.cardPreviewZoom.value);
                    dom.cardPreviewArea.querySelectorAll('.exported-card').forEach(card => {
                        card.style.transform = `scale(${zoom})`;
                        const cardWidth = parseInt(card.style.width);
                        const cardHeight = parseInt(card.style.height);
                        card.style.marginRight = `${cardWidth * (1 - zoom) * 0.5}px`;
                        card.style.marginBottom = `${cardHeight * (1 - zoom) * 0.5}px`;
                    });
                });
                dom.exportCardsAsPngBtn.addEventListener('click', async () => {
                    if (generatedCards.length === 0) {
                        util.showMessage("请先生成卡片预览。");
                        return;
                    }
                    util.showMessage("开始导出 PNG 卡片…");
                    for (let i = 0; i < generatedCards.length; i++) {
                        const card = generatedCards[i];
                        const originalTransform = card.style.transform;
                        card.style.transform = 'scale(1)';

                        try {
                            const canvas = await html2canvas(card, {
                                backgroundColor: getComputedStyle(card).backgroundColor || getComputedStyle(document.documentElement).getPropertyValue('--current-bg-color'),
                                scale: 2,
                                useCORS: true,
                            });
                            const link = document.createElement('a');
                            link.href = canvas.toDataURL('image/png');
                            link.download = `card-export-${Date.now()}-p${i + 1}.png`;
                            link.click();
                            util.showMessage(`卡片 ${i + 1} 已导出 (PNG)`);
                        } catch (err) {
                            util.reportError(`导出卡片 ${i + 1} (PNG) 失败：${err.message}`);
                        } finally {
                            card.style.transform = originalTransform;
                        }
                        await new Promise(r => setTimeout(r, 200));
                    }
                    util.showMessage("所有 PNG 卡片导出完毕！");
                });
                dom.exportCardsAsSvgBtn.addEventListener('click', async () => {
                    if (generatedCards.length === 0) {
                        util.showMessage("请先生成卡片预览。");
                        return;
                    }
                    util.showMessage("开始导出 SVG 卡片…");
                    let externalFontLinks = '';
                    if (state.appearance.fontFamily.includes('Noto Serif SC')) {
                        externalFontLinks += `<link xmlns="http://www.w3.org/1999/xhtml" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&display=swap"/>`;
                    }
                    if (state.appearance.fontFamily.includes('Source Sans Pro')) {
                        externalFontLinks += `<link xmlns="http://www.w3.org/1999/xhtml" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap"/>`;
                    }

                    let localCssText = "";
                    for (const styleSheet of document.styleSheets) {
                        if (!styleSheet.href) {
                            try {
                                for (const rule of styleSheet.cssRules) { localCssText += rule.cssText + "\n"; }
                            } catch (e) { /* ignore */ }
                        }
                    }
                    const rootStyles = getComputedStyle(document.documentElement);
                    let rootVarsCss = ":root {\n";
                    const relevantVars = [
                        '--font-family-base', '--font-size-base', '--font-serif', '--font-sans', '--font-mono',
                        '--current-bg-color', '--current-text-color', '--current-title-color', '--current-meta-color',
                        '--current-accent-color', '--current-border-color', '--current-secondary-bg', '--current-hover-bg',
                        '--current-button-bg', '--current-button-text', '--current-input-bg', '--current-shadow',
                        '--current-selection-bg'
                    ];
                    relevantVars.forEach(varName => {
                        rootVarsCss += `  ${varName}: ${rootStyles.getPropertyValue(varName)};\n`;
                    });
                    rootVarsCss += "}\n body { margin: 0; } \n";
                    localCssText = rootVarsCss + localCssText;


                    for (let i = 0; i < generatedCards.length; i++) {
                        const card = generatedCards[i];
                        const cardCloneForExport = card.cloneNode(true);
                        const pageNumElement = cardCloneForExport.querySelector('.page-number');
                        if (pageNumElement) pageNumElement.remove();
                        const cardContentHTML = cardCloneForExport.innerHTML;

                        const cardComputedStyles = window.getComputedStyle(card);

                        const svgCardContent = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="${parseInt(card.style.width)}" height="${parseInt(card.style.height)}">
                                <foreignObject width="100%" height="100%">
                                    <div xmlns="http://www.w3.org/1999/xhtml" 
                                         style="font-family: ${card.style.fontFamily}; font-size: ${card.style.fontSize}; color: ${cardComputedStyles.color}; background-color: ${cardComputedStyles.backgroundColor}; width: 100%; height: 100%; padding: 20px; box-sizing: border-box; overflow: hidden;">
                                        ${externalFontLinks}
                                        <style type="text/css">${localCssText}</style>
                                        ${cardContentHTML}
                                        ${dom.cardShowPageNumbers.checked ? `<div style="position: absolute; bottom: 5px; right: 10px; font-size: 0.8em; color: var(--current-meta-color);">${i + 1}</div>` : ''}
                                    </div>
                                </foreignObject>
                            </svg>`;
                        util.downloadFile(`card-export-${Date.now()}-p${i + 1}.svg`, svgCardContent, 'image/svg+xml');
                        util.showMessage(`卡片 ${i + 1} 已导出 (SVG)`);
                        await new Promise(r => setTimeout(r, 100));
                    }
                    util.showMessage("所有 SVG 卡片导出完毕！");
                });


            };
            const setupSymbolListeners = () => {
                dom.manageSymbolsBtn.addEventListener('click', () => { symbolManager.renderModal(); dom.symbolsModal.classList.add('active'); });
                dom.addSymbolBtn.addEventListener('click', () => { const l = dom.symbolLabelInput.value.trim(), p = dom.symbolPrefixInput.value, s = dom.symbolSuffixInput.value; if (!l || (!p && !s)) return util.showMessage('按钮文字和至少一个前后缀不能为空！'); state.customSymbols.push({ label: l, prefix: p, suffix: s }); symbolManager.renderModal(); dom.symbolLabelInput.value = dom.symbolPrefixInput.value = dom.symbolSuffixInput.value = ''; dom.symbolLabelInput.focus(); });
                dom.currentSymbolsList.addEventListener('click', e => { if (e.target.classList.contains('delete-symbol-btn')) { state.customSymbols.splice(parseInt(e.target.dataset.index, 10), 1); symbolManager.renderModal(); } });
                dom.saveSymbolsBtn.addEventListener('click', () => { if (symbolManager.save()) { symbolManager.renderToolbar(); dom.symbolsModal.classList.remove('active'); util.showMessage('快捷符号已保存！'); } });
                dom.cancelSymbolsBtn.addEventListener('click', () => { symbolManager.load(); dom.symbolsModal.classList.remove('active'); });
                dom.exportSymbolsBtn.addEventListener('click', () => { const d = JSON.stringify(state.customSymbols, null, 2), b = new Blob([d], { type: 'application/json' }), u = URL.createObjectURL(b), a = document.createElement('a'); a.href = u; a.download = 'md-symbols.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(u); util.showMessage('配置已导出！'); });
                dom.importSymbolsInput.addEventListener('change', e => { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = ev => { try { const i = JSON.parse(ev.target.result); if (!Array.isArray(i) || !i.every(s => 'label' in s && 'prefix' in s && 'suffix' in s)) throw new Error('Invalid format'); state.customSymbols = i; symbolManager.renderModal(); util.showMessage('配置已加载，请保存！'); } catch (err) { util.reportError('导入失败：文件格式无效') } }; r.readAsText(f); e.target.value = ''; });
            };

            const initDragHandle = () => {
                if (!cmEditor || util.isMobile()) {
                    dom.editorDragHandle.style.display = 'none';
                    return;
                }
                dom.editorDragHandle.style.display = 'flex';

                const updateHandlePosition = () => {
                    if (state.isHandleDragging) return;
                    const scrollInfo = cmEditor.getScrollInfo();
                    if (scrollInfo.height <= scrollInfo.clientHeight) {
                        dom.editorDragHandle.style.display = 'none';
                        return;
                    }
                    dom.editorDragHandle.style.display = 'flex';
                    const scrollableHeight = dom.editorWrapper.clientHeight - dom.editorDragHandle.clientHeight;
                    const scrollPercent = scrollInfo.top / (scrollInfo.height - scrollInfo.clientHeight);
                    dom.editorDragHandle.style.top = `${scrollPercent * scrollableHeight}px`;
                };

                const handleDrag = (e) => {
                    if (!state.isHandleDragging) return;
                    e.preventDefault();
                    e.stopPropagation();

                    const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
                    const wrapperRect = dom.editorWrapper.getBoundingClientRect();
                    const handleHeight = dom.editorDragHandle.clientHeight;

                    let newTop = clientY - wrapperRect.top - state.dragStartY;
                    newTop = Math.max(0, Math.min(newTop, wrapperRect.height - handleHeight));
                    dom.editorDragHandle.style.top = `${newTop}px`;

                    const scrollableHeight = wrapperRect.height - handleHeight;
                    const scrollPercent = newTop / scrollableHeight;
                    const scrollInfo = cmEditor.getScrollInfo();
                    cmEditor.scrollTo(null, scrollPercent * (scrollInfo.height - scrollInfo.clientHeight));
                };

                const stopDrag = () => {
                    state.isHandleDragging = false;
                    document.body.style.cursor = 'default';
                    dom.editorDragHandle.classList.remove('dragging');
                    window.removeEventListener('mousemove', handleDrag);
                    window.removeEventListener('mouseup', stopDrag);
                    window.removeEventListener('touchmove', handleDrag);
                    window.removeEventListener('touchend', stopDrag);
                };

                dom.editorDragHandle.onmousedown = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    state.isHandleDragging = true;
                    state.dragStartY = e.offsetY;
                    document.body.style.cursor = 'ns-resize';
                    dom.editorDragHandle.classList.add('dragging');
                    window.addEventListener('mousemove', handleDrag);
                    window.addEventListener('mouseup', stopDrag);
                };
                dom.editorDragHandle.ontouchstart = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    state.isHandleDragging = true;
                    const touch = e.touches[0];
                    const handleRect = dom.editorDragHandle.getBoundingClientRect();
                    state.dragStartY = touch.clientY - handleRect.top;
                    dom.editorDragHandle.classList.add('dragging');
                    window.addEventListener('touchmove', handleDrag, { passive: false });
                    window.addEventListener('touchend', stopDrag);
                };

                cmEditor.off("scroll", updateHandlePosition);
                cmEditor.on("scroll", updateHandlePosition);
                cmEditor.on("refresh", updateHandlePosition);
                updateHandlePosition();
            };

            const setupSyncScroll = () => {
                if (util.isMobile()) { dom.toggleSyncScrollBtn.style.display = 'none'; return; }
                dom.toggleSyncScrollBtn.style.display = 'flex';
                dom.toggleSyncScrollBtn.classList.toggle('active-toggle', state.isSyncingScroll);

                const syncEditorToPreview = () => { if (!state.isSyncingScroll || state.isHandleDragging) return; const scrollInfo = cmEditor.getScrollInfo(); const p = scrollInfo.top / (scrollInfo.height - scrollInfo.clientHeight); if (!isNaN(p)) dom.markdownPreview.scrollTop = p * (dom.markdownPreview.scrollHeight - dom.markdownPreview.clientHeight); };
                const syncPreviewToEditor = () => { if (!state.isSyncingScroll || state.isHandleDragging) return; const p = dom.markdownPreview.scrollTop / (dom.markdownPreview.scrollHeight - dom.markdownPreview.clientHeight); const scrollInfo = cmEditor.getScrollInfo(); if (!isNaN(p)) cmEditor.scrollTo(null, p * (scrollInfo.height - scrollInfo.clientHeight)); };

                cmEditor.off('scroll', syncEditorToPreview);
                dom.markdownPreview.removeEventListener('scroll', syncPreviewToEditor);

                if (state.isSyncingScroll) {
                    cmEditor.on('scroll', syncEditorToPreview);
                    dom.markdownPreview.addEventListener('scroll', syncPreviewToEditor);
                }
                updateMenuSeparators();
            };
            dom.toggleSyncScrollBtn.addEventListener('click', () => {
                state.isSyncingScroll = !state.isSyncingScroll;
                localStorage.setItem('syncScroll', state.isSyncingScroll);
                setupSyncScroll();
            });
            const loadOpenCC = async () => {
                if (state.openCCLoaded) return true;
                if (typeof OpenCC === 'undefined') {
                    util.showMessage("加载简繁转换库中……");
                    try {
                        const script = document.createElement("script");
                        script.src = "https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.min.js";
                        await new Promise((resolve, reject) => { script.onload = resolve; script.onerror = reject; document.body.appendChild(script); });
                        openccS2TConverter = OpenCC.Converter({ from: "cn", to: "twp" });
                        openccT2SConverter = OpenCC.Converter({ from: "twp", to: "cn" });
                        state.openCCLoaded = true;
                    } catch (e) { util.reportError("加载OpenCC库失败"); return false; }
                } else {
                    openccS2TConverter = OpenCC.Converter({ from: "cn", to: "twp" });
                    openccT2SConverter = OpenCC.Converter({ from: "twp", to: "cn" });
                    state.openCCLoaded = true;
                }
                return true;
            };

            try {
                loadAppearanceSettings();

                const customHighlightExtension = {
                    name: 'customHighlight',
                    level: 'inline',
                    start(src) {
                        const eIndex = src.indexOf('==');
                        const cIndex = src.indexOf('^');
                        if (eIndex < 0) return cIndex;
                        if (cIndex < 0) return eIndex;
                        return Math.min(eIndex, cIndex);
                    },
                    tokenizer(src, tokens) {
                        const rule = /^(?:==(.*?)==|\^(.*?)\^)/;
                        const match = rule.exec(src);
                        if (match) {
                            return { type: 'customHighlight', raw: match[0], text: this.lexer.inlineTokens(match[1] || match[2]) };
                        }
                    },
                    renderer(token) {
                        return `<mark>${this.parser.parseInline(token.text)}</mark>`;
                    }
                };
                marked.use({ extensions: [customHighlightExtension] });
                marked.setOptions({
                    highlight: (code, lang) => {
                        try {
                            return hljs.highlight(code, { language: hljs.getLanguage(lang) ? lang : 'plaintext', ignoreIllegals: true }).value;
                        } catch (e) { return hljs.highlight(code, { language: 'plaintext', ignoreIllegals: true }).value; }
                    }, gfm: true, breaks: true, pedantic: false
                });

                mermaid.initialize({ startOnLoad: false, theme: state.currentTheme === 'dark' ? 'dark' : 'default', securityLevel: 'loose' });
                actions.applyTheme(state.currentTheme);
                applyToolbarVisibility();

                const editorExtraKeys = {
                    "Enter": "newlineAndIndentContinueMarkdownList",
                    "Cmd-B": () => cmUtil.insert('**', '**', '粗体'), "Ctrl-B": () => cmUtil.insert('**', '**', '粗体'),
                    "Cmd-I": () => cmUtil.insert('*', '*', '斜体'), "Ctrl-I": () => cmUtil.insert('*', '*', '斜体'),
                    "Cmd-U": () => cmUtil.insert('~~', '~~', '删除线'), "Ctrl-U": () => cmUtil.insert('~~', '~~', '删除线'),
                    "Cmd-Alt-U": () => cmUtil.insert('==', '==', '高亮文本'), "Ctrl-Alt-U": () => cmUtil.insert('==', '==', '高亮文本'),
                    "Cmd-K": () => dom.linkModal.classList.add('active'), "Ctrl-K": () => dom.linkModal.classList.add('active'),
                    "Ctrl-L": () => dom.linkModal.classList.add('active'),
                    "Ctrl-G": () => dom.imageModal.classList.add('active'),
                    "Cmd-Alt-C": () => cmUtil.insert('```\n', '\n```', '在此输入代码'), "Ctrl-Alt-C": () => cmUtil.insert('```\n', '\n```', '在此输入代码'),
                    "Cmd-Alt-V": () => cmUtil.insert('`', '`', 'code'), "Ctrl-Alt-V": () => cmUtil.insert('`', '`', 'code'),
                    "Cmd-Alt-T": () => cmUtil.insert('\n| 左对齐 | 居中对齐 | 右对齐 |\n|:---|:---:|---:|\n| 内容1 | 内容2 | 内容3 |\n', '', '', false),
                    "Ctrl-Alt-T": () => cmUtil.insert('\n| 左对齐 | 居中对齐 | 右对齐 |\n|:---|:---:|---:|\n| 内容1 | 内容2 | 内容3 |\n', '', '', false),
                    "Ctrl-Q": () => cmUtil.togglePrefix('> ')
                };

                cmEditor = CodeMirror.fromTextArea(document.getElementById('markdown-input-fallback'), {
                    mode: "markdown",
                    theme: state.currentTheme === 'dark' ? "material-darker" : "neo",
                    lineNumbers: true,
                    lineWrapping: true,
                    styleActiveLine: state.appearance.enableEditorHighlight ? { nonEmpty: true } : false,
                    extraKeys: editorExtraKeys,
                    autofocus: true,
                    scrollbarStyle: "simple",
                });
                document.body.classList.toggle('editor-highlight-disabled', !state.appearance.enableEditorHighlight);

                cmEditor.getWrapperElement().style.fontFamily = state.appearance.fontFamily;
                cmEditor.getWrapperElement().style.fontSize = state.appearance.fontSize;

                let lastCmScrollTop = 0;
                let scrollFadeTimeout = null;
                const mobileScrollHandler = () => {
                    if (util.isMobile() && state.appearance.autoHideMobileToolbar) {
                        const scrollInfo = cmEditor.getScrollInfo();
                        const st = scrollInfo.top;
                        if (Math.abs(st - lastCmScrollTop) > 10) {
                            if (st > lastCmScrollTop && st > dom.toolbarsContainer.clientHeight) {
                                dom.toolbarsContainer.classList.add('hidden-on-scroll');
                            } else {
                                dom.toolbarsContainer.classList.remove('hidden-on-scroll');
                            }
                        }
                        lastCmScrollTop = st <= 0 ? 0 : st;
                    }
                };

                cmEditor.on("scroll", mobileScrollHandler);

                cmEditor.on("change", (cm, change) => {
                    if (change.origin !== 'setValue') {
                        actions.updatePreview();
                        actions.updateStats();
                        localStorage.setItem('markdownContent', cmEditor.getValue());
                    }
                });
                cmEditor.on("cursorActivity", actions.updateStats);

                cmEditor.setValue(localStorage.getItem('markdownContent') || defaultMarkdown);
                cmEditor.refresh();

                actions.applyAppMode(state.currentMode);
                if (util.isMobile()) actions.applyMobileView('editor');

                if (dom.blogPubDateInput) dom.blogPubDateInput.value = new Date().toISOString().slice(0, 10);

                actions.updatePreview();
                actions.updateStats();
                setInterval(actions.updateTime, 1000);

                symbolManager.load();
                setupListeners();
                setupSymbolListeners();
                initDragHandle();
                setupSyncScroll();
                updateMenuSeparators();

                document.body.classList.remove('app-loading');
                util.showMessage("编辑器已准备就绪！", 2000);

            } catch (error) { util.reportError(`初始化失败：${error.message}.`); document.body.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">编辑器加载失败，请检查控制台。<br>${error.stack}</div>`; }
        });
    </script>
</body>

</html>